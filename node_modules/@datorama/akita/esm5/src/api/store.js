/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { BehaviorSubject, ReplaySubject } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { AkitaError, AkitaImmutabilityError, assertDecorator } from '../internal/error';
import { commit, isTransactionInProcess } from '../internal/transaction.internal';
import { isFunction, isPlainObject } from '../internal/utils';
import { deepFreeze } from '../internal/deep-freeze';
import { configKey } from './store-config';
import { __globalState } from '../internal/global-state';
import { getAkitaConfig } from './config';
/** @type {?} */
var __DEV__ = true;
/** @type {?} */
var isNotBrowser = typeof window === 'undefined';
/** @type {?} */
export var __stores__ = {};
/** @enum {number} */
var Actions = {
    NEW_STORE: 0,
    DELETE_STORE: 1,
    NEW_STATE: 2,
};
export { Actions };
/** @type {?} */
export var rootDispatcher = new ReplaySubject();
/**
 * @param {?} storeName
 * @param {?=} initialState
 * @return {?}
 */
function nextState(storeName, initialState) {
    if (initialState === void 0) { initialState = false; }
    return {
        type: 2 /* NEW_STATE */,
        payload: {
            name: storeName,
            initialState: initialState
        }
    };
}
/**
 * Enable production mode to disable objectFreeze
 * @return {?}
 */
export function enableAkitaProdMode() {
    __DEV__ = false;
}
/**
 * @return {?}
 */
export function isDev() {
    return __DEV__;
}
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S
 */
var /**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S
 */
Store = /** @class */ (function () {
    /**
     *
     * Initial the store with the state
     */
    function Store(initialState, options) {
        if (options === void 0) { options = {}; }
        this.options = options;
        /**
         * Whether we are inside transaction *
         */
        this.inTransaction = false;
        this._isPristine = true;
        this.destroy = this.ngOnDestroy;
        __globalState.setAction({ type: '@@INIT' });
        __stores__[this.storeName] = this;
        this.setState(function () { return initialState; });
        rootDispatcher.next({
            type: 0 /* NEW_STORE */,
            payload: { store: this }
        });
        isDev() && assertDecorator(this.storeName, this.constructor.name);
        if (this.isRessetable()) {
            this._initialState = initialState;
        }
    }
    /**
     * @param {?=} loading
     * @return {?}
     */
    Store.prototype.setLoading = /**
     * @param {?=} loading
     * @return {?}
     */
    function (loading) {
        if (loading === void 0) { loading = false; }
        if (loading !== ((/** @type {?} */ (this._value()))).loading) {
            isDev() && __globalState.setAction({ type: 'Set Loading' });
            this.setState(function (s) { return ((/** @type {?} */ (tslib_1.__assign({}, ((/** @type {?} */ (s))), { loading: loading })))); });
        }
    };
    /**
     * Update the store's error state.
     */
    /**
     * Update the store's error state.
     * @template T
     * @param {?} error
     * @return {?}
     */
    Store.prototype.setError = /**
     * Update the store's error state.
     * @template T
     * @param {?} error
     * @return {?}
     */
    function (error) {
        if (error !== ((/** @type {?} */ (this._value()))).error) {
            isDev() && __globalState.setAction({ type: 'Set Error' });
            this.setState(function (s) { return ((/** @type {?} */ (tslib_1.__assign({}, ((/** @type {?} */ (s))), { error: error })))); });
        }
    };
    /**
     * Select a slice from the store
     *
     * @example
     * this.store.select(state => state.entities)
     *
     */
    /**
     * Select a slice from the store
     *
     * \@example
     * this.store.select(state => state.entities)
     *
     * @template R
     * @param {?} project
     * @return {?}
     */
    Store.prototype._select = /**
     * Select a slice from the store
     *
     * \@example
     * this.store.select(state => state.entities)
     *
     * @template R
     * @param {?} project
     * @return {?}
     */
    function (project) {
        return this.store$.pipe(map(project), distinctUntilChanged());
    };
    /**
     * @return {?}
     */
    Store.prototype._value = /**
     * @return {?}
     */
    function () {
        return this.storeValue;
    };
    Object.defineProperty(Store.prototype, "config", {
        get: /**
         * @return {?}
         */
        function () {
            return this.constructor[configKey];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "storeName", {
        get: /**
         * @return {?}
         */
        function () {
            return this.options.storeName || (this.config && this.config['storeName']);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "idKey", {
        get: /**
         * @return {?}
         */
        function () {
            /**
             * backward compatibility
             * @type {?}
             */
            var newIdKey = this.config && this.config.idKey;
            if (!newIdKey) {
                return this.options.idKey || 'id';
            }
            return newIdKey;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Store.prototype, "isPristine", {
        get: /**
         * @return {?}
         */
        function () {
            return this._isPristine;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * `setState()` is the only way to update a store; It receives a callback function,
     * which gets the current state, and returns a new immutable state,
     * which will be the new value of the store.
     */
    /**
     * `setState()` is the only way to update a store; It receives a callback function,
     * which gets the current state, and returns a new immutable state,
     * which will be the new value of the store.
     * @param {?} newStateFn
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    Store.prototype.setState = /**
     * `setState()` is the only way to update a store; It receives a callback function,
     * which gets the current state, and returns a new immutable state,
     * which will be the new value of the store.
     * @param {?} newStateFn
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    function (newStateFn, _rootDispatcher) {
        if (_rootDispatcher === void 0) { _rootDispatcher = true; }
        /** @type {?} */
        var prevState = this._value();
        this.storeValue = __DEV__ ? deepFreeze(newStateFn(this._value())) : newStateFn(this._value());
        if (prevState === this.storeValue) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        if (!this.store) {
            this.store = new BehaviorSubject(this.storeValue);
            rootDispatcher.next(nextState(this.storeName, true));
            return;
        }
        if (isTransactionInProcess()) {
            this.handleTransaction();
            return;
        }
        this.dispatch(this.storeValue, _rootDispatcher);
    };
    /**
     * Resets the store to it's initial state and set the store to a pristine state.
     */
    /**
     * Resets the store to it's initial state and set the store to a pristine state.
     * @return {?}
     */
    Store.prototype.reset = /**
     * Resets the store to it's initial state and set the store to a pristine state.
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.isRessetable()) {
            __globalState.setAction({ type: 'Reset Store' });
            this.setState(function () { return Object.assign({}, _this._initialState); });
            this.setPristine();
        }
        else {
            throw new AkitaError("You need to enable the reset functionality");
        }
    };
    /**
     * @param {?} newStateOrId
     * @param {?=} newState
     * @return {?}
     */
    Store.prototype.update = /**
     * @param {?} newStateOrId
     * @param {?=} newState
     * @return {?}
     */
    function (newStateOrId, newState) {
        __globalState.setAction({ type: 'Update Store' });
        this.setState(function (state) {
            /** @type {?} */
            var value = isFunction(newStateOrId) ? newStateOrId(state) : newStateOrId;
            /** @type {?} */
            var merged = Object.assign({}, state, value);
            return isPlainObject(state) ? merged : new ((/** @type {?} */ (state))).constructor(merged);
        });
        this.setDirty();
    };
    /**
     * Sets the store to a pristine state.
     */
    /**
     * Sets the store to a pristine state.
     * @return {?}
     */
    Store.prototype.setPristine = /**
     * Sets the store to a pristine state.
     * @return {?}
     */
    function () {
        this._isPristine = true;
    };
    /**
     * Sets the store to a dirty state, indicating that it is not pristine.
     */
    /**
     * Sets the store to a dirty state, indicating that it is not pristine.
     * @return {?}
     */
    Store.prototype.setDirty = /**
     * Sets the store to a dirty state, indicating that it is not pristine.
     * @return {?}
     */
    function () {
        this._isPristine = false;
    };
    /**
     * @param {?} state
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    Store.prototype.dispatch = /**
     * @param {?} state
     * @param {?=} _rootDispatcher
     * @return {?}
     */
    function (state, _rootDispatcher) {
        if (_rootDispatcher === void 0) { _rootDispatcher = true; }
        this.store.next(state);
        if (_rootDispatcher) {
            rootDispatcher.next(nextState(this.storeName));
            isDev() && __globalState.setAction({ type: 'Set State' });
        }
    };
    Object.defineProperty(Store.prototype, "store$", {
        get: /**
         * @return {?}
         */
        function () {
            return this.store.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * When the transaction ends dispatch the final value once
     */
    /**
     * When the transaction ends dispatch the final value once
     * @return {?}
     */
    Store.prototype.watchTransaction = /**
     * When the transaction ends dispatch the final value once
     * @return {?}
     */
    function () {
        var _this = this;
        commit().subscribe(function () {
            _this.inTransaction = false;
            if (isDev() && !__globalState.skipTransactionMsg) {
                __globalState.setAction({ type: '@Transaction' });
            }
            _this.dispatch(_this._value());
            __globalState.currentT = [];
            __globalState.skipTransactionMsg = false;
        });
    };
    /**
     * @return {?}
     */
    Store.prototype.isRessetable = /**
     * @return {?}
     */
    function () {
        return this.config.resettable || getAkitaConfig().resettable;
    };
    /**
     * Listen to the transaction stream
     */
    /**
     * Listen to the transaction stream
     * @return {?}
     */
    Store.prototype.handleTransaction = /**
     * Listen to the transaction stream
     * @return {?}
     */
    function () {
        if (!this.inTransaction) {
            this.watchTransaction();
            this.inTransaction = true;
        }
    };
    /**
     * @return {?}
     */
    Store.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (isNotBrowser)
            return;
        if (!((/** @type {?} */ (window))).hmrEnabled && this === __stores__[this.storeName]) {
            delete __stores__[this.storeName];
            rootDispatcher.next({
                type: 1 /* DELETE_STORE */,
                payload: { storeName: this.storeName }
            });
        }
    };
    return Store;
}());
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S
 */
export { Store };
if (false) {
    /**
     * Manage the store with BehaviorSubject
     * @type {?}
     */
    Store.prototype.store;
    /**
     * The current state value
     * @type {?}
     */
    Store.prototype.storeValue;
    /**
     * Whether we are inside transaction *
     * @type {?}
     */
    Store.prototype.inTransaction;
    /** @type {?} */
    Store.prototype._isPristine;
    /** @type {?} */
    Store.prototype._initialState;
    /** @type {?} */
    Store.prototype.destroy;
    /** @type {?} */
    Store.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvYXBpL3N0b3JlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLGVBQWUsRUFBYyxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxVQUFVLEVBQUUsc0JBQXNCLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxTQUFTLEVBQXNCLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxVQUFVLENBQUM7O0lBRXRDLE9BQU8sR0FBRyxJQUFJOztJQUNaLFlBQVksR0FBRyxPQUFPLE1BQU0sS0FBSyxXQUFXOztBQUVsRCxNQUFNLEtBQU8sVUFBVSxHQUF3QyxFQUFFOzs7SUFHL0QsWUFBUztJQUNULGVBQVk7SUFDWixZQUFTOzs7O0FBUVgsTUFBTSxLQUFPLGNBQWMsR0FBRyxJQUFJLGFBQWEsRUFBVTs7Ozs7O0FBRXpELFNBQVMsU0FBUyxDQUFDLFNBQVMsRUFBRSxZQUFvQjtJQUFwQiw2QkFBQSxFQUFBLG9CQUFvQjtJQUNoRCxPQUFPO1FBQ0wsSUFBSSxtQkFBbUI7UUFDdkIsT0FBTyxFQUFFO1lBQ1AsSUFBSSxFQUFFLFNBQVM7WUFDZixZQUFZLGNBQUE7U0FDYjtLQUNGLENB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QUEyQjs7SUFFM0IsOEJBQWtDOztJQXNKbEMsd0JBQTJCOztJQWhKRCx3QkFBNEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYXNoTWFwLCBJRCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBSZXBsYXlTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWtpdGFFcnJvciwgQWtpdGFJbW11dGFiaWxpdHlFcnJvciwgYXNzZXJ0RGVjb3JhdG9yIH0gZnJvbSAnLi4vaW50ZXJuYWwvZXJyb3InO1xuaW1wb3J0IHsgY29tbWl0LCBpc1RyYW5zYWN0aW9uSW5Qcm9jZXNzIH0gZnJvbSAnLi4vaW50ZXJuYWwvdHJhbnNhY3Rpb24uaW50ZXJuYWwnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiwgaXNQbGFpbk9iamVjdCB9IGZyb20gJy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IGRlZXBGcmVlemUgfSBmcm9tICcuLi9pbnRlcm5hbC9kZWVwLWZyZWV6ZSc7XG5pbXBvcnQgeyBjb25maWdLZXksIFN0b3JlQ29uZmlnT3B0aW9ucyB9IGZyb20gJy4vc3RvcmUtY29uZmlnJztcbmltcG9ydCB7IF9fZ2xvYmFsU3RhdGUgfSBmcm9tICcuLi9pbnRlcm5hbC9nbG9iYWwtc3RhdGUnO1xuaW1wb3J0IHsgZ2V0QWtpdGFDb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5cbmxldCBfX0RFVl9fID0gdHJ1ZTtcbmNvbnN0IGlzTm90QnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgPT09ICd1bmRlZmluZWQnO1xuXG5leHBvcnQgY29uc3QgX19zdG9yZXNfXzogeyBbc3RvcmVOYW1lOiBzdHJpbmddOiBTdG9yZTxhbnk+IH0gPSB7fTtcblxuZXhwb3J0IGNvbnN0IGVudW0gQWN0aW9ucyB7XG4gIE5FV19TVE9SRSxcbiAgREVMRVRFX1NUT1JFLFxuICBORVdfU1RBVEVcbn1cblxuZXhwb3J0IHR5cGUgQWN0aW9uID0ge1xuICB0eXBlOiBBY3Rpb25zO1xuICBwYXlsb2FkOiBIYXNoTWFwPGFueT47XG59O1xuXG5leHBvcnQgY29uc3Qgcm9vdERpc3BhdGNoZXIgPSBuZXcgUmVwbGF5U3ViamVjdDxBY3Rpb24+KCk7XG5cbmZ1bmN0aW9uIG5leHRTdGF0ZShzdG9yZU5hbWUsIGluaXRpYWxTdGF0ZSA9IGZhbHNlKSB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogQWN0aW9ucy5ORVdfU1RBVEUsXG4gICAgcGF5bG9hZDoge1xuICAgICAgbmFtZTogc3RvcmVOYW1lLFxuICAgICAgaW5pdGlhbFN0YXRlXG4gICAgfVxuICB9O1xufVxuXG4vKipcbiAqIEVuYWJsZSBwcm9kdWN0aW9uIG1vZGUgdG8gZGlzYWJsZSBvYmplY3RGcmVlemVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGVuYWJsZUFraXRhUHJvZE1vZGUoKSB7XG4gIF9fREVWX18gPSBmYWxzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGV2KCkge1xuICByZXR1cm4gX19ERVZfXztcbn1cblxuLyoqXG4gKiBUaGUgUm9vdCBTdG9yZSB0aGF0IGV2ZXJ5IHN1YiBzdG9yZSBuZWVkcyB0byBpbmhlcml0IGFuZFxuICogaW52b2tlIGBzdXBlcmAgd2l0aCB0aGUgaW5pdGlhbCBzdGF0ZS5cbiAqL1xuZXhwb3J0IGNsYXNzIFN0b3JlPFM+IHtcbiAgLyoqIE1hbmFnZSB0aGUgc3RvcmUgd2l0aCBCZWhhdmlvclN1YmplY3QgKi9cbiAgcHJpdmF0ZSBzdG9yZTogQmVoYXZpb3JTdWJqZWN0PFJlYWRvbmx5PFM+PjtcblxuICAvKiogVGhlIGN1cnJlbnQgc3RhdGUgdmFsdWUgKi9cbiAgcHJpdmF0ZSBzdG9yZVZhbHVlOiBTO1xuXG4gIC8qKiBXaGV0aGVyIHdlIGFyZSBpbnNpZGUgdHJhbnNhY3Rpb24gKiovXG4gIHByaXZhdGUgaW5UcmFuc2FjdGlvbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgX2lzUHJpc3RpbmUgPSB0cnVlO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2luaXRpYWxTdGF0ZTogUztcblxuICAvKipcbiAgICpcbiAgICogSW5pdGlhbCB0aGUgc3RvcmUgd2l0aCB0aGUgc3RhdGVcbiAgICovXG4gIGNvbnN0cnVjdG9yKGluaXRpYWxTdGF0ZSwgcHJpdmF0ZSBvcHRpb25zOiB7IGlkS2V5Pzogc3RyaW5nOyBzdG9yZU5hbWU/OiBzdHJpbmcgfSA9IHt9KSB7XG4gICAgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQEBJTklUJyB9KTtcbiAgICBfX3N0b3Jlc19fW3RoaXMuc3RvcmVOYW1lXSA9IHRoaXM7XG4gICAgdGhpcy5zZXRTdGF0ZSgoKSA9PiBpbml0aWFsU3RhdGUpO1xuICAgIHJvb3REaXNwYXRjaGVyLm5leHQoe1xuICAgICAgdHlwZTogQWN0aW9ucy5ORVdfU1RPUkUsXG4gICAgICBwYXlsb2FkOiB7IHN0b3JlOiB0aGlzIH1cbiAgICB9KTtcbiAgICBpc0RldigpICYmIGFzc2VydERlY29yYXRvcih0aGlzLnN0b3JlTmFtZSwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKTtcbiAgICBpZiAodGhpcy5pc1Jlc3NldGFibGUoKSkge1xuICAgICAgdGhpcy5faW5pdGlhbFN0YXRlID0gaW5pdGlhbFN0YXRlO1xuICAgIH1cbiAgfVxuXG4gIHNldExvYWRpbmcobG9hZGluZyA9IGZhbHNlKSB7XG4gICAgaWYgKGxvYWRpbmcgIT09ICh0aGlzLl92YWx1ZSgpIGFzIFMgJiB7IGxvYWRpbmc6IGJvb2xlYW4gfSkubG9hZGluZykge1xuICAgICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdTZXQgTG9hZGluZycgfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHMgPT4gKHsgLi4uKHMgYXMgb2JqZWN0KSwgbG9hZGluZyB9IGFzIGFueSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIHN0b3JlJ3MgZXJyb3Igc3RhdGUuXG4gICAqL1xuICBzZXRFcnJvcjxUPihlcnJvcjogVCkge1xuICAgIGlmIChlcnJvciAhPT0gKHRoaXMuX3ZhbHVlKCkgYXMgUyAmIHsgZXJyb3I6IGFueSB9KS5lcnJvcikge1xuICAgICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdTZXQgRXJyb3InIH0pO1xuICAgICAgdGhpcy5zZXRTdGF0ZShzID0+ICh7IC4uLihzIGFzIG9iamVjdCksIGVycm9yIH0gYXMgYW55KSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBhIHNsaWNlIGZyb20gdGhlIHN0b3JlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmVudGl0aWVzKVxuICAgKlxuICAgKi9cbiAgX3NlbGVjdDxSPihwcm9qZWN0OiAoc3RvcmU6IFMpID0+IFIpOiBPYnNlcnZhYmxlPFI+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZSQucGlwZShcbiAgICAgIG1hcChwcm9qZWN0KSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICApO1xuICB9XG5cbiAgX3ZhbHVlKCk6IFMge1xuICAgIHJldHVybiB0aGlzLnN0b3JlVmFsdWU7XG4gIH1cblxuICBnZXQgY29uZmlnKCk6IFN0b3JlQ29uZmlnT3B0aW9ucyB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3JbY29uZmlnS2V5XTtcbiAgfVxuXG4gIGdldCBzdG9yZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5zdG9yZU5hbWUgfHwgKHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnWydzdG9yZU5hbWUnXSk7XG4gIH1cblxuICBnZXQgaWRLZXkoKSB7XG4gICAgLyoqIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgKi9cbiAgICBjb25zdCBuZXdJZEtleSA9IHRoaXMuY29uZmlnICYmIHRoaXMuY29uZmlnLmlkS2V5O1xuICAgIGlmICghbmV3SWRLZXkpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaWRLZXkgfHwgJ2lkJztcbiAgICB9XG4gICAgcmV0dXJuIG5ld0lkS2V5O1xuICB9XG5cbiAgZ2V0IGlzUHJpc3RpbmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2lzUHJpc3RpbmU7XG4gIH1cblxuICAvKipcbiAgICogYHNldFN0YXRlKClgIGlzIHRoZSBvbmx5IHdheSB0byB1cGRhdGUgYSBzdG9yZTsgSXQgcmVjZWl2ZXMgYSBjYWxsYmFjayBmdW5jdGlvbixcbiAgICogd2hpY2ggZ2V0cyB0aGUgY3VycmVudCBzdGF0ZSwgYW5kIHJldHVybnMgYSBuZXcgaW1tdXRhYmxlIHN0YXRlLFxuICAgKiB3aGljaCB3aWxsIGJlIHRoZSBuZXcgdmFsdWUgb2YgdGhlIHN0b3JlLlxuICAgKi9cbiAgc2V0U3RhdGUobmV3U3RhdGVGbjogKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUywgX3Jvb3REaXNwYXRjaGVyID0gdHJ1ZSkge1xuICAgIGNvbnN0IHByZXZTdGF0ZSA9IHRoaXMuX3ZhbHVlKCk7XG4gICAgdGhpcy5zdG9yZVZhbHVlID0gX19ERVZfXyA/IGRlZXBGcmVlemUobmV3U3RhdGVGbih0aGlzLl92YWx1ZSgpKSkgOiBuZXdTdGF0ZUZuKHRoaXMuX3ZhbHVlKCkpO1xuXG4gICAgaWYgKHByZXZTdGF0ZSA9PT0gdGhpcy5zdG9yZVZhbHVlKSB7XG4gICAgICB0aHJvdyBuZXcgQWtpdGFJbW11dGFiaWxpdHlFcnJvcih0aGlzLnN0b3JlTmFtZSk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnN0b3JlKSB7XG4gICAgICB0aGlzLnN0b3JlID0gbmV3IEJlaGF2aW9yU3ViamVjdCh0aGlzLnN0b3JlVmFsdWUpO1xuICAgICAgcm9vdERpc3BhdGNoZXIubmV4dChuZXh0U3RhdGUodGhpcy5zdG9yZU5hbWUsIHRydWUpKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNUcmFuc2FjdGlvbkluUHJvY2VzcygpKSB7XG4gICAgICB0aGlzLmhhbmRsZVRyYW5zYWN0aW9uKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5kaXNwYXRjaCh0aGlzLnN0b3JlVmFsdWUsIF9yb290RGlzcGF0Y2hlcik7XG4gIH1cblxuICAvKipcbiAgICogUmVzZXRzIHRoZSBzdG9yZSB0byBpdCdzIGluaXRpYWwgc3RhdGUgYW5kIHNldCB0aGUgc3RvcmUgdG8gYSBwcmlzdGluZSBzdGF0ZS5cbiAgICovXG4gIHJlc2V0KCkge1xuICAgIGlmICh0aGlzLmlzUmVzc2V0YWJsZSgpKSB7XG4gICAgICBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdSZXNldCBTdG9yZScgfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKCgpID0+IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuX2luaXRpYWxTdGF0ZSkpO1xuICAgICAgdGhpcy5zZXRQcmlzdGluZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgQWtpdGFFcnJvcihgWW91IG5lZWQgdG8gZW5hYmxlIHRoZSByZXNldCBmdW5jdGlvbmFsaXR5YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgbWV0aG9kIGlzIGEgc2hvcnRjdXQgZm9yIGBzZXRTdGF0ZSgpYC5cbiAgICogSXQgY2FuIGJlIHVzZWZ1bCB3aGVuIHlvdSB3YW50IHRvIHBhc3MgdGhlIHdob2xlIHN0YXRlIG9iamVjdCBpbnN0ZWFkIG9mIG1lcmdpbmcgYSBwYXJ0aWFsIHN0YXRlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShuZXdTdGF0ZSlcbiAgICovXG4gIHVwZGF0ZShuZXdTdGF0ZTogKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUGFydGlhbDxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShpZDogSUQgfCBJRFtdIHwgbnVsbCwgbmV3U3RhdGU6IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUobmV3U3RhdGVPcklkOiBQYXJ0aWFsPFM+IHwgSUQgfCBJRFtdIHwgbnVsbCB8ICgoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBQYXJ0aWFsPFM+KSwgbmV3U3RhdGU/OiBQYXJ0aWFsPFM+KSB7XG4gICAgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnVXBkYXRlIFN0b3JlJyB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGxldCB2YWx1ZSA9IGlzRnVuY3Rpb24obmV3U3RhdGVPcklkKSA/IG5ld1N0YXRlT3JJZChzdGF0ZSkgOiBuZXdTdGF0ZU9ySWQ7XG4gICAgICBsZXQgbWVyZ2VkID0gT2JqZWN0LmFzc2lnbih7fSwgc3RhdGUsIHZhbHVlKTtcbiAgICAgIHJldHVybiBpc1BsYWluT2JqZWN0KHN0YXRlKSA/IG1lcmdlZCA6IG5ldyAoc3RhdGUgYXMgYW55KS5jb25zdHJ1Y3RvcihtZXJnZWQpO1xuICAgIH0pO1xuICAgIHRoaXMuc2V0RGlydHkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHRoZSBzdG9yZSB0byBhIHByaXN0aW5lIHN0YXRlLlxuICAgKi9cbiAgc2V0UHJpc3RpbmUoKSB7XG4gICAgdGhpcy5faXNQcmlzdGluZSA9IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB0aGUgc3RvcmUgdG8gYSBkaXJ0eSBzdGF0ZSwgaW5kaWNhdGluZyB0aGF0IGl0IGlzIG5vdCBwcmlzdGluZS5cbiAgICovXG4gIHNldERpcnR5KCkge1xuICAgIHRoaXMuX2lzUHJpc3RpbmUgPSBmYWxzZTtcbiAgfVxuXG4gIGRlc3Ryb3kgPSB0aGlzLm5nT25EZXN0cm95O1xuXG4gIHByaXZhdGUgZGlzcGF0Y2goc3RhdGU6IFMsIF9yb290RGlzcGF0Y2hlciA9IHRydWUpIHtcbiAgICB0aGlzLnN0b3JlLm5leHQoc3RhdGUpO1xuICAgIGlmIChfcm9vdERpc3BhdGNoZXIpIHtcbiAgICAgIHJvb3REaXNwYXRjaGVyLm5leHQobmV4dFN0YXRlKHRoaXMuc3RvcmVOYW1lKSk7XG4gICAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBTdGF0ZScgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXQgc3RvcmUkKCkge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhlIHRyYW5zYWN0aW9uIGVuZHMgZGlzcGF0Y2ggdGhlIGZpbmFsIHZhbHVlIG9uY2VcbiAgICovXG4gIHByaXZhdGUgd2F0Y2hUcmFuc2FjdGlvbigpIHtcbiAgICBjb21taXQoKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5pblRyYW5zYWN0aW9uID0gZmFsc2U7XG4gICAgICBpZiAoaXNEZXYoKSAmJiAhX19nbG9iYWxTdGF0ZS5za2lwVHJhbnNhY3Rpb25Nc2cpIHtcbiAgICAgICAgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQFRyYW5zYWN0aW9uJyB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuZGlzcGF0Y2godGhpcy5fdmFsdWUoKSk7XG4gICAgICBfX2dsb2JhbFN0YXRlLmN1cnJlbnRUID0gW107XG4gICAgICBfX2dsb2JhbFN0YXRlLnNraXBUcmFuc2FjdGlvbk1zZyA9IGZhbHNlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Jlc3NldGFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLnJlc2V0dGFibGUgfHwgZ2V0QWtpdGFDb25maWcoKS5yZXNldHRhYmxlO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RlbiB0byB0aGUgdHJhbnNhY3Rpb24gc3RyZWFtXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZVRyYW5zYWN0aW9uKCkge1xuICAgIGlmICghdGhpcy5pblRyYW5zYWN0aW9uKSB7XG4gICAgICB0aGlzLndhdGNoVHJhbnNhY3Rpb24oKTtcbiAgICAgIHRoaXMuaW5UcmFuc2FjdGlvbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKGlzTm90QnJvd3NlcikgcmV0dXJuO1xuICAgIGlmICghKHdpbmRvdyBhcyBhbnkpLmhtckVuYWJsZWQgJiYgdGhpcyA9PT0gX19zdG9yZXNfX1t0aGlzLnN0b3JlTmFtZV0pIHtcbiAgICAgIGRlbGV0ZSBfX3N0b3Jlc19fW3RoaXMuc3RvcmVOYW1lXTtcbiAgICAgIHJvb3REaXNwYXRjaGVyLm5leHQoe1xuICAgICAgICB0eXBlOiBBY3Rpb25zLkRFTEVURV9TVE9SRSxcbiAgICAgICAgcGF5bG9hZDogeyBzdG9yZU5hbWU6IHRoaXMuc3RvcmVOYW1lIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19