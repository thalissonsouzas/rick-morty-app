/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { _crud } from '../internal/crud';
import { AkitaImmutabilityError, assertActive } from '../internal/error';
import { __globalState } from '../internal/global-state';
import { coerceArray, entityExists, isFunction, isNil, isObject, toBoolean } from '../internal/utils';
import { isDev, Store } from './store';
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E, ActiveEntity
 */
var /**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E, ActiveEntity
 */
EntityStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityStore, _super);
    /**
     *
     * Initiate the store with the state
     */
    function EntityStore(initialState, options) {
        if (initialState === void 0) { initialState = {}; }
        if (options === void 0) { options = {}; }
        return _super.call(this, tslib_1.__assign({}, getInitialEntitiesState(), initialState), options) || this;
    }
    Object.defineProperty(EntityStore.prototype, "entities", {
        get: /**
         * @return {?}
         */
        function () {
            return this._value().entities;
        },
        enumerable: true,
        configurable: true
    });
    /**
     *
     * Replace current collection with provided collection
     *
     * @example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     */
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.set = /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        isDev() && __globalState.setAction({ type: 'Set Entities' });
        this.setState(function (state) { return _crud._set(state, isNil(entities) ? [] : entities, options.entityClass, _this.idKey); });
        this.setDirty();
    };
    /**
     * Create or replace an entity in the store.
     *
     * @example
     * this.store.createOrReplace(3, Entity);
     *
     */
    /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    EntityStore.prototype.createOrReplace = /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    function (id, entity) {
        if (!entityExists(id, this._value().entities)) {
            this.addWhenNotExists(id, entity);
        }
        else {
            isDev() && __globalState.setAction({ type: 'Create or Replace Entity', entityId: [id] });
            this.setState(function (state) { return _crud._replaceEntity(state, id, entity); });
        }
    };
    /**
     *
     * Insert or Update
     */
    /**
     *
     * Insert or Update
     * @param {?} id
     * @param {?} entityOrFn
     * @return {?}
     */
    EntityStore.prototype.upsert = /**
     *
     * Insert or Update
     * @param {?} id
     * @param {?} entityOrFn
     * @return {?}
     */
    function (id, entityOrFn) {
        if (!entityExists(id, this._value().entities)) {
            /** @type {?} */
            var resolve = isFunction(entityOrFn) ? ((/** @type {?} */ (entityOrFn)))({}) : entityOrFn;
            this.addWhenNotExists(id, resolve);
        }
        else {
            this.update(id, (/** @type {?} */ (entityOrFn)));
        }
    };
    /**
     * Add an entity or entities to the store.
     *
     * @example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * this.store.add(Entity, { prepend: true });
     */
    /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * this.store.add(Entity, { prepend: true });
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.add = /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * this.store.add(Entity, { prepend: true });
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(entities);
        if (toArray.length === 0)
            return;
        /**
         * If we pass entities that already exist, we should ignore them
         * @type {?}
         */
        var allExists = toArray.every(function (entity) { return _this._value().ids.indexOf(entity[_this.idKey]) > -1; });
        if (allExists)
            return;
        isDev() && __globalState.setAction({ type: 'Add Entity' });
        this.setState(function (state) { return _crud._add(state, toArray, _this.idKey, options); });
    };
    /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    EntityStore.prototype.update = /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    function (idsOrFn, newStateOrFn) {
        var _this = this;
        /** @type {?} */
        var ids = [];
        /** @type {?} */
        var storeIds = this._value().ids;
        if (isFunction(idsOrFn)) {
            for (var i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                var id = storeIds[i];
                /** @type {?} */
                var entity = this._value().entities[id];
                if (entity && ((/** @type {?} */ (idsOrFn)))(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = toBoolean(idsOrFn) ? coerceArray(idsOrFn) : storeIds;
        }
        if (ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Update Entity', entityId: ids });
        this.setState(function (state) {
            return _crud._update(state, ids, newStateOrFn, _this.idKey);
        });
    };
    /**
     * An alias to update all.
     */
    /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    EntityStore.prototype.updateAll = /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    function (state) {
        if (this._value().ids.length === 0)
            return;
        this.update(null, state);
    };
    /**
     * Update the root state (data which is external to the entities).
     *
     * @example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     */
    /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    EntityStore.prototype.updateRoot = /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    function (newStateFn, action) {
        /** @type {?} */
        var newState = isFunction(newStateFn) ? newStateFn(this._value()) : newStateFn;
        if (newState === this._value()) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        isDev() && __globalState.setAction(action || { type: 'Update Root' });
        this.setState(function (state) {
            return tslib_1.__assign({}, ((/** @type {?} */ (state))), ((/** @type {?} */ (newState))));
        });
    };
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    EntityStore.prototype.remove = /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    function (idsOrFn) {
        /** @type {?} */
        var storeIds = this._value().ids;
        if (storeIds.length === 0)
            return;
        /** @type {?} */
        var idPassed = toBoolean(idsOrFn);
        if (!idPassed)
            this.setPristine();
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFn)) {
            for (var i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                var id = storeIds[i];
                /** @type {?} */
                var entity = this._value().entities[id];
                if (entity && idsOrFn(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (ids && ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Remove Entity', entityId: ids });
        this.setState(function (state) {
            return _crud._remove(state, ids);
        });
    };
    /**
     *
     * Update the active entity.
     *
     * @example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     */
    /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    EntityStore.prototype.updateActive = /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    function (newStateFn) {
        var _this = this;
        assertActive(this._value());
        isDev() && __globalState.setAction({ type: 'Update Active Entity', entityId: this._value().active });
        this.setState(function (state) {
            /** @type {?} */
            var activeId = (/** @type {?} */ (state.active));
            /** @type {?} */
            var newState = isFunction(newStateFn) ? newStateFn(state.entities[activeId]) : newStateFn;
            if (newState === state) {
                throw new AkitaImmutabilityError(_this.storeName);
            }
            return _crud._update(state, [activeId], newState, _this.idKey);
        });
    };
    /**
     * Set the given entity as active.
     */
    /**
     * Set the given entity as active.
     * @param {?} idOrOptions
     * @return {?}
     */
    EntityStore.prototype.setActive = /**
     * Set the given entity as active.
     * @param {?} idOrOptions
     * @return {?}
     */
    function (idOrOptions) {
        /** @type {?} */
        var activeId;
        if (isObject(idOrOptions)) {
            if (isNil(this._value().active))
                return;
            ((/** @type {?} */ (idOrOptions))) = Object.assign({ wrap: true }, idOrOptions);
            /** @type {?} */
            var ids = this._value().ids;
            /** @type {?} */
            var currentIdIndex = ids.indexOf(this._value().active);
            if (((/** @type {?} */ (idOrOptions))).prev) {
                /** @type {?} */
                var isFirst = currentIdIndex === 0;
                if (isFirst && !((/** @type {?} */ (idOrOptions))).wrap)
                    return;
                activeId = isFirst ? ids[ids.length - 1] : ((/** @type {?} */ (ids[currentIdIndex - 1])));
            }
            else if (((/** @type {?} */ (idOrOptions))).next) {
                /** @type {?} */
                var isLast = ids.length === currentIdIndex + 1;
                if (isLast && !((/** @type {?} */ (idOrOptions))).wrap)
                    return;
                activeId = isLast ? ids[0] : ((/** @type {?} */ (ids[currentIdIndex + 1])));
            }
        }
        else {
            if (idOrOptions === this._value().active)
                return;
            activeId = (/** @type {?} */ (idOrOptions));
        }
        isDev() && __globalState.setAction({ type: 'Set Active Entity', entityId: activeId });
        this.setState(function (state) {
            return tslib_1.__assign({}, ((/** @type {?} */ (state))), { active: activeId });
        });
    };
    /**
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    EntityStore.prototype.addWhenNotExists = /**
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    function (id, entity) {
        if (!entity[this.idKey]) {
            entity[this.idKey] = id;
        }
        this.add(entity);
    };
    return EntityStore;
}(Store));
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E, ActiveEntity
 */
export { EntityStore };
/** @type {?} */
export var getInitialEntitiesState = function () {
    return ((/** @type {?} */ ({
        entities: {},
        ids: [],
        loading: true,
        error: null
    })));
};
/** @type {?} */
export var getInitialActiveState = function () {
    return ((/** @type {?} */ ({
        active: null
    })));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXN0b3JlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9lbnRpdHktc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDekMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pFLE9BQU8sRUFBVSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBZSxTQUFTLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuSCxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQzs7Ozs7O0FBT3ZDOzs7Ozs7SUFBaUYsdUNBQVE7SUFDdkY7OztPQUdHO0lBQ0gscUJBQVksWUFBaUIsRUFBRSxPQUFvRDtRQUF2RSw2QkFBQSxFQUFBLGlCQUFpQjtRQUFFLHdCQUFBLEVBQUEsWUFBb0Q7ZUFDakYsdUNBQVcsdUJBQXVCLEVBQUUsRUFBSyxZQUFZLEdBQUksT0FBTyxDQUFDO0lBQ25FLENBQUM7SUFFRCxzQkFBSSxpQ0FBUTs7OztRQUFaO1lBQ0UsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDO1FBQ2hDLENBQUM7OztPQUFBO0lBRUQ7Ozs7Ozs7OztPQVNHOzs7Ozs7Ozs7Ozs7OztJQUNILHlCQUFHOzs7Ozs7Ozs7Ozs7O0lBQUgsVUFBSSxRQUF3QyxFQUFFLE9BQXNEO1FBQXBHLGlCQUlDO1FBSjZDLHdCQUFBLEVBQUEsWUFBc0Q7UUFDbEcsS0FBSyxFQUFFLElBQUksYUFBYSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxRQUFR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QVM7UUFDeEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDekI7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFDSCxrQkFBQztBQUFELENBQUMsQUFyU0QsQ0FBaUYsS0FBSyxHQXFTckY7Ozs7Ozs7O0FBRUQsTUFBTSxLQUFPLHVCQUF1QixHQUFHO0lBQ3JDLE9BQUEsQ0FBQyxtQkFBQTtRQUNDLFFBQVEsRUFBRSxFQUFFO1FBQ1osR0FBRyxFQUFFLEVBQUU7UUFDUCxPQUFPLEVBQUUsSUFBSTtRQUNiLEtBQUssRUFBRSxJQUFJO0tBQ1osRUFBZSxDQUFDO0FBTGpCLENBS2lCOztBQUVuQixNQUFNLEtBQU8scUJBQXFCLEdBQUc7SUFDbkMsT0FBQSxDQUFDLG1CQUFBO1FBQ0MsTUFBTSxFQUFFLElBQUk7S0FDYixFQUFlLENBQUM7QUFGakIsQ0FFaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfY3J1ZCB9IGZyb20gJy4uL2ludGVybmFsL2NydWQnO1xuaW1wb3J0IHsgQWtpdGFJbW11dGFiaWxpdHlFcnJvciwgYXNzZXJ0QWN0aXZlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZXJyb3InO1xuaW1wb3J0IHsgQWN0aW9uLCBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcbmltcG9ydCB7IGNvZXJjZUFycmF5LCBlbnRpdHlFeGlzdHMsIGlzRnVuY3Rpb24sIGlzTmlsLCBpc09iamVjdCwgaXNVbmRlZmluZWQsIHRvQm9vbGVhbiB9IGZyb20gJy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IGlzRGV2LCBTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgQWN0aXZlU3RhdGUsIEVudGl0aWVzLCBFbnRpdHlTdGF0ZSwgSGFzaE1hcCwgSUQsIE5ld2FibGUsIEFkZE9wdGlvbnMsIFNldEFjdGl2ZU9wdGlvbnMgfSBmcm9tICcuL3R5cGVzJztcblxuLyoqXG4gKiBUaGUgUm9vdCBTdG9yZSB0aGF0IGV2ZXJ5IHN1YiBzdG9yZSBuZWVkcyB0byBpbmhlcml0IGFuZFxuICogaW52b2tlIGBzdXBlcmAgd2l0aCB0aGUgaW5pdGlhbCBzdGF0ZS5cbiAqL1xuZXhwb3J0IGNsYXNzIEVudGl0eVN0b3JlPFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxFPiwgRSwgQWN0aXZlRW50aXR5ID0gSUQ+IGV4dGVuZHMgU3RvcmU8Uz4ge1xuICAvKipcbiAgICpcbiAgICogSW5pdGlhdGUgdGhlIHN0b3JlIHdpdGggdGhlIHN0YXRlXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGUgPSB7fSwgb3B0aW9uczogeyBpZEtleT86IHN0cmluZzsgc3RvcmVOYW1lPzogc3RyaW5nIH0gPSB7fSkge1xuICAgIHN1cGVyKHsgLi4uZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUoKSwgLi4uaW5pdGlhbFN0YXRlIH0sIG9wdGlvbnMpO1xuICB9XG5cbiAgZ2V0IGVudGl0aWVzKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZSgpLmVudGl0aWVzO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlcGxhY2UgY3VycmVudCBjb2xsZWN0aW9uIHdpdGggcHJvdmlkZWQgY29sbGVjdGlvblxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnNldChbRW50aXR5LCBFbnRpdHldKTtcbiAgICogdGhpcy5zdG9yZS5zZXQoezE6IEVudGl0eSwgMjogRW50aXR5fSk7XG4gICAqIHRoaXMuc3RvcmUuc2V0KFt7aWQ6IDF9LCB7aWQ6IDJ9XSwgeyBlbnRpdHlDbGFzczogUHJvZHVjdCB9KTtcbiAgICpcbiAgICovXG4gIHNldChlbnRpdGllczogRVtdIHwgSGFzaE1hcDxFPiB8IEVudGl0aWVzPEU+LCBvcHRpb25zOiB7IGVudGl0eUNsYXNzPzogTmV3YWJsZTxFPiB8IHVuZGVmaW5lZCB9ID0ge30pIHtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBFbnRpdGllcycgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiBfY3J1ZC5fc2V0KHN0YXRlLCBpc05pbChlbnRpdGllcykgPyBbXSA6IGVudGl0aWVzLCBvcHRpb25zLmVudGl0eUNsYXNzLCB0aGlzLmlkS2V5KSk7XG4gICAgdGhpcy5zZXREaXJ0eSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBvciByZXBsYWNlIGFuIGVudGl0eSBpbiB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuY3JlYXRlT3JSZXBsYWNlKDMsIEVudGl0eSk7XG4gICAqXG4gICAqL1xuICBjcmVhdGVPclJlcGxhY2UoaWQ6IElELCBlbnRpdHk6IEUpIHtcbiAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgdGhpcy5fdmFsdWUoKS5lbnRpdGllcykpIHtcbiAgICAgIHRoaXMuYWRkV2hlbk5vdEV4aXN0cyhpZCwgZW50aXR5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdDcmVhdGUgb3IgUmVwbGFjZSBFbnRpdHknLCBlbnRpdHlJZDogW2lkXSB9KTtcbiAgICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gX2NydWQuX3JlcGxhY2VFbnRpdHkoc3RhdGUsIGlkLCBlbnRpdHkpKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogSW5zZXJ0IG9yIFVwZGF0ZVxuICAgKi9cbiAgdXBzZXJ0KGlkOiBJRCwgZW50aXR5T3JGbjogUGFydGlhbDxFPiB8ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikpIHtcbiAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgdGhpcy5fdmFsdWUoKS5lbnRpdGllcykpIHtcbiAgICAgIGNvbnN0IHJlc29sdmUgPSBpc0Z1bmN0aW9uKGVudGl0eU9yRm4pID8gKGVudGl0eU9yRm4gYXMgRnVuY3Rpb24pKHt9KSA6IGVudGl0eU9yRm47XG4gICAgICB0aGlzLmFkZFdoZW5Ob3RFeGlzdHMoaWQsIHJlc29sdmUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnVwZGF0ZShpZCwgZW50aXR5T3JGbiBhcyBhbnkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYW4gZW50aXR5IG9yIGVudGl0aWVzIHRvIHRoZSBzdG9yZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5hZGQoW0VudGl0eSwgRW50aXR5XSk7XG4gICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSk7XG4gICAqIHRoaXMuc3RvcmUuYWRkKEVudGl0eSwgeyBwcmVwZW5kOiB0cnVlIH0pO1xuICAgKi9cbiAgYWRkKGVudGl0aWVzOiBFW10gfCBFLCBvcHRpb25zPzogQWRkT3B0aW9ucykge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShlbnRpdGllcyk7XG5cbiAgICBpZiAodG9BcnJheS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAvKiogIElmIHdlIHBhc3MgZW50aXRpZXMgdGhhdCBhbHJlYWR5IGV4aXN0LCB3ZSBzaG91bGQgaWdub3JlIHRoZW0gKi9cbiAgICBjb25zdCBhbGxFeGlzdHMgPSB0b0FycmF5LmV2ZXJ5KGVudGl0eSA9PiB0aGlzLl92YWx1ZSgpLmlkcy5pbmRleE9mKGVudGl0eVt0aGlzLmlkS2V5XSkgPiAtMSk7XG4gICAgaWYgKGFsbEV4aXN0cykgcmV0dXJuO1xuXG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdBZGQgRW50aXR5JyB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IF9jcnVkLl9hZGQ8UywgRT4oc3RhdGUsIHRvQXJyYXksIHRoaXMuaWRLZXksIG9wdGlvbnMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBVcGRhdGUgYW4gZW50aXR5IG9yIGVudGl0aWVzIGluIHRoZSBzdG9yZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS51cGRhdGUoMywge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqICB0aGlzLnN0b3JlLnVwZGF0ZSgzLCBlbnRpdHkgPT4ge1xuICAgKiAgICByZXR1cm4ge1xuICAgKiAgICAgIGNvbmZpZzoge1xuICAgKiAgICAgICAgLi4uZW50aXR5LmZpbHRlcixcbiAgICogICAgICAgIGRhdGVcbiAgICogICAgICB9XG4gICAqICAgIH1cbiAgICogIH0pO1xuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShbMSwyLDNdLCB7XG4gICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgKiB9KTtcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUoZSA9PiBlLm5hbWUgPT09ICd2YWx1ZScsIHtcbiAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZShudWxsLCB7XG4gICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgKiB9KTtcbiAgICpcbiAgICovXG4gIHVwZGF0ZShpZDogSUQgfCBJRFtdIHwgbnVsbCwgbmV3U3RhdGVGbjogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBQYXJ0aWFsPEU+KSk7XG4gIHVwZGF0ZShpZDogSUQgfCBJRFtdIHwgbnVsbCwgbmV3U3RhdGU6IFBhcnRpYWw8RT4pO1xuICB1cGRhdGUoaWQ6IElEIHwgSURbXSB8IG51bGwsIG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiAoc3RhdGU6IFJlYWRvbmx5PFM+KSA9PiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKHByZWRpY2F0ZTogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSwgbmV3U3RhdGVGbjogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBQYXJ0aWFsPEU+KSk7XG4gIHVwZGF0ZShwcmVkaWNhdGU6ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksIG5ld1N0YXRlOiBQYXJ0aWFsPEU+KTtcbiAgdXBkYXRlKHByZWRpY2F0ZTogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSwgbmV3U3RhdGU6IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUobmV3U3RhdGU6IFBhcnRpYWw8Uz4pO1xuICB1cGRhdGUoXG4gICAgaWRzT3JGbjogSUQgfCBJRFtdIHwgbnVsbCB8IFBhcnRpYWw8Uz4gfCAoKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUGFydGlhbDxTPikgfCAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pLFxuICAgIG5ld1N0YXRlT3JGbj86ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikgfCBQYXJ0aWFsPEU+IHwgUGFydGlhbDxTPlxuICApIHtcbiAgICBsZXQgaWRzOiBJRFtdID0gW107XG4gICAgY29uc3Qgc3RvcmVJZHMgPSB0aGlzLl92YWx1ZSgpLmlkcztcblxuICAgIGlmIChpc0Z1bmN0aW9uKGlkc09yRm4pKSB7XG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc3RvcmVJZHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBzdG9yZUlkc1tpXTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5fdmFsdWUoKS5lbnRpdGllc1tpZF07XG4gICAgICAgIGlmIChlbnRpdHkgJiYgKGlkc09yRm4gYXMgRnVuY3Rpb24pKGVudGl0eSkpIHtcbiAgICAgICAgICBpZHMucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWRzID0gdG9Cb29sZWFuKGlkc09yRm4pID8gY29lcmNlQXJyYXkoaWRzT3JGbikgOiBzdG9yZUlkcztcbiAgICB9XG5cbiAgICBpZiAoaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnVXBkYXRlIEVudGl0eScsIGVudGl0eUlkOiBpZHMgfSk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiBfY3J1ZC5fdXBkYXRlKHN0YXRlLCBpZHMsIG5ld1N0YXRlT3JGbiwgdGhpcy5pZEtleSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQW4gYWxpYXMgdG8gdXBkYXRlIGFsbC5cbiAgICovXG4gIHVwZGF0ZUFsbChzdGF0ZTogUGFydGlhbDxFPikge1xuICAgIGlmICh0aGlzLl92YWx1ZSgpLmlkcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICB0aGlzLnVwZGF0ZShudWxsLCBzdGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSByb290IHN0YXRlIChkYXRhIHdoaWNoIGlzIGV4dGVybmFsIHRvIHRoZSBlbnRpdGllcykuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlUm9vdCh7XG4gICAqICAgbWV0YWRhdGE6ICduZXcgbWV0YWRhdGFcbiAgICogfSk7XG4gICAqXG4gICAqICB0aGlzLnN0b3JlLnVwZGF0ZVJvb3Qoc3RhdGUgPT4ge1xuICAgKiAgICByZXR1cm4ge1xuICAgKiAgICAgIG1ldGFkYXRhOiB7XG4gICAqICAgICAgICAuLi5zdGF0ZS5tZXRhZGF0YSxcbiAgICogICAgICAgIGtleTogJ25ldyB2YWx1ZSdcbiAgICogICAgICB9XG4gICAqICAgIH1cbiAgICogIH0pO1xuICAgKi9cbiAgdXBkYXRlUm9vdChuZXdTdGF0ZUZuOiAoKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUGFydGlhbDxTPikgfCBQYXJ0aWFsPFM+LCBhY3Rpb24/OiBBY3Rpb24pIHtcbiAgICBjb25zdCBuZXdTdGF0ZSA9IGlzRnVuY3Rpb24obmV3U3RhdGVGbikgPyBuZXdTdGF0ZUZuKHRoaXMuX3ZhbHVlKCkpIDogbmV3U3RhdGVGbjtcblxuICAgIGlmIChuZXdTdGF0ZSA9PT0gdGhpcy5fdmFsdWUoKSkge1xuICAgICAgdGhyb3cgbmV3IEFraXRhSW1tdXRhYmlsaXR5RXJyb3IodGhpcy5zdG9yZU5hbWUpO1xuICAgIH1cblxuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oYWN0aW9uIHx8IHsgdHlwZTogJ1VwZGF0ZSBSb290JyB9KTtcblxuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uKHN0YXRlIGFzIGFueSksXG4gICAgICAgIC4uLihuZXdTdGF0ZSBhcyBhbnkpXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlbW92ZSBvbmUgb3IgbW9yZSBlbnRpdGllcyBmcm9tIHRoZSBzdG9yZTpcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoNSk7XG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKFsxLDIsM10pO1xuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShlbnRpdHkgPT4gZW50aXR5LmlkID09PSAxKTtcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoKTtcbiAgICovXG4gIHJlbW92ZShpZD86IElEIHwgSURbXSk7XG4gIHJlbW92ZShwcmVkaWNhdGU6IChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKTtcbiAgcmVtb3ZlKGlkc09yRm4/OiBJRCB8IElEW10gfCAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pKSB7XG4gICAgY29uc3Qgc3RvcmVJZHMgPSB0aGlzLl92YWx1ZSgpLmlkcztcblxuICAgIGlmIChzdG9yZUlkcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBjb25zdCBpZFBhc3NlZCA9IHRvQm9vbGVhbihpZHNPckZuKTtcbiAgICBpZiAoIWlkUGFzc2VkKSB0aGlzLnNldFByaXN0aW5lKCk7XG5cbiAgICBsZXQgaWRzOiBJRFtdID0gW107XG4gICAgaWYgKGlzRnVuY3Rpb24oaWRzT3JGbikpIHtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBsZW4gPSBzdG9yZUlkcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuICAgICAgICBjb25zdCBpZCA9IHN0b3JlSWRzW2ldO1xuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLl92YWx1ZSgpLmVudGl0aWVzW2lkXTtcbiAgICAgICAgaWYgKGVudGl0eSAmJiBpZHNPckZuKGVudGl0eSkpIHtcbiAgICAgICAgICBpZHMucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWRzID0gaWRQYXNzZWQgPyBjb2VyY2VBcnJheShpZHNPckZuKSA6IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGlkcyAmJiBpZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdSZW1vdmUgRW50aXR5JywgZW50aXR5SWQ6IGlkcyB9KTtcblxuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIF9jcnVkLl9yZW1vdmUoc3RhdGUsIGlkcyk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIHRoZSBhY3RpdmUgZW50aXR5LlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZUFjdGl2ZShhY3RpdmUgPT4ge1xuICAgKiAgIHJldHVybiB7XG4gICAqICAgICBjb25maWc6IHtcbiAgICogICAgICAuLmFjdGl2ZS5jb25maWcsXG4gICAqICAgICAgZGF0ZVxuICAgKiAgICAgfVxuICAgKiAgIH1cbiAgICogfSlcbiAgICovXG4gIHVwZGF0ZUFjdGl2ZShuZXdTdGF0ZUZuOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pIHwgUGFydGlhbDxFPikge1xuICAgIGFzc2VydEFjdGl2ZSh0aGlzLl92YWx1ZSgpKTtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1VwZGF0ZSBBY3RpdmUgRW50aXR5JywgZW50aXR5SWQ6IHRoaXMuX3ZhbHVlKCkuYWN0aXZlIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgY29uc3QgYWN0aXZlSWQgPSBzdGF0ZS5hY3RpdmUgYXMgSUQ7XG4gICAgICBjb25zdCBuZXdTdGF0ZSA9IGlzRnVuY3Rpb24obmV3U3RhdGVGbikgPyBuZXdTdGF0ZUZuKHN0YXRlLmVudGl0aWVzW2FjdGl2ZUlkXSkgOiBuZXdTdGF0ZUZuO1xuICAgICAgaWYgKG5ld1N0YXRlID09PSBzdGF0ZSkge1xuICAgICAgICB0aHJvdyBuZXcgQWtpdGFJbW11dGFiaWxpdHlFcnJvcih0aGlzLnN0b3JlTmFtZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gX2NydWQuX3VwZGF0ZShzdGF0ZSwgW2FjdGl2ZUlkXSwgbmV3U3RhdGUsIHRoaXMuaWRLZXkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZ2l2ZW4gZW50aXR5IGFzIGFjdGl2ZS5cbiAgICovXG4gIHNldEFjdGl2ZShpZE9yT3B0aW9uczogQWN0aXZlRW50aXR5IHwgU2V0QWN0aXZlT3B0aW9ucyB8IG51bGwpIHtcbiAgICBsZXQgYWN0aXZlSWQ6IEFjdGl2ZUVudGl0eTtcblxuICAgIGlmIChpc09iamVjdChpZE9yT3B0aW9ucykpIHtcbiAgICAgIGlmIChpc05pbCh0aGlzLl92YWx1ZSgpLmFjdGl2ZSkpIHJldHVybjtcbiAgICAgIChpZE9yT3B0aW9ucyBhcyBTZXRBY3RpdmVPcHRpb25zKSA9IE9iamVjdC5hc3NpZ24oeyB3cmFwOiB0cnVlIH0sIGlkT3JPcHRpb25zKTtcbiAgICAgIGNvbnN0IGlkcyA9IHRoaXMuX3ZhbHVlKCkuaWRzO1xuICAgICAgY29uc3QgY3VycmVudElkSW5kZXggPSBpZHMuaW5kZXhPZih0aGlzLl92YWx1ZSgpLmFjdGl2ZSk7XG4gICAgICBpZiAoKGlkT3JPcHRpb25zIGFzIFNldEFjdGl2ZU9wdGlvbnMpLnByZXYpIHtcbiAgICAgICAgY29uc3QgaXNGaXJzdCA9IGN1cnJlbnRJZEluZGV4ID09PSAwO1xuICAgICAgICBpZiAoaXNGaXJzdCAmJiAhKGlkT3JPcHRpb25zIGFzIFNldEFjdGl2ZU9wdGlvbnMpLndyYXApIHJldHVybjtcbiAgICAgICAgYWN0aXZlSWQgPSBpc0ZpcnN0ID8gaWRzW2lkcy5sZW5ndGggLSAxXSA6IChpZHNbY3VycmVudElkSW5kZXggLSAxXSBhcyBhbnkpO1xuICAgICAgfSBlbHNlIGlmICgoaWRPck9wdGlvbnMgYXMgU2V0QWN0aXZlT3B0aW9ucykubmV4dCkge1xuICAgICAgICBjb25zdCBpc0xhc3QgPSBpZHMubGVuZ3RoID09PSBjdXJyZW50SWRJbmRleCArIDE7XG4gICAgICAgIGlmIChpc0xhc3QgJiYgIShpZE9yT3B0aW9ucyBhcyBTZXRBY3RpdmVPcHRpb25zKS53cmFwKSByZXR1cm47XG4gICAgICAgIGFjdGl2ZUlkID0gaXNMYXN0ID8gaWRzWzBdIDogKGlkc1tjdXJyZW50SWRJbmRleCArIDFdIGFzIGFueSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChpZE9yT3B0aW9ucyA9PT0gdGhpcy5fdmFsdWUoKS5hY3RpdmUpIHJldHVybjtcbiAgICAgIGFjdGl2ZUlkID0gaWRPck9wdGlvbnMgYXMgQWN0aXZlRW50aXR5O1xuICAgIH1cblxuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnU2V0IEFjdGl2ZSBFbnRpdHknLCBlbnRpdHlJZDogYWN0aXZlSWQgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgICAgYWN0aXZlOiBhY3RpdmVJZFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkV2hlbk5vdEV4aXN0cyhpZDogSUQsIGVudGl0eTogRSkge1xuICAgIGlmICghZW50aXR5W3RoaXMuaWRLZXldKSB7XG4gICAgICBlbnRpdHlbdGhpcy5pZEtleV0gPSBpZDtcbiAgICB9XG4gICAgdGhpcy5hZGQoZW50aXR5KTtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUgPSAoKSA9PlxuICAoe1xuICAgIGVudGl0aWVzOiB7fSxcbiAgICBpZHM6IFtdLFxuICAgIGxvYWRpbmc6IHRydWUsXG4gICAgZXJyb3I6IG51bGxcbiAgfSBhcyBFbnRpdHlTdGF0ZSk7XG5cbmV4cG9ydCBjb25zdCBnZXRJbml0aWFsQWN0aXZlU3RhdGUgPSAoKSA9PlxuICAoe1xuICAgIGFjdGl2ZTogbnVsbFxuICB9IGFzIEFjdGl2ZVN0YXRlKTtcbiJdfQ==