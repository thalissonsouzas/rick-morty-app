/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { combineLatest } from 'rxjs';
import { auditTime, map, switchMap, withLatestFrom } from 'rxjs/operators';
import { compareValues } from '../internal/sort';
import { entityExists, isFunction, isUndefined, toBoolean } from '../internal/utils';
import { memoizeOne } from './memoize';
import { Query } from './query';
/**
 * @record
 * @template E
 */
export function SelectOptions() { }
if (false) {
    /** @type {?|undefined} */
    SelectOptions.prototype.asObject;
    /** @type {?|undefined} */
    SelectOptions.prototype.filterBy;
    /** @type {?|undefined} */
    SelectOptions.prototype.limitTo;
}
/**
 *  An abstraction for querying the entities from the store
 * @template S, E, ActiveEntity
 */
var /**
 *  An abstraction for querying the entities from the store
 * @template S, E, ActiveEntity
 */
QueryEntity = /** @class */ (function (_super) {
    tslib_1.__extends(QueryEntity, _super);
    function QueryEntity(store) {
        var _this = _super.call(this, store) || this;
        _this.__store__ = store;
        return _this;
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.selectAll = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        if (options === void 0) { options = {
            asObject: false
        }; }
        /** @type {?} */
        var selectState$ = this.select(function (state) { return state; });
        /** @type {?} */
        var selectEntities$ = this.select(function (state) { return state.entities; });
        this.sortByOptions(options);
        return selectEntities$.pipe(withLatestFrom(selectState$, function (entities, state) {
            var ids = state.ids;
            if (options.asObject) {
                return toMap(ids, entities, options);
            }
            else {
                if (!options.filterBy && !options.sortBy) {
                    if (!_this.memoized) {
                        _this.memoized = memoizeOne(toArray);
                    }
                    return _this.memoized(state, options);
                }
                return toArray(state, options);
            }
        }));
    };
    /**
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.getAll = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        if (options === void 0) { options = { asObject: false, filterBy: undefined, limitTo: undefined }; }
        /** @type {?} */
        var state = this.getSnapshot();
        if (options.asObject) {
            return toMap(state.ids, state.entities, options, true);
        }
        this.sortByOptions(options);
        return toArray(state, options);
    };
    /**
     * Select multiple entities from the store.
     *
     * @example
     * this.store.selectMany([1,2]);
     */
    /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    QueryEntity.prototype.selectMany = /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    function (ids, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var filterUndefined = isUndefined(options.filterUndefined) ? true : options.filterUndefined;
        /** @type {?} */
        var entities = ids.map(function (id) { return _this.selectEntity(id); });
        return combineLatest(entities).pipe(map(function (entities) {
            return filterUndefined ? entities.filter(function (val) { return !isUndefined(val); }) : entities;
        }), auditTime(0));
    };
    /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    QueryEntity.prototype.selectEntity = /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    function (id, project) {
        var _this = this;
        if (!project) {
            return this._byId(id);
        }
        return this.select(function (state) {
            if (_this.hasEntity(id)) {
                return project(_this.getEntity(id));
            }
            return undefined;
        });
    };
    /**
     * Get an entity by id
     *
     * @example
     * this.store.getEntity(1);
     */
    /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    QueryEntity.prototype.getEntity = /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return this.getSnapshot().entities[(/** @type {?} */ (id))];
    };
    /**
     * Select the active entity's id.
     */
    /**
     * Select the active entity's id.
     * @return {?}
     */
    QueryEntity.prototype.selectActiveId = /**
     * Select the active entity's id.
     * @return {?}
     */
    function () {
        return this.select(function (state) { return ((/** @type {?} */ (state))).active; });
    };
    /**
     * Get the active id
     */
    /**
     * Get the active id
     * @return {?}
     */
    QueryEntity.prototype.getActiveId = /**
     * Get the active id
     * @return {?}
     */
    function () {
        return ((/** @type {?} */ (this.getSnapshot()))).active;
    };
    /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    QueryEntity.prototype.selectActive = /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    function (project) {
        var _this = this;
        return this.selectActiveId().pipe(switchMap(function (activeId) { return _this.selectEntity(activeId, project); }));
    };
    /**
     * Get the active entity.
     */
    /**
     * Get the active entity.
     * @return {?}
     */
    QueryEntity.prototype.getActive = /**
     * Get the active entity.
     * @return {?}
     */
    function () {
        /** @type {?} */
        var activeId = this.getActiveId();
        return toBoolean(activeId) ? this.getEntity(activeId) : undefined;
    };
    /**
     * Select the store's entity collection length.
     */
    /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    QueryEntity.prototype.selectCount = /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    function (predicate) {
        if (isFunction(predicate)) {
            return this.selectAll({
                filterBy: predicate
            }).pipe(map(function (entities) { return entities.length; }));
        }
        return this.select(function (store) { return store.ids.length; });
    };
    /**
     * Get the store's entity collection length.
     */
    /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    QueryEntity.prototype.getCount = /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    function (predicate) {
        if (isFunction(predicate)) {
            return this.getAll().filter(predicate).length;
        }
        return this.getSnapshot().ids.length;
    };
    /**
     * @param {?} projectOrIds
     * @return {?}
     */
    QueryEntity.prototype.hasEntity = /**
     * @param {?} projectOrIds
     * @return {?}
     */
    function (projectOrIds) {
        var _this = this;
        if (isFunction(projectOrIds)) {
            return this.getAll().some(projectOrIds);
        }
        if (Array.isArray(projectOrIds)) {
            return projectOrIds.every(function (id) { return ((/** @type {?} */ (id))) in _this.store.entities; });
        }
        return ((/** @type {?} */ (projectOrIds))) in this.store.entities;
    };
    /**
     * Returns whether entity store has an active entity.
     */
    /**
     * Returns whether entity store has an active entity.
     * @return {?}
     */
    QueryEntity.prototype.hasActive = /**
     * Returns whether entity store has an active entity.
     * @return {?}
     */
    function () {
        return this.getSnapshot().active != null;
    };
    /**
     * @return {?}
     */
    QueryEntity.prototype.isEmpty = /**
     * @return {?}
     */
    function () {
        return this.getSnapshot().ids.length === 0;
    };
    /**
     * @param {?} id
     * @return {?}
     */
    QueryEntity.prototype._byId = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        return this.select(function (state) { return _this.getEntity(id); });
    };
    /**
     * @param {?} options
     * @return {?}
     */
    QueryEntity.prototype.sortByOptions = /**
     * @param {?} options
     * @return {?}
     */
    function (options) {
        options.sortBy = options.sortBy || (this.config && ((/** @type {?} */ (this.config.sortBy))));
        options.sortByOrder = options.sortByOrder || (this.config && this.config.sortByOrder);
    };
    /**
     * @return {?}
     */
    QueryEntity.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.memoized = null;
    };
    return QueryEntity;
}(Query));
/**
 *  An abstraction for querying the entities from the store
 * @template S, E, ActiveEntity
 */
export { QueryEntity };
if (false) {
    /** @type {?} */
    QueryEntity.prototype.store;
    /** @type {?} */
    QueryEntity.prototype.memoized;
    /**
     * Use only for internal plugins like Pagination - don't use this property *
     * @type {?}
     */
    QueryEntity.prototype.__store__;
}
/**
 * @template E, S
 * @param {?} state
 * @param {?} options
 * @return {?}
 */
function toArray(state, options) {
    /** @type {?} */
    var arr = [];
    var ids = state.ids, entities = state.entities;
    var filterBy = options.filterBy, limitTo = options.limitTo, sortBy = options.sortBy, sortByOrder = options.sortByOrder;
    var _loop_1 = function (i) {
        /** @type {?} */
        var id = ids[i];
        if (!entityExists(id, entities)) {
            return "continue";
        }
        if (!filterBy) {
            arr.push(entities[id]);
            return "continue";
        }
        if (Array.isArray(filterBy)) {
            /** @type {?} */
            var allPass = filterBy.every(function (fn) { return fn(entities[id], i); });
            if (allPass) {
                arr.push(entities[id]);
            }
        }
        else {
            if (filterBy(entities[id], i)) {
                arr.push(entities[id]);
            }
        }
    };
    for (var i = 0; i < ids.length; i++) {
        _loop_1(i);
    }
    if (sortBy) {
        /** @type {?} */
        var _sortBy_1 = isFunction(sortBy) ? sortBy : compareValues(sortBy, sortByOrder);
        arr = arr.sort(function (a, b) { return _sortBy_1(a, b, state); });
    }
    /** @type {?} */
    var length = Math.min(limitTo || arr.length, arr.length);
    return length === arr.length ? arr : arr.slice(0, length);
}
/**
 * @template E
 * @param {?} ids
 * @param {?} entities
 * @param {?} options
 * @param {?=} get
 * @return {?}
 */
function toMap(ids, entities, options, get) {
    if (get === void 0) { get = false; }
    /** @type {?} */
    var map = {};
    var filterBy = options.filterBy, limitTo = options.limitTo;
    if (get && !filterBy && !limitTo) {
        return entities;
    }
    /** @type {?} */
    var length = Math.min(limitTo || ids.length, ids.length);
    if (filterBy && isUndefined(limitTo) === false) {
        /** @type {?} */
        var count = 0;
        var _loop_2 = function (i, length_1) {
            if (count === limitTo)
                return "break";
            /** @type {?} */
            var id = ids[i];
            if (!entityExists(id, entities)) {
                return "continue";
            }
            if (Array.isArray(filterBy)) {
                /** @type {?} */
                var allPass = filterBy.every(function (fn) { return fn(entities[id], i); });
                if (allPass) {
                    map[id] = entities[id];
                    count++;
                }
            }
            else {
                if (filterBy(entities[id], i)) {
                    map[id] = entities[id];
                    count++;
                }
            }
        };
        for (var i = 0, length_1 = ids.length; i < length_1; i++) {
            var state_1 = _loop_2(i, length_1);
            if (state_1 === "break")
                break;
        }
    }
    else {
        var _loop_3 = function (i) {
            /** @type {?} */
            var id = ids[i];
            if (!entityExists(id, entities)) {
                return "continue";
            }
            if (!filterBy) {
                map[id] = entities[id];
                return "continue";
            }
            if (Array.isArray(filterBy)) {
                /** @type {?} */
                var allPass = filterBy.every(function (fn) { return fn(entities[id], i); });
                if (allPass) {
                    map[id] = entities[id];
                }
            }
            else {
                if (filterBy(entities[id], i)) {
                    map[id] = entities[id];
                }
            }
        };
        for (var i = 0; i < length; i++) {
            _loop_3(i);
        }
    }
    return map;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZW50aXR5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9xdWVyeS1lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsYUFBYSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzRSxPQUFPLEVBQUUsYUFBYSxFQUFTLE1BQU0sa0JBQWtCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXJGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQzs7Ozs7QUFJaEMsbUNBSUM7OztJQUhDLGlDQUFtQjs7SUFDbkIsaUNBQTZHOztJQUM3RyxnQ0FBaUI7Ozs7OztBQU1uQjs7Ozs7SUFBOEUsdUNBQVE7SUFPcEYscUJBQVksS0FBc0M7UUFBbEQsWUFDRSxrQkFBTSxLQUFLLENBQUMsU0FFYjtRQURDLEtBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDOztJQUN6QixDQUFDOzs7OztJQWNELCtCQUFTOzs7O0lBQVQsVUFDRSxPQUVDO1FBSEgsaUJBMkJDO1FBMUJDLHdCQUFBLEVBQUE7WUFDRSxRQUFRLEVBQUUsS0FBSztTQUNoQjs7WUFFSyxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFBLEtBQUssSUFBSSxPQUFBLEtBQUssRUFBTCxDQUFLLENBQUM7O1lBQzFDLGVBQWUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSyxDQUFDLFFBQVEsRUFBZCxDQUFjLENBQUM7UUFFNUQsSUFBSSxDQUFD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QUUsQ0FBQyxDQUFDO2lCQUN4QjthQUNGO2lCQUFNO2dCQUNMLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRTtvQkFDN0IsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDeEI7YUFDRjtRQUNILENBQUM7UUF0QkQsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUU7b0JBQXRCLENBQUM7U0FzQlQ7S0FDRjtJQUVELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGF1ZGl0VGltZSwgbWFwLCBzd2l0Y2hNYXAsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBjb21wYXJlVmFsdWVzLCBPcmRlciB9IGZyb20gJy4uL2ludGVybmFsL3NvcnQnO1xuaW1wb3J0IHsgZW50aXR5RXhpc3RzLCBpc0Z1bmN0aW9uLCBpc1VuZGVmaW5lZCwgdG9Cb29sZWFuIH0gZnJvbSAnLi4vaW50ZXJuYWwvdXRpbHMnO1xuaW1wb3J0IHsgRW50aXR5U3RvcmUgfSBmcm9tICcuL2VudGl0eS1zdG9yZSc7XG5pbXBvcnQgeyBtZW1vaXplT25lIH0gZnJvbSAnLi9tZW1vaXplJztcbmltcG9ydCB7IFF1ZXJ5IH0gZnJvbSAnLi9xdWVyeSc7XG5pbXBvcnQgeyBTb3J0QnksIFNvcnRCeU9wdGlvbnMgfSBmcm9tICcuL3F1ZXJ5LWNvbmZpZyc7XG5pbXBvcnQgeyBBY3RpdmVTdGF0ZSwgRW50aXR5U3RhdGUsIEhhc2hNYXAsIElEIH0gZnJvbSAnLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VsZWN0T3B0aW9uczxFPiBleHRlbmRzIFNvcnRCeU9wdGlvbnM8RT4ge1xuICBhc09iamVjdD86IGJvb2xlYW47XG4gIGZpbHRlckJ5PzogKChlbnRpdHk6IEUsIGluZGV4PzogbnVtYmVyKSA9PiBib29sZWFuKSB8ICgoZW50aXR5OiBFLCBpbmRleD86IG51bWJlcikgPT4gYm9vbGVhbilbXSB8IHVuZGVmaW5lZDtcbiAgbGltaXRUbz86IG51bWJlcjtcbn1cblxuLyoqXG4gKiAgQW4gYWJzdHJhY3Rpb24gZm9yIHF1ZXJ5aW5nIHRoZSBlbnRpdGllcyBmcm9tIHRoZSBzdG9yZVxuICovXG5leHBvcnQgY2xhc3MgUXVlcnlFbnRpdHk8UyBleHRlbmRzIEVudGl0eVN0YXRlLCBFLCBBY3RpdmVFbnRpdHkgPSBJRD4gZXh0ZW5kcyBRdWVyeTxTPiB7XG4gIHByb3RlY3RlZCBzdG9yZTogRW50aXR5U3RvcmU8UywgRSwgQWN0aXZlRW50aXR5PjtcbiAgcHJpdmF0ZSBtZW1vaXplZDtcblxuICAvKiogVXNlIG9ubHkgZm9yIGludGVybmFsIHBsdWdpbnMgbGlrZSBQYWdpbmF0aW9uIC0gZG9uJ3QgdXNlIHRoaXMgcHJvcGVydHkgKiovXG4gIF9fc3RvcmVfXztcblxuICBjb25zdHJ1Y3RvcihzdG9yZTogRW50aXR5U3RvcmU8UywgRSwgQWN0aXZlRW50aXR5Pikge1xuICAgIHN1cGVyKHN0b3JlKTtcbiAgICB0aGlzLl9fc3RvcmVfXyA9IHN0b3JlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgZW50aXJlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuc2VsZWN0QWxsKCk7XG4gICAqL1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgZmlsdGVyQnk/OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBPYnNlcnZhYmxlPEhhc2hNYXA8RT4+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBmaWx0ZXJCeTogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiB0cnVlOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBPYnNlcnZhYmxlPEhhc2hNYXA8RT4+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IE9ic2VydmFibGU8RVtdPjtcbiAgc2VsZWN0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IGZhbHNlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwoKTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwoXG4gICAgb3B0aW9uczogU2VsZWN0T3B0aW9uczxFPiA9IHtcbiAgICAgIGFzT2JqZWN0OiBmYWxzZVxuICAgIH1cbiAgKTogT2JzZXJ2YWJsZTxFW10gfCBIYXNoTWFwPEU+PiB7XG4gICAgY29uc3Qgc2VsZWN0U3RhdGUkID0gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUpO1xuICAgIGNvbnN0IHNlbGVjdEVudGl0aWVzJCA9IHRoaXMuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmVudGl0aWVzKTtcblxuICAgIHRoaXMuc29ydEJ5T3B0aW9ucyhvcHRpb25zKTtcblxuICAgIHJldHVybiBzZWxlY3RFbnRpdGllcyQucGlwZShcbiAgICAgIHdpdGhMYXRlc3RGcm9tKHNlbGVjdFN0YXRlJCwgKGVudGl0aWVzOiBIYXNoTWFwPEU+LCBzdGF0ZTogUykgPT4ge1xuICAgICAgICBjb25zdCB7IGlkcyB9ID0gc3RhdGU7XG4gICAgICAgIGlmIChvcHRpb25zLmFzT2JqZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIHRvTWFwKGlkcywgZW50aXRpZXMsIG9wdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmICghb3B0aW9ucy5maWx0ZXJCeSAmJiAhb3B0aW9ucy5zb3J0QnkpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5tZW1vaXplZCkge1xuICAgICAgICAgICAgICB0aGlzLm1lbW9pemVkID0gbWVtb2l6ZU9uZSh0b0FycmF5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lbW9pemVkKHN0YXRlLCBvcHRpb25zKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gdG9BcnJheShzdGF0ZSwgb3B0aW9ucyk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGVudGlyZSBzdG9yZSdzIGVudGl0eSBjb2xsZWN0aW9uLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLmdldEFsbCgpO1xuICAgKi9cbiAgZ2V0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IHRydWU7IGZpbHRlckJ5PzogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogdW5kZWZpbmVkOyBzb3J0QnlPcmRlcj86IHVuZGVmaW5lZCB9KTogSGFzaE1hcDxFPjtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgZmlsdGVyQnk6IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogRVtdO1xuICBnZXRBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogdW5kZWZpbmVkOyBzb3J0QnlPcmRlcj86IHVuZGVmaW5lZCB9KTogSGFzaE1hcDxFPjtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBFW107XG4gIGdldEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiBmYWxzZTsgZmlsdGVyQnk/OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IEVbXTtcbiAgZ2V0QWxsKCk6IEVbXTtcbiAgZ2V0QWxsKG9wdGlvbnM6IFNlbGVjdE9wdGlvbnM8RT4gPSB7IGFzT2JqZWN0OiBmYWxzZSwgZmlsdGVyQnk6IHVuZGVmaW5lZCwgbGltaXRUbzogdW5kZWZpbmVkIH0pOiBFW10gfCBIYXNoTWFwPEU+IHtcbiAgICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U25hcHNob3QoKTtcblxuICAgIGlmIChvcHRpb25zLmFzT2JqZWN0KSB7XG4gICAgICByZXR1cm4gdG9NYXAoc3RhdGUuaWRzLCBzdGF0ZS5lbnRpdGllcywgb3B0aW9ucywgdHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5zb3J0QnlPcHRpb25zKG9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHRvQXJyYXkoc3RhdGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBtdWx0aXBsZSBlbnRpdGllcyBmcm9tIHRoZSBzdG9yZS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZWxlY3RNYW55KFsxLDJdKTtcbiAgICovXG4gIHNlbGVjdE1hbnkoaWRzOiBBY3RpdmVFbnRpdHlbXSwgb3B0aW9uczogeyBmaWx0ZXJVbmRlZmluZWQ/OiBib29sZWFuIH0gPSB7fSk6IE9ic2VydmFibGU8RVtdPiB7XG4gICAgY29uc3QgZmlsdGVyVW5kZWZpbmVkID0gaXNVbmRlZmluZWQob3B0aW9ucy5maWx0ZXJVbmRlZmluZWQpID8gdHJ1ZSA6IG9wdGlvbnMuZmlsdGVyVW5kZWZpbmVkO1xuICAgIGNvbnN0IGVudGl0aWVzID0gaWRzLm1hcChpZCA9PiB0aGlzLnNlbGVjdEVudGl0eShpZCkpO1xuXG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoZW50aXRpZXMpLnBpcGUoXG4gICAgICBtYXAoZW50aXRpZXMgPT4ge1xuICAgICAgICByZXR1cm4gZmlsdGVyVW5kZWZpbmVkID8gZW50aXRpZXMuZmlsdGVyKHZhbCA9PiAhaXNVbmRlZmluZWQodmFsKSkgOiBlbnRpdGllcztcbiAgICAgIH0pLFxuICAgICAgYXVkaXRUaW1lKDApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgYW4gZW50aXR5IG9yIGEgc2xpY2Ugb2YgYW4gZW50aXR5LlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnBhZ2VzU3RvcmUuc2VsZWN0RW50aXR5KDEpXG4gICAqIHRoaXMucGFnZXNTdG9yZS5zZWxlY3RFbnRpdHkoMSwgZW50aXR5ID0+IGVudGl0eS5jb25maWcuZGF0ZSlcbiAgICpcbiAgICovXG4gIHNlbGVjdEVudGl0eTxSPihpZDogQWN0aXZlRW50aXR5KTogT2JzZXJ2YWJsZTxFPjtcbiAgc2VsZWN0RW50aXR5PFI+KGlkOiBBY3RpdmVFbnRpdHksIHByb2plY3Q6IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzZWxlY3RFbnRpdHk8Uj4oaWQ6IEFjdGl2ZUVudGl0eSwgcHJvamVjdD86IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFIgfCBFPiB7XG4gICAgaWYgKCFwcm9qZWN0KSB7XG4gICAgICByZXR1cm4gdGhpcy5fYnlJZChpZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0KHN0YXRlID0+IHtcbiAgICAgIGlmICh0aGlzLmhhc0VudGl0eShpZCkpIHtcbiAgICAgICAgcmV0dXJuIHByb2plY3QodGhpcy5nZXRFbnRpdHkoaWQpKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gZW50aXR5IGJ5IGlkXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuZ2V0RW50aXR5KDEpO1xuICAgKi9cbiAgZ2V0RW50aXR5KGlkOiBBY3RpdmVFbnRpdHkpOiBFIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmVudGl0aWVzW2lkIGFzIGFueV07XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IHRoZSBhY3RpdmUgZW50aXR5J3MgaWQuXG4gICAqL1xuICBzZWxlY3RBY3RpdmVJZCgpOiBPYnNlcnZhYmxlPEFjdGl2ZUVudGl0eT4ge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdChzdGF0ZSA9PiAoc3RhdGUgYXMgUyAmIEFjdGl2ZVN0YXRlPEFjdGl2ZUVudGl0eT4pLmFjdGl2ZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBhY3RpdmUgaWRcbiAgICovXG4gIGdldEFjdGl2ZUlkKCk6IEFjdGl2ZUVudGl0eSB7XG4gICAgcmV0dXJuICh0aGlzLmdldFNuYXBzaG90KCkgYXMgUyAmIEFjdGl2ZVN0YXRlPEFjdGl2ZUVudGl0eT4pLmFjdGl2ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIGFjdGl2ZSBlbnRpdHkuXG4gICAqL1xuICBzZWxlY3RBY3RpdmU8Uj4oKTogT2JzZXJ2YWJsZTxFPjtcbiAgc2VsZWN0QWN0aXZlPFI+KHByb2plY3Q6IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFI+O1xuICBzZWxlY3RBY3RpdmU8Uj4ocHJvamVjdD86IChlbnRpdHk6IEUpID0+IFIpOiBPYnNlcnZhYmxlPFIgfCBFPiB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0QWN0aXZlSWQoKS5waXBlKHN3aXRjaE1hcChhY3RpdmVJZCA9PiB0aGlzLnNlbGVjdEVudGl0eShhY3RpdmVJZCwgcHJvamVjdCkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFjdGl2ZSBlbnRpdHkuXG4gICAqL1xuICBnZXRBY3RpdmUoKTogRSB7XG4gICAgY29uc3QgYWN0aXZlSWQ6IEFjdGl2ZUVudGl0eSA9IHRoaXMuZ2V0QWN0aXZlSWQoKTtcbiAgICByZXR1cm4gdG9Cb29sZWFuKGFjdGl2ZUlkKSA/IHRoaXMuZ2V0RW50aXR5KGFjdGl2ZUlkKSA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24gbGVuZ3RoLlxuICAgKi9cbiAgc2VsZWN0Q291bnQocHJlZGljYXRlPzogKGVudGl0eTogRSwgaW5kZXg6IG51bWJlcikgPT4gYm9vbGVhbik6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgaWYgKGlzRnVuY3Rpb24ocHJlZGljYXRlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0QWxsKHtcbiAgICAgICAgZmlsdGVyQnk6IHByZWRpY2F0ZVxuICAgICAgfSkucGlwZShtYXAoZW50aXRpZXMgPT4gZW50aXRpZXMubGVuZ3RoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0KHN0b3JlID0+IHN0b3JlLmlkcy5sZW5ndGgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgc3RvcmUncyBlbnRpdHkgY29sbGVjdGlvbiBsZW5ndGguXG4gICAqL1xuICBnZXRDb3VudChwcmVkaWNhdGU/OiAoZW50aXR5OiBFLCBpbmRleDogbnVtYmVyKSA9PiBib29sZWFuKTogbnVtYmVyIHtcbiAgICBpZiAoaXNGdW5jdGlvbihwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRBbGwoKS5maWx0ZXIocHJlZGljYXRlKS5sZW5ndGg7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldFNuYXBzaG90KCkuaWRzLmxlbmd0aDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgZW50aXR5IGV4aXN0cy5cbiAgICovXG4gIGhhc0VudGl0eShpZDogQWN0aXZlRW50aXR5KTogYm9vbGVhbjtcbiAgaGFzRW50aXR5KGlkOiBBY3RpdmVFbnRpdHlbXSk6IGJvb2xlYW47XG4gIGhhc0VudGl0eShwcm9qZWN0OiAoZW50aXR5OiBFKSA9PiBib29sZWFuKTogYm9vbGVhbjtcbiAgaGFzRW50aXR5KHByb2plY3RPcklkczogQWN0aXZlRW50aXR5IHwgQWN0aXZlRW50aXR5W10gfCAoKGVudGl0eTogRSkgPT4gYm9vbGVhbikpOiBib29sZWFuIHtcbiAgICBpZiAoaXNGdW5jdGlvbihwcm9qZWN0T3JJZHMpKSB7XG4gICAgICByZXR1cm4gdGhpcy5nZXRBbGwoKS5zb21lKHByb2plY3RPcklkcyk7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocHJvamVjdE9ySWRzKSkge1xuICAgICAgcmV0dXJuIHByb2plY3RPcklkcy5ldmVyeShpZCA9PiAoaWQgYXMgYW55KSBpbiB0aGlzLnN0b3JlLmVudGl0aWVzKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKHByb2plY3RPcklkcyBhcyBhbnkpIGluIHRoaXMuc3RvcmUuZW50aXRpZXM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB3aGV0aGVyIGVudGl0eSBzdG9yZSBoYXMgYW4gYWN0aXZlIGVudGl0eS5cbiAgICovXG4gIGhhc0FjdGl2ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmFjdGl2ZSAhPSBudWxsO1xuICB9XG5cbiAgaXNFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRTbmFwc2hvdCgpLmlkcy5sZW5ndGggPT09IDA7XG4gIH1cblxuICBwcml2YXRlIF9ieUlkKGlkOiBBY3RpdmVFbnRpdHkpOiBPYnNlcnZhYmxlPEU+IHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gdGhpcy5nZXRFbnRpdHkoaWQpKTtcbiAgfVxuXG4gIHByaXZhdGUgc29ydEJ5T3B0aW9ucyhvcHRpb25zKSB7XG4gICAgb3B0aW9ucy5zb3J0QnkgPSBvcHRpb25zLnNvcnRCeSB8fCAodGhpcy5jb25maWcgJiYgKHRoaXMuY29uZmlnLnNvcnRCeSBhcyBTb3J0Qnk8RT4pKTtcbiAgICBvcHRpb25zLnNvcnRCeU9yZGVyID0gb3B0aW9ucy5zb3J0QnlPcmRlciB8fCAodGhpcy5jb25maWcgJiYgdGhpcy5jb25maWcuc29ydEJ5T3JkZXIpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5tZW1vaXplZCA9IG51bGw7XG4gIH1cbn1cblxuZnVuY3Rpb24gdG9BcnJheTxFLCBTIGV4dGVuZHMgRW50aXR5U3RhdGU+KHN0YXRlOiBTLCBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+KTogRVtdIHtcbiAgbGV0IGFyciA9IFtdO1xuICBjb25zdCB7IGlkcywgZW50aXRpZXMgfSA9IHN0YXRlO1xuICBjb25zdCB7IGZpbHRlckJ5LCBsaW1pdFRvLCBzb3J0QnksIHNvcnRCeU9yZGVyIH0gPSBvcHRpb25zO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgaWRzLmxlbmd0aDsgaSsrKSB7XG4gICAgY29uc3QgaWQgPSBpZHNbaV07XG5cbiAgICBpZiAoIWVudGl0eUV4aXN0cyhpZCwgZW50aXRpZXMpKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoIWZpbHRlckJ5KSB7XG4gICAgICBhcnIucHVzaChlbnRpdGllc1tpZF0pO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVyQnkpKSB7XG4gICAgICBjb25zdCBhbGxQYXNzID0gZmlsdGVyQnkuZXZlcnkoZm4gPT4gZm4oZW50aXRpZXNbaWRdLCBpKSk7XG4gICAgICBpZiAoYWxsUGFzcykge1xuICAgICAgICBhcnIucHVzaChlbnRpdGllc1tpZF0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoZmlsdGVyQnkoZW50aXRpZXNbaWRdLCBpKSkge1xuICAgICAgICBhcnIucHVzaChlbnRpdGllc1tpZF0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChzb3J0QnkpIHtcbiAgICBsZXQgX3NvcnRCeTogYW55ID0gaXNGdW5jdGlvbihzb3J0QnkpID8gc29ydEJ5IDogY29tcGFyZVZhbHVlcyhzb3J0QnksIHNvcnRCeU9yZGVyKTtcbiAgICBhcnIgPSBhcnIuc29ydCgoYSwgYikgPT4gX3NvcnRCeShhLCBiLCBzdGF0ZSkpO1xuICB9XG4gIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKGxpbWl0VG8gfHwgYXJyLmxlbmd0aCwgYXJyLmxlbmd0aCk7XG5cbiAgcmV0dXJuIGxlbmd0aCA9PT0gYXJyLmxlbmd0aCA/IGFyciA6IGFyci5zbGljZSgwLCBsZW5ndGgpO1xufVxuXG5mdW5jdGlvbiB0b01hcDxFPihpZHM6IGFueVtdLCBlbnRpdGllczogSGFzaE1hcDxFPiwgb3B0aW9uczogU2VsZWN0T3B0aW9uczxFPiwgZ2V0ID0gZmFsc2UpOiBIYXNoTWFwPEU+IHtcbiAgY29uc3QgbWFwID0ge307XG4gIGNvbnN0IHsgZmlsdGVyQnksIGxpbWl0VG8gfSA9IG9wdGlvbnM7XG5cbiAgaWYgKGdldCAmJiAhZmlsdGVyQnkgJiYgIWxpbWl0VG8pIHtcbiAgICByZXR1cm4gZW50aXRpZXM7XG4gIH1cblxuICBjb25zdCBsZW5ndGggPSBNYXRoLm1pbihsaW1pdFRvIHx8IGlkcy5sZW5ndGgsIGlkcy5sZW5ndGgpO1xuXG4gIGlmIChmaWx0ZXJCeSAmJiBpc1VuZGVmaW5lZChsaW1pdFRvKSA9PT0gZmFsc2UpIHtcbiAgICBsZXQgY291bnQgPSAwO1xuICAgIGZvciAobGV0IGkgPSAwLCBsZW5ndGggPSBpZHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgIGlmIChjb3VudCA9PT0gbGltaXRUbykgYnJlYWs7XG4gICAgICBjb25zdCBpZCA9IGlkc1tpXTtcbiAgICAgIGlmICghZW50aXR5RXhpc3RzKGlkLCBlbnRpdGllcykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeSkpIHtcbiAgICAgICAgY29uc3QgYWxsUGFzcyA9IGZpbHRlckJ5LmV2ZXJ5KGZuID0+IGZuKGVudGl0aWVzW2lkXSwgaSkpO1xuICAgICAgICBpZiAoYWxsUGFzcykge1xuICAgICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICAgICAgY291bnQrKztcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGZpbHRlckJ5KGVudGl0aWVzW2lkXSwgaSkpIHtcbiAgICAgICAgICBtYXBbaWRdID0gZW50aXRpZXNbaWRdO1xuICAgICAgICAgIGNvdW50Kys7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgaWQgPSBpZHNbaV07XG5cbiAgICAgIGlmICghZW50aXR5RXhpc3RzKGlkLCBlbnRpdGllcykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmICghZmlsdGVyQnkpIHtcbiAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZpbHRlckJ5KSkge1xuICAgICAgICBjb25zdCBhbGxQYXNzID0gZmlsdGVyQnkuZXZlcnkoZm4gPT4gZm4oZW50aXRpZXNbaWRdLCBpKSk7XG4gICAgICAgIGlmIChhbGxQYXNzKSB7XG4gICAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGZpbHRlckJ5KGVudGl0aWVzW2lkXSwgaSkpIHtcbiAgICAgICAgICBtYXBbaWRdID0gZW50aXRpZXNbaWRdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1hcDtcbn1cbiJdfQ==