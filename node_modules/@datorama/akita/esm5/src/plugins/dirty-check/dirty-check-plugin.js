/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { AkitaPlugin } from '../plugin';
import { QueryEntity } from '../../api/query-entity';
import { BehaviorSubject, Subject, combineLatest } from 'rxjs';
import { distinctUntilChanged, map, skip } from 'rxjs/operators';
import { coerceArray, isFunction, isUndefined, toBoolean } from '../../internal/utils';
import { __globalState } from '../../internal/global-state';
/** @type {?} */
export var dirtyCheckDefaultParams = {
    comparator: function (head, current) { return JSON.stringify(head) !== JSON.stringify(current); }
};
/**
 * @param {?} nestedObj
 * @param {?} path
 * @return {?}
 */
export function getNestedPath(nestedObj, path) {
    /** @type {?} */
    var pathAsArray = path.split('.');
    return pathAsArray.reduce(function (obj, key) { return (obj && obj[key] !== 'undefined' ? obj[key] : undefined); }, nestedObj);
}
/**
 * @template Entity, StoreState
 */
var /**
 * @template Entity, StoreState
 */
DirtyCheckPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(DirtyCheckPlugin, _super);
    function DirtyCheckPlugin(query, params, _entityId) {
        var _this = _super.call(this, query) || this;
        _this.query = query;
        _this.params = params;
        _this._entityId = _entityId;
        _this.dirty = new BehaviorSubject(false);
        _this.active = false;
        _this._reset = new Subject();
        _this.isDirty$ = _this.dirty.asObservable().pipe(distinctUntilChanged());
        _this.reset$ = _this._reset.asObservable();
        _this.params = tslib_1.__assign({}, dirtyCheckDefaultParams, params);
        if (_this.params.watchProperty) {
            /** @type {?} */
            var watchProp = (/** @type {?} */ (coerceArray(_this.params.watchProperty)));
            if (query instanceof QueryEntity && watchProp.includes('entities') && !watchProp.includes('ids')) {
                watchProp.push('ids');
            }
            _this.params.watchProperty = watchProp;
        }
        return _this;
    }
    /**
     * @param {?=} params
     * @return {?}
     */
    DirtyCheckPlugin.prototype.reset = /**
     * @param {?=} params
     * @return {?}
     */
    function (params) {
        if (params === void 0) { params = {}; }
        /** @type {?} */
        var currentValue = this.head;
        if (isFunction(params.updateFn)) {
            if (this.isEntityBased(this._entityId)) {
                currentValue = params.updateFn(this.head, ((/** @type {?} */ (this.getQuery()))).getEntity(this._entityId));
            }
            else {
                currentValue = params.updateFn(this.head, ((/** @type {?} */ (this.getQuery()))).getSnapshot());
            }
        }
        __globalState.setCustomAction({ type: "@DirtyCheck - Revert" });
        this.updateStore(currentValue, this._entityId);
        this._reset.next();
    };
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    DirtyCheckPlugin.prototype.setHead = /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    function () {
        if (!(/** @type {?} */ (this)).active) {
            (/** @type {?} */ (this)).activate();
            (/** @type {?} */ (this)).active = true;
        }
        else {
            (/** @type {?} */ (this)).head = (/** @type {?} */ (this))._getHead();
        }
        (/** @type {?} */ (this)).updateDirtiness(false);
        return (/** @type {?} */ (this));
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.isDirty = /**
     * @return {?}
     */
    function () {
        return toBoolean(this.dirty.value);
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.hasHead = /**
     * @return {?}
     */
    function () {
        return toBoolean(this.getHead());
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.head = null;
        this.subscription && this.subscription.unsubscribe();
        this._reset && this._reset.complete();
    };
    /**
     * @param {?} path
     * @return {?}
     */
    DirtyCheckPlugin.prototype.isPathDirty = /**
     * @param {?} path
     * @return {?}
     */
    function (path) {
        /** @type {?} */
        var head = this.getHead();
        /** @type {?} */
        var current = ((/** @type {?} */ (this.getQuery()))).getSnapshot();
        /** @type {?} */
        var currentPathValue = getNestedPath(current, path);
        /** @type {?} */
        var headPathValue = getNestedPath(head, path);
        return this.params.comparator(currentPathValue, headPathValue);
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.getHead = /**
     * @return {?}
     */
    function () {
        return this.head;
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype.activate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.head = this._getHead();
        /**
         * if we are tracking specific properties select only the relevant ones
         * @type {?}
         */
        var source = this.params.watchProperty
            ? ((/** @type {?} */ (this.params.watchProperty))).map(function (prop) {
                return _this.query.select(function (state) { return state[prop]; }).pipe(map(function (val) { return ({
                    val: val,
                    __akitaKey: prop
                }); }));
            })
            : [this.selectSource(this._entityId)];
        this.subscription = combineLatest.apply(void 0, tslib_1.__spread(source)).pipe(skip(1))
            .subscribe(function (currentState) {
            if (isUndefined(_this.head))
                return;
            /**
             * __akitaKey is used to determine if we are tracking a specific property or a store change
             * @type {?}
             */
            var isChange = currentState.some(function (state) {
                /** @type {?} */
                var head = state.__akitaKey ? _this.head[(/** @type {?} */ (state.__akitaKey))] : _this.head;
                /** @type {?} */
                var compareTo = state.__akitaKey ? state.val : state;
                return _this.params.comparator(head, compareTo);
            });
            _this.updateDirtiness(isChange);
        });
    };
    /**
     * @param {?} isDirty
     * @return {?}
     */
    DirtyCheckPlugin.prototype.updateDirtiness = /**
     * @param {?} isDirty
     * @return {?}
     */
    function (isDirty) {
        this.dirty.next(isDirty);
    };
    /**
     * @return {?}
     */
    DirtyCheckPlugin.prototype._getHead = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var head = this.getSource(this._entityId);
        if (this.params.watchProperty) {
            head = this.getWatchedValues((/** @type {?} */ (head)));
        }
        return head;
    };
    /**
     * @param {?} source
     * @return {?}
     */
    DirtyCheckPlugin.prototype.getWatchedValues = /**
     * @param {?} source
     * @return {?}
     */
    function (source) {
        return ((/** @type {?} */ (this.params.watchProperty))).reduce(function (watched, prop) {
            watched[prop] = source[prop];
            return watched;
        }, (/** @type {?} */ ({})));
    };
    return DirtyCheckPlugin;
}(AkitaPlugin));
/**
 * @template Entity, StoreState
 */
export { DirtyCheckPlugin };
if (false) {
    /** @type {?} */
    DirtyCheckPlugin.prototype.head;
    /** @type {?} */
    DirtyCheckPlugin.prototype.dirty;
    /** @type {?} */
    DirtyCheckPlugin.prototype.subscription;
    /** @type {?} */
    DirtyCheckPlugin.prototype.active;
    /** @type {?} */
    DirtyCheckPlugin.prototype._reset;
    /** @type {?} */
    DirtyCheckPlugin.prototype.isDirty$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.reset$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.query;
    /** @type {?} */
    DirtyCheckPlugin.prototype.params;
    /** @type {?} */
    DirtyCheckPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlydHktY2hlY2stcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvZGlydHktY2hlY2svZGlydHktY2hlY2stcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBVyxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFFLGVBQWUsRUFBYyxPQUFPLEVBQWdCLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUV2RixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7O0FBWTVELE1BQU0sS0FBTyx1QkFBdUIsR0FBRztJQUNyQyxVQUFVLEVBQUUsVUFBQyxJQUFJLEVBQUUsT0FBTyxJQUFLLE9BQUEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxFQUFoRCxDQUFnRDtDQUNoRjs7Ozs7O0FBRUQsTUFBTSxVQUFVLGFBQWEsQ0FBQyxTQUFTLEVBQUUsSUFBWTs7UUFDN0MsV0FBVyxHQUFhLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQzdDLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxHQUFHLElBQUssT0FBQSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFD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IGZyb20gJy4uL3BsdWdpbic7XG5pbXBvcnQgeyBRdWVyeUVudGl0eSB9IGZyb20gJy4uLy4uL2FwaS9xdWVyeS1lbnRpdHknO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24sIGNvbWJpbmVMYXRlc3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHNraXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSwgaXNGdW5jdGlvbiwgaXNVbmRlZmluZWQsIHRvQm9vbGVhbiB9IGZyb20gJy4uLy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IEVudGl0eVBhcmFtIH0gZnJvbSAnLi4vZW50aXR5LWNvbGxlY3Rpb24tcGx1Z2luJztcbmltcG9ydCB7IF9fZ2xvYmFsU3RhdGUgfSBmcm9tICcuLi8uLi9pbnRlcm5hbC9nbG9iYWwtc3RhdGUnO1xuaW1wb3J0IHsgUXVlcnkgfSBmcm9tICcuLi8uLi9hcGkvcXVlcnknO1xuXG50eXBlIEhlYWQ8U3RvcmVTdGF0ZSA9IGFueSwgRW50aXR5ID0gYW55PiA9IFN0b3JlU3RhdGUgfCBQYXJ0aWFsPFN0b3JlU3RhdGU+IHwgRW50aXR5O1xuXG5leHBvcnQgdHlwZSBEaXJ0eUNoZWNrQ29tcGFyYXRvcjxFbnRpdHk+ID0gKGhlYWQ6IEVudGl0eSwgY3VycmVudDogRW50aXR5KSA9PiBib29sZWFuO1xuXG5leHBvcnQgdHlwZSBEaXJ0eUNoZWNrUGFyYW1zPFN0b3JlU3RhdGUgPSBhbnk+ID0ge1xuICBjb21wYXJhdG9yPzogRGlydHlDaGVja0NvbXBhcmF0b3I8U3RvcmVTdGF0ZT47XG4gIHdhdGNoUHJvcGVydHk/OiBrZXlvZiBTdG9yZVN0YXRlIHwgKGtleW9mIFN0b3JlU3RhdGUpW107XG59O1xuXG5leHBvcnQgY29uc3QgZGlydHlDaGVja0RlZmF1bHRQYXJhbXMgPSB7XG4gIGNvbXBhcmF0b3I6IChoZWFkLCBjdXJyZW50KSA9PiBKU09OLnN0cmluZ2lmeShoZWFkKSAhPT0gSlNPTi5zdHJpbmdpZnkoY3VycmVudClcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXROZXN0ZWRQYXRoKG5lc3RlZE9iaiwgcGF0aDogc3RyaW5nKSB7XG4gIGNvbnN0IHBhdGhBc0FycmF5OiBzdHJpbmdbXSA9IHBhdGguc3BsaXQoJy4nKTtcbiAgcmV0dXJuIHBhdGhBc0FycmF5LnJlZHVjZSgob2JqLCBrZXkpID0+IChvYmogJiYgb2JqW2tleV0gIT09ICd1bmRlZmluZWQnID8gb2JqW2tleV0gOiB1bmRlZmluZWQpLCBuZXN0ZWRPYmopO1xufVxuXG5leHBvcnQgdHlwZSBEaXJ0eUNoZWNrUmVzZXRQYXJhbXM8U3RvcmVTdGF0ZSA9IGFueT4gPSB7XG4gIHVwZGF0ZUZuPzogU3RvcmVTdGF0ZSB8ICgoaGVhZDogU3RvcmVTdGF0ZSwgY3VycmVudDogU3RvcmVTdGF0ZSkgPT4gYW55KTtcbn07XG5cbmV4cG9ydCBjbGFzcyBEaXJ0eUNoZWNrUGx1Z2luPEVudGl0eSA9IGFueSwgU3RvcmVTdGF0ZSA9IGFueT4gZXh0ZW5kcyBBa2l0YVBsdWdpbjxFbnRpdHksIFN0b3JlU3RhdGU+IHtcbiAgcHJpdmF0ZSBoZWFkOiBIZWFkPFN0b3JlU3RhdGUsIEVudGl0eT47XG4gIHByaXZhdGUgZGlydHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBhY3RpdmUgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfcmVzZXQgPSBuZXcgU3ViamVjdCgpO1xuXG4gIGlzRGlydHkkOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpcy5kaXJ0eS5hc09ic2VydmFibGUoKS5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xuICByZXNldCQgPSB0aGlzLl9yZXNldC5hc09ic2VydmFibGUoKTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJpZXM8RW50aXR5LCBTdG9yZVN0YXRlPiwgcHJpdmF0ZSBwYXJhbXM/OiBEaXJ0eUNoZWNrUGFyYW1zLCBwcml2YXRlIF9lbnRpdHlJZD86IEVudGl0eVBhcmFtKSB7XG4gICAgc3VwZXIocXVlcnkpO1xuICAgIHRoaXMucGFyYW1zID0geyAuLi5kaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcywgLi4ucGFyYW1zIH07XG4gICAgaWYgKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkpIHtcbiAgICAgIGxldCB3YXRjaFByb3AgPSBjb2VyY2VBcnJheSh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5KSBhcyBhbnlbXTtcbiAgICAgIGlmIChxdWVyeSBpbnN0YW5jZW9mIFF1ZXJ5RW50aXR5ICYmIHdhdGNoUHJvcC5pbmNsdWRlcygnZW50aXRpZXMnKSAmJiAhd2F0Y2hQcm9wLmluY2x1ZGVzKCdpZHMnKSkge1xuICAgICAgICB3YXRjaFByb3AucHVzaCgnaWRzJyk7XG4gICAgICB9XG4gICAgICB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5ID0gd2F0Y2hQcm9wO1xuICAgIH1cbiAgfVxuXG4gIHJlc2V0KHBhcmFtczogRGlydHlDaGVja1Jlc2V0UGFyYW1zID0ge30pIHtcbiAgICBsZXQgY3VycmVudFZhbHVlID0gdGhpcy5oZWFkO1xuICAgIGlmIChpc0Z1bmN0aW9uKHBhcmFtcy51cGRhdGVGbikpIHtcbiAgICAgIGlmICh0aGlzLmlzRW50aXR5QmFzZWQodGhpcy5fZW50aXR5SWQpKSB7XG4gICAgICAgIGN1cnJlbnRWYWx1ZSA9IHBhcmFtcy51cGRhdGVGbih0aGlzLmhlYWQsICh0aGlzLmdldFF1ZXJ5KCkgYXMgUXVlcnlFbnRpdHk8U3RvcmVTdGF0ZSwgRW50aXR5PikuZ2V0RW50aXR5KHRoaXMuX2VudGl0eUlkKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjdXJyZW50VmFsdWUgPSBwYXJhbXMudXBkYXRlRm4odGhpcy5oZWFkLCAodGhpcy5nZXRRdWVyeSgpIGFzIFF1ZXJ5PFN0b3JlU3RhdGU+KS5nZXRTbmFwc2hvdCgpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgX19nbG9iYWxTdGF0ZS5zZXRDdXN0b21BY3Rpb24oeyB0eXBlOiBgQERpcnR5Q2hlY2sgLSBSZXZlcnRgIH0pO1xuICAgIHRoaXMudXBkYXRlU3RvcmUoY3VycmVudFZhbHVlLCB0aGlzLl9lbnRpdHlJZCk7XG4gICAgdGhpcy5fcmVzZXQubmV4dCgpO1xuICB9XG5cbiAgc2V0SGVhZCgpIHtcbiAgICBpZiAoIXRoaXMuYWN0aXZlKSB7XG4gICAgICB0aGlzLmFjdGl2YXRlKCk7XG4gICAgICB0aGlzLmFjdGl2ZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaGVhZCA9IHRoaXMuX2dldEhlYWQoKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVEaXJ0aW5lc3MoZmFsc2UpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgaXNEaXJ0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdG9Cb29sZWFuKHRoaXMuZGlydHkudmFsdWUpO1xuICB9XG5cbiAgaGFzSGVhZCgpIHtcbiAgICByZXR1cm4gdG9Cb29sZWFuKHRoaXMuZ2V0SGVhZCgpKTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5oZWFkID0gbnVsbDtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiAmJiB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMuX3Jlc2V0ICYmIHRoaXMuX3Jlc2V0LmNvbXBsZXRlKCk7XG4gIH1cblxuICBpc1BhdGhEaXJ0eShwYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBoZWFkID0gdGhpcy5nZXRIZWFkKCk7XG4gICAgY29uc3QgY3VycmVudCA9ICh0aGlzLmdldFF1ZXJ5KCkgYXMgUXVlcnk8U3RvcmVTdGF0ZT4pLmdldFNuYXBzaG90KCk7XG4gICAgY29uc3QgY3VycmVudFBhdGhWYWx1ZSA9IGdldE5lc3RlZFBhdGgoY3VycmVudCwgcGF0aCk7XG4gICAgY29uc3QgaGVhZFBhdGhWYWx1ZSA9IGdldE5lc3RlZFBhdGgoaGVhZCwgcGF0aCk7XG5cbiAgICByZXR1cm4gdGhpcy5wYXJhbXMuY29tcGFyYXRvcihjdXJyZW50UGF0aFZhbHVlLCBoZWFkUGF0aFZhbHVlKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRIZWFkKCkge1xuICAgIHJldHVybiB0aGlzLmhlYWQ7XG4gIH1cblxuICBwcml2YXRlIGFjdGl2YXRlKCkge1xuICAgIHRoaXMuaGVhZCA9IHRoaXMuX2dldEhlYWQoKTtcbiAgICAvKiogaWYgd2UgYXJlIHRyYWNraW5nIHNwZWNpZmljIHByb3BlcnRpZXMgc2VsZWN0IG9ubHkgdGhlIHJlbGV2YW50IG9uZXMgKi9cbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5XG4gICAgICA/ICh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5IGFzIChrZXlvZiBTdG9yZVN0YXRlKVtdKS5tYXAocHJvcCA9PlxuICAgICAgICAgIHRoaXMucXVlcnkuc2VsZWN0KHN0YXRlID0+IHN0YXRlW3Byb3BdKS5waXBlKFxuICAgICAgICAgICAgbWFwKHZhbCA9PiAoe1xuICAgICAgICAgICAgICB2YWwsXG4gICAgICAgICAgICAgIF9fYWtpdGFLZXk6IHByb3BcbiAgICAgICAgICAgIH0pKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgOiBbdGhpcy5zZWxlY3RTb3VyY2UodGhpcy5fZW50aXR5SWQpXTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IGNvbWJpbmVMYXRlc3QoLi4uc291cmNlKVxuICAgICAgLnBpcGUoc2tpcCgxKSlcbiAgICAgIC5zdWJzY3JpYmUoKGN1cnJlbnRTdGF0ZTogYW55W10pID0+IHtcbiAgICAgICAgaWYgKGlzVW5kZWZpbmVkKHRoaXMuaGVhZCkpIHJldHVybjtcbiAgICAgICAgLyoqIF9fYWtpdGFLZXkgaXMgdXNlZCB0byBkZXRlcm1pbmUgaWYgd2UgYXJlIHRyYWNraW5nIGEgc3BlY2lmaWMgcHJvcGVydHkgb3IgYSBzdG9yZSBjaGFuZ2UgKi9cbiAgICAgICAgY29uc3QgaXNDaGFuZ2UgPSBjdXJyZW50U3RhdGUuc29tZShzdGF0ZSA9PiB7XG4gICAgICAgICAgY29uc3QgaGVhZCA9IHN0YXRlLl9fYWtpdGFLZXkgPyB0aGlzLmhlYWRbc3RhdGUuX19ha2l0YUtleSBhcyBhbnldIDogdGhpcy5oZWFkO1xuICAgICAgICAgIGNvbnN0IGNvbXBhcmVUbyA9IHN0YXRlLl9fYWtpdGFLZXkgPyBzdGF0ZS52YWwgOiBzdGF0ZTtcblxuICAgICAgICAgIHJldHVybiB0aGlzLnBhcmFtcy5jb21wYXJhdG9yKGhlYWQsIGNvbXBhcmVUbyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudXBkYXRlRGlydGluZXNzKGlzQ2hhbmdlKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVEaXJ0aW5lc3MoaXNEaXJ0eTogYm9vbGVhbikge1xuICAgIHRoaXMuZGlydHkubmV4dChpc0RpcnR5KTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEhlYWQoKTogSGVhZDxTdG9yZVN0YXRlLCBFbnRpdHk+IHtcbiAgICBsZXQgaGVhZDogSGVhZDxTdG9yZVN0YXRlLCBFbnRpdHk+ID0gdGhpcy5nZXRTb3VyY2UodGhpcy5fZW50aXR5SWQpO1xuICAgIGlmICh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5KSB7XG4gICAgICBoZWFkID0gdGhpcy5nZXRXYXRjaGVkVmFsdWVzKGhlYWQgYXMgU3RvcmVTdGF0ZSk7XG4gICAgfVxuICAgIHJldHVybiBoZWFkO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRXYXRjaGVkVmFsdWVzKHNvdXJjZTogU3RvcmVTdGF0ZSk6IFBhcnRpYWw8U3RvcmVTdGF0ZT4ge1xuICAgIHJldHVybiAodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSBhcyAoa2V5b2YgU3RvcmVTdGF0ZSlbXSkucmVkdWNlKFxuICAgICAgKHdhdGNoZWQsIHByb3ApID0+IHtcbiAgICAgICAgd2F0Y2hlZFtwcm9wXSA9IHNvdXJjZVtwcm9wXTtcbiAgICAgICAgcmV0dXJuIHdhdGNoZWQ7XG4gICAgICB9LFxuICAgICAge30gYXMgUGFydGlhbDxTdG9yZVN0YXRlPlxuICAgICk7XG4gIH1cbn1cbiJdfQ==