/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { dirtyCheckDefaultParams, DirtyCheckPlugin, getNestedPath } from './dirty-check-plugin';
import { EntityCollectionPlugin } from '../entity-collection-plugin';
import { map, skip } from 'rxjs/operators';
/**
 * @template E, P
 */
var /**
 * @template E, P
 */
EntityDirtyCheckPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(EntityDirtyCheckPlugin, _super);
    function EntityDirtyCheckPlugin(query, params) {
        if (params === void 0) { params = {}; }
        var _this = _super.call(this, query, params.entityIds) || this;
        _this.query = query;
        _this.params = params;
        /**
         * @deprecated Use someDirty$ instead
         */
        _this.isSomeDirty$ = _this.query.select(function (state) { return state.entities; }).pipe(map(function (entities) { return _this.checkSomeDirty(entities); }));
        _this.someDirty$ = _this.isSomeDirty$;
        _this.someDirty = _this.isSomeDirty;
        _this.params = tslib_1.__assign({}, dirtyCheckDefaultParams, params);
        _this.activate();
        _this.selectIds()
            .pipe(skip(1))
            .subscribe(function (ids) {
            _this.rebase(ids, { afterAdd: function (plugin) { return plugin.setHead(); } });
        });
        return _this;
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?=} ids
     * @return {THIS}
     */
    EntityDirtyCheckPlugin.prototype.setHead = /**
     * @template THIS
     * @this {THIS}
     * @param {?=} ids
     * @return {THIS}
     */
    function (ids) {
        (/** @type {?} */ (this)).forEachId(ids, function (e) { return e.setHead(); });
        return (/** @type {?} */ (this));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.hasHead = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        if (this.entities.has(id)) {
            /** @type {?} */
            var entity = this.getEntity(id);
            return entity.hasHead();
        }
        return false;
    };
    /**
     * @param {?=} ids
     * @param {?=} params
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.reset = /**
     * @param {?=} ids
     * @param {?=} params
     * @return {?}
     */
    function (ids, params) {
        if (params === void 0) { params = {}; }
        this.forEachId(ids, function (e) { return e.reset(params); });
    };
    /**
     * @param {?} id
     * @param {?=} asObservable
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.isDirty = /**
     * @param {?} id
     * @param {?=} asObservable
     * @return {?}
     */
    function (id, asObservable) {
        if (asObservable === void 0) { asObservable = true; }
        if (this.entities.has(id)) {
            /** @type {?} */
            var entity = this.getEntity(id);
            return asObservable ? entity.isDirty$ : entity.isDirty();
        }
        return false;
    };
    /**
     * @deprecated Use someDirty() instead
     */
    /**
     * @deprecated Use someDirty() instead
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.isSomeDirty = /**
     * @deprecated Use someDirty() instead
     * @return {?}
     */
    function () {
        /** @type {?} */
        var entities = this.query.getAll({ asObject: true });
        return this.checkSomeDirty(entities);
    };
    /**
     * @param {?} id
     * @param {?} path
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.isPathDirty = /**
     * @param {?} id
     * @param {?} path
     * @return {?}
     */
    function (id, path) {
        if (this.entities.has(id)) {
            /** @type {?} */
            var head = ((/** @type {?} */ (this.getEntity(id)))).getHead();
            /** @type {?} */
            var current = this.query.getEntity(id);
            /** @type {?} */
            var currentPathValue = getNestedPath(current, path);
            /** @type {?} */
            var headPathValue = getNestedPath(head, path);
            return this.params.comparator(currentPathValue, headPathValue);
        }
        return null;
    };
    /**
     * @param {?=} ids
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.destroy = /**
     * @param {?=} ids
     * @return {?}
     */
    function (ids) {
        this.forEachId(ids, function (e) { return e.destroy(); });
    };
    /**
     * @param {?} id
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.instantiatePlugin = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        return (/** @type {?} */ (new DirtyCheckPlugin(this.query, this.params, id)));
    };
    /**
     * @param {?} entities
     * @return {?}
     */
    EntityDirtyCheckPlugin.prototype.checkSomeDirty = /**
     * @param {?} entities
     * @return {?}
     */
    function (entities) {
        var e_1, _a;
        /** @type {?} */
        var entitiesIds = this.resolvedIds();
        try {
            for (var entitiesIds_1 = tslib_1.__values(entitiesIds), entitiesIds_1_1 = entitiesIds_1.next(); !entitiesIds_1_1.done; entitiesIds_1_1 = entitiesIds_1.next()) {
                var id = entitiesIds_1_1.value;
                /** @type {?} */
                var dirty = this.params.comparator(((/** @type {?} */ (this.getEntity(id)))).getHead(), entities[id]);
                if (dirty) {
                    return true;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (entitiesIds_1_1 && !entitiesIds_1_1.done && (_a = entitiesIds_1.return)) _a.call(entitiesIds_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return false;
    };
    return EntityDirtyCheckPlugin;
}(EntityCollectionPlugin));
/**
 * @template E, P
 */
export { EntityDirtyCheckPlugin };
if (false) {
    /**
     * @deprecated Use someDirty$ instead
     * @type {?}
     */
    EntityDirtyCheckPlugin.prototype.isSomeDirty$;
    /** @type {?} */
    EntityDirtyCheckPlugin.prototype.someDirty$;
    /** @type {?} */
    EntityDirtyCheckPlugin.prototype.someDirty;
    /** @type {?} */
    EntityDirtyCheckPlugin.prototype.query;
    /** @type {?} */
    EntityDirtyCheckPlugin.prototype.params;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWRpcnR5LWNoZWNrLXBsdWdpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL2RpcnR5LWNoZWNrL2VudGl0eS1kaXJ0eS1jaGVjay1wbHVnaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLGdCQUFnQixFQUVoQixhQUFhLEVBQ2QsTUFBTSxzQkFBc0IsQ0FBQztBQUU5QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBUTNDOzs7O0lBQThHLGtEQUE0QjtJQVN4SSxnQ0FBc0IsS0FBMEIsRUFBbUIsTUFBMEM7UUFBMUMsdUJBQUEsRUFBQSxXQUEwQztRQUE3RyxZQUNFLGtCQUFNLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLFNBUS9CO1FBVHFCLFdBQUssR0FBTCxLQUFLLENBQXFCO1FBQW1CLFlBQU0sR0FBTixNQUFNLENBQW9DOzs7O1FBTDdHLGtCQUFZLEdBQXdCLEtBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSyxDQUFDLFFBQVEsRUFBZCxDQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQUMsUUFBYSxJQUFLLE9BQUEsS0FBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsRUFBN0IsQ0FBNkIsQ0FBQyxDQUFDLENBQUM7UUFFM0ksZ0JBQVUsR0FBRyxLQUFJLENBQUMsWUFBWSxDQUFDO1FBQy9CLGVBQVMsR0FBRyxLQUFJLENBQUMsV0FBVyxDQUFDO1FBSTNCLEtBQUksQ0FBQyxNQUFNLHdCQUFRLHVCQUF1QixFQUFLLE1BQU0sQ0FBRSxDQUFDO1FBQ3hELEtBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNo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LElBQUksT0FBQSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQVgsQ0FBVyxDQUFDLENBQUM7SUFDeEMsQ0FBQzs7Ozs7SUFFUyxrREFBaUI7Ozs7SUFBM0IsVUFBNEIsRUFBTTtRQUNoQyxPQUFPLG1CQUFBLElBQUksZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxFQUFLLENBQUM7SUFDaEUsQ0FBQzs7Ozs7SUFFTywrQ0FBYzs7OztJQUF0QixVQUF1QixRQUFvQjs7O1lBQ25DLFdBQVcsR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFOztZQUN0QyxLQUFpQixJQUFBLGdCQUFBLGlCQUFBLFdBQVcsQ0FBQSx3Q0FBQSxpRUFBRTtnQkFBekIsSUFBTSxFQUFFLHdCQUFBOztvQkFDTCxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxtQkFBQSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3pGLElBQUksS0FBSyxFQUFFO29CQUNULE9BQU8sSUFBSSxDQUFDO2lCQUNiO2FBQ0Y7Ozs7Ozs7OztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUNILDZCQUFDO0FBQUQsQ0FBQyxBQXpGRCxDQUE4RyxzQkFBc0IsR0F5Rm5JOzs7Ozs7Ozs7O0lBckZDLDhDQUEySTs7SUFFM0ksNENBQStCOztJQUMvQiwyQ0FBNkI7O0lBRWpCLHVDQUFvQzs7SUFBRSx3Q0FBMkQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYXNoTWFwLCBJRCwgSURTIH0gZnJvbSAnLi4vLi4vYXBpL3R5cGVzJztcbmltcG9ydCB7XG4gIERpcnR5Q2hlY2tDb21wYXJhdG9yLFxuICBkaXJ0eUNoZWNrRGVmYXVsdFBhcmFtcyxcbiAgRGlydHlDaGVja1BsdWdpbixcbiAgRGlydHlDaGVja1Jlc2V0UGFyYW1zLFxuICBnZXROZXN0ZWRQYXRoXG59IGZyb20gJy4vZGlydHktY2hlY2stcGx1Z2luJztcbmltcG9ydCB7IFF1ZXJ5RW50aXR5IH0gZnJvbSAnLi4vLi4vYXBpL3F1ZXJ5LWVudGl0eSc7XG5pbXBvcnQgeyBFbnRpdHlDb2xsZWN0aW9uUGx1Z2luIH0gZnJvbSAnLi4vZW50aXR5LWNvbGxlY3Rpb24tcGx1Z2luJztcbmltcG9ydCB7IG1hcCwgc2tpcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja0NvbGxlY3Rpb25QYXJhbXM8RT4gPSB7XG4gIGNvbXBhcmF0b3I/OiBEaXJ0eUNoZWNrQ29tcGFyYXRvcjxFPjtcbiAgZW50aXR5SWRzPzogSUQgfCBJRFtdO1xufTtcblxuZXhwb3J0IGNsYXNzIEVudGl0eURpcnR5Q2hlY2tQbHVnaW48RSwgUCBleHRlbmRzIERpcnR5Q2hlY2tQbHVnaW48RSwgYW55PiA9IERpcnR5Q2hlY2tQbHVnaW48RSwgYW55Pj4gZXh0ZW5kcyBFbnRpdHlDb2xsZWN0aW9uUGx1Z2luPEUsIFA+IHtcbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIFVzZSBzb21lRGlydHkkIGluc3RlYWRcbiAgICovXG4gIGlzU29tZURpcnR5JDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMucXVlcnkuc2VsZWN0KHN0YXRlID0+IHN0YXRlLmVudGl0aWVzKS5waXBlKG1hcCgoZW50aXRpZXM6IGFueSkgPT4gdGhpcy5jaGVja1NvbWVEaXJ0eShlbnRpdGllcykpKTtcblxuICBzb21lRGlydHkkID0gdGhpcy5pc1NvbWVEaXJ0eSQ7XG4gIHNvbWVEaXJ0eSA9IHRoaXMuaXNTb21lRGlydHk7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyeUVudGl0eTxhbnksIEU+LCBwcml2YXRlIHJlYWRvbmx5IHBhcmFtczogRGlydHlDaGVja0NvbGxlY3Rpb25QYXJhbXM8RT4gPSB7fSkge1xuICAgIHN1cGVyKHF1ZXJ5LCBwYXJhbXMuZW50aXR5SWRzKTtcbiAgICB0aGlzLnBhcmFtcyA9IHsgLi4uZGlydHlDaGVja0RlZmF1bHRQYXJhbXMsIC4uLnBhcmFtcyB9O1xuICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgICB0aGlzLnNlbGVjdElkcygpXG4gICAgICAucGlwZShza2lwKDEpKVxuICAgICAgLnN1YnNjcmliZShpZHMgPT4ge1xuICAgICAgICB0aGlzLnJlYmFzZShpZHMsIHsgYWZ0ZXJBZGQ6IHBsdWdpbiA9PiBwbHVnaW4uc2V0SGVhZCgpIH0pO1xuICAgICAgfSk7XG4gIH1cblxuICBzZXRIZWFkKGlkcz86IElEUykge1xuICAgIHRoaXMuZm9yRWFjaElkKGlkcywgZSA9PiBlLnNldEhlYWQoKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBoYXNIZWFkKGlkOiBJRCk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLmVudGl0aWVzLmhhcyhpZCkpIHtcbiAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5KGlkKTtcbiAgICAgIHJldHVybiBlbnRpdHkuaGFzSGVhZCgpO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJlc2V0KGlkcz86IElEUywgcGFyYW1zOiBEaXJ0eUNoZWNrUmVzZXRQYXJhbXMgPSB7fSkge1xuICAgIHRoaXMuZm9yRWFjaElkKGlkcywgZSA9PiBlLnJlc2V0KHBhcmFtcykpO1xuICB9XG5cbiAgaXNEaXJ0eShpZDogSUQpOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBpc0RpcnR5KGlkOiBJRCwgYXNPYnNlcnZhYmxlOiB0cnVlKTogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgaXNEaXJ0eShpZDogSUQsIGFzT2JzZXJ2YWJsZTogZmFsc2UpOiBib29sZWFuO1xuICBpc0RpcnR5KGlkOiBJRCwgYXNPYnNlcnZhYmxlID0gdHJ1ZSk6IE9ic2VydmFibGU8Ym9vbGVhbj4gfCBib29sZWFuIHtcbiAgICBpZiAodGhpcy5lbnRpdGllcy5oYXMoaWQpKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmdldEVudGl0eShpZCk7XG4gICAgICByZXR1cm4gYXNPYnNlcnZhYmxlID8gZW50aXR5LmlzRGlydHkkIDogZW50aXR5LmlzRGlydHkoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgVXNlIHNvbWVEaXJ0eSgpIGluc3RlYWRcbiAgICovXG4gIGlzU29tZURpcnR5KCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5xdWVyeS5nZXRBbGwoeyBhc09iamVjdDogdHJ1ZSB9KTtcbiAgICByZXR1cm4gdGhpcy5jaGVja1NvbWVEaXJ0eShlbnRpdGllcyk7XG4gIH1cblxuICBpc1BhdGhEaXJ0eShpZDogSUQsIHBhdGg6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmVudGl0aWVzLmhhcyhpZCkpIHtcbiAgICAgIGNvbnN0IGhlYWQgPSAodGhpcy5nZXRFbnRpdHkoaWQpIGFzIGFueSkuZ2V0SGVhZCgpO1xuICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMucXVlcnkuZ2V0RW50aXR5KGlkKTtcbiAgICAgIGNvbnN0IGN1cnJlbnRQYXRoVmFsdWUgPSBnZXROZXN0ZWRQYXRoKGN1cnJlbnQsIHBhdGgpO1xuICAgICAgY29uc3QgaGVhZFBhdGhWYWx1ZSA9IGdldE5lc3RlZFBhdGgoaGVhZCwgcGF0aCk7XG5cbiAgICAgIHJldHVybiB0aGlzLnBhcmFtcy5jb21wYXJhdG9yKGN1cnJlbnRQYXRoVmFsdWUsIGhlYWRQYXRoVmFsdWUpO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZGVzdHJveShpZHM/OiBJRFMpIHtcbiAgICB0aGlzLmZvckVhY2hJZChpZHMsIGUgPT4gZS5kZXN0cm95KCkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGluc3RhbnRpYXRlUGx1Z2luKGlkOiBJRCk6IFAge1xuICAgIHJldHVybiBuZXcgRGlydHlDaGVja1BsdWdpbih0aGlzLnF1ZXJ5LCB0aGlzLnBhcmFtcywgaWQpIGFzIFA7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrU29tZURpcnR5KGVudGl0aWVzOiBIYXNoTWFwPEU+KTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50aXRpZXNJZHMgPSB0aGlzLnJlc29sdmVkSWRzKCk7XG4gICAgZm9yIChjb25zdCBpZCBvZiBlbnRpdGllc0lkcykge1xuICAgICAgY29uc3QgZGlydHkgPSB0aGlzLnBhcmFtcy5jb21wYXJhdG9yKCh0aGlzLmdldEVudGl0eShpZCkgYXMgYW55KS5nZXRIZWFkKCksIGVudGl0aWVzW2lkXSk7XG4gICAgICBpZiAoZGlydHkpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuIl19