/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { AkitaPlugin } from '../plugin';
import { debounceTime } from 'rxjs/operators';
import { __globalState } from '../../internal/global-state';
import { getValue, isString, setValue, toBoolean } from '../../internal/utils';
// Todo: Return  AbstractControl interface
/**
 * @template T
 */
var 
// Todo: Return  AbstractControl interface
/**
 * @template T
 */
PersistNgFormPlugin = /** @class */ (function (_super) {
    tslib_1.__extends(PersistNgFormPlugin, _super);
    function PersistNgFormPlugin(query, factoryFnOrPath, params) {
        if (params === void 0) { params = {}; }
        var _this = _super.call(this, query) || this;
        _this.query = query;
        _this.factoryFnOrPath = factoryFnOrPath;
        _this.params = params;
        _this.params = tslib_1.__assign({ debounceTime: 300, formKey: 'akitaForm', emitEvent: false, arrControlFactory: function (v) { return _this.builder.control(v); } }, params);
        _this.isRootKeys = toBoolean(factoryFnOrPath) === false;
        _this.isKeyBased = isString(factoryFnOrPath) || _this.isRootKeys;
        return _this;
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} form
     * @param {?=} builder
     * @return {THIS}
     */
    PersistNgFormPlugin.prototype.setForm = /**
     * @template THIS
     * @this {THIS}
     * @param {?} form
     * @param {?=} builder
     * @return {THIS}
     */
    function (form, builder) {
        (/** @type {?} */ (this)).form = form;
        (/** @type {?} */ (this)).builder = builder;
        (/** @type {?} */ (this)).activate();
        return (/** @type {?} */ (this));
    };
    /**
     * @param {?=} initialState
     * @return {?}
     */
    PersistNgFormPlugin.prototype.reset = /**
     * @param {?=} initialState
     * @return {?}
     */
    function (initialState) {
        var _this = this;
        var _a;
        /** @type {?} */
        var value;
        if (initialState) {
            value = initialState;
        }
        else {
            value = this.isKeyBased ? this.initialValue : ((/** @type {?} */ (this))).factoryFnOrPath();
        }
        if (this.isKeyBased) {
            Object.keys(this.initialValue).forEach(function (stateKey) {
                /** @type {?} */
                var value = _this.initialValue[stateKey];
                if (Array.isArray(value) && _this.builder) {
                    /** @type {?} */
                    var formArray = _this.form.controls[stateKey];
                    _this.cleanArray(formArray);
                    value.forEach(function (v, i) {
                        _this.form.get(stateKey).insert(i, ((/** @type {?} */ (_this.params.arrControlFactory)))(v));
                    });
                }
            });
        }
        this.form.patchValue(value, { emitEvent: this.params.emitEvent });
        /** @type {?} */
        var storeValue = this.isKeyBased ? setValue(this.getQuery().getSnapshot(), this.getStore().storeName + "." + this.factoryFnOrPath, value) : (_a = {}, _a[this.params.formKey] = value, _a);
        this.updateStore(storeValue);
    };
    /**
     * @param {?} control
     * @return {?}
     */
    PersistNgFormPlugin.prototype.cleanArray = /**
     * @param {?} control
     * @return {?}
     */
    function (control) {
        while (control.length !== 0) {
            control.removeAt(0);
        }
    };
    /**
     * @param {?} formValue
     * @param {?} root
     * @return {?}
     */
    PersistNgFormPlugin.prototype.resolveInitialValue = /**
     * @param {?} formValue
     * @param {?} root
     * @return {?}
     */
    function (formValue, root) {
        var _this = this;
        if (!formValue)
            return;
        return Object.keys(formValue).reduce(function (acc, stateKey) {
            /** @type {?} */
            var value = root[stateKey];
            if (Array.isArray(value) && _this.builder) {
                /** @type {?} */
                var factory_1 = _this.params.arrControlFactory;
                _this.cleanArray(_this.form.get(stateKey));
                value.forEach(function (v, i) {
                    _this.form.get(stateKey).insert(i, ((/** @type {?} */ (factory_1)))(v));
                });
            }
            acc[stateKey] = root[stateKey];
            return acc;
        }, {});
    };
    /**
     * @return {?}
     */
    PersistNgFormPlugin.prototype.activate = /**
     * @return {?}
     */
    function () {
        var _this = this;
        var _a;
        /** @type {?} */
        var path;
        if (this.isKeyBased) {
            if (this.isRootKeys) {
                this.initialValue = this.resolveInitialValue(this.form.value, this.getQuery().getSnapshot());
                this.form.patchValue(this.initialValue, { emitEvent: this.params.emitEvent });
            }
            else {
                path = this.getStore().storeName + "." + this.factoryFnOrPath;
                /** @type {?} */
                var root = getValue(this.getQuery().getSnapshot(), path);
                this.initialValue = this.resolveInitialValue(root, root);
                this.form.patchValue(this.initialValue, { emitEvent: this.params.emitEvent });
            }
        }
        else {
            if (!((/** @type {?} */ (this.getQuery().getSnapshot())))[this.params.formKey]) {
                __globalState.setAction({ type: '@PersistNgFormPlugin activate' });
                this.updateStore((_a = {}, _a[this.params.formKey] = ((/** @type {?} */ (this))).factoryFnOrPath(), _a));
            }
            /** @type {?} */
            var value = this.getQuery().getSnapshot()[this.params.formKey];
            this.form.patchValue(value);
        }
        this.formChanges = this.form.valueChanges.pipe(debounceTime(this.params.debounceTime)).subscribe(function (value) {
            __globalState.setAction({ type: '@PersistForm - Update' });
            /** @type {?} */
            var newState;
            if (_this.isKeyBased) {
                if (_this.isRootKeys) {
                    newState = function (state) { return (tslib_1.__assign({}, state, value)); };
                }
                else {
                    newState = function (state) { return setValue(state, path, value); };
                }
            }
            else {
                newState = function () {
                    var _a;
                    return (_a = {}, _a[_this.params.formKey] = value, _a);
                };
            }
            _this.updateStore(newState(_this.getQuery().getSnapshot()));
        });
    };
    /**
     * @return {?}
     */
    PersistNgFormPlugin.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.formChanges && this.formChanges.unsubscribe();
        this.form = null;
        this.builder = null;
    };
    return PersistNgFormPlugin;
}(AkitaPlugin));
// Todo: Return  AbstractControl interface
/**
 * @template T
 */
export { PersistNgFormPlugin };
if (false) {
    /** @type {?} */
    PersistNgFormPlugin.prototype.formChanges;
    /** @type {?} */
    PersistNgFormPlugin.prototype.isRootKeys;
    /** @type {?} */
    PersistNgFormPlugin.prototype.form;
    /** @type {?} */
    PersistNgFormPlugin.prototype.isKeyBased;
    /** @type {?} */
    PersistNgFormPlugin.prototype.initialValue;
    /** @type {?} */
    PersistNgFormPlugin.prototype.builder;
    /** @type {?} */
    PersistNgFormPlugin.prototype.query;
    /** @type {?} */
    PersistNgFormPlugin.prototype.factoryFnOrPath;
    /** @type {?} */
    PersistNgFormPlugin.prototype.params;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdC1uZy1mb3JtLXBsdWdpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3BlcnNpc3QtZm9ybS9wZXJzaXN0LW5nLWZvcm0tcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd4QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7Ozs7QUF3Qi9FOzs7Ozs7SUFBa0QsK0NBQVc7SUFRM0QsNkJBQXNCLEtBQWlCLEVBQVUsZUFBbUMsRUFBVSxNQUE4QjtRQUE5Qix1QkFBQSxFQUFBLFdBQThCO1FBQTVILFlBQ0Usa0JBQU0sS0FBSyxDQUFDLFNBSWI7UUFMcUIsV0FBSyxHQUFMLEtBQUssQ0FBWTtRQUFVLHFCQUFlLEdBQWYsZUFBZSxDQUFvQjtRQUFVLFlBQU0sR0FBTixNQUFNLENBQXdCO1FBRTFILEtBQUksQ0FBQyxNQUFNLG9CQUFRLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsaUJBQWlCLEVBQUUsVUFBQSxDQUFDLElBQUksT0FBQSxLQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBdkIsQ0FBdUIsRUFBRSxFQUFLLE1BQU0sQ0FBRSxDQUFDO1FBQy9JLEtBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEtBQUssQ0FBQztRQUN2RCxLQUFJLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxlQUFlLENBQUMsSUFBSSxLQUFJLENBQUMsVUFBVSxDQUFDOztJQUNqRSxDQUFDOzs7Ozs7OztJQUVELHFDQUFPOzs7Ozs7O0lBQVAsVUFBUSxJQUFtQixFQUFFLE9BQVE7UUFDbkMsbUJBQUEsSUFBSSxFQUFBLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixtQkFBQSxJQUFJLEVBQUEsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLG1CQUFBLElBQUksRUFBQSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sbUJBQUEsSUFBSSxFQUFBLENBQUM7SUFDZCxDQUFDOzs7OztJQUVELG1DQUFLOzs7O0lBQUwsVUFBTSxZQUFnQjtRQUF0QixpQkF3QkM7OztZQXZCSyxLQUFLO1FBQ1QsSUFBSSxZQUFZLEVBQUU7WUFDaEIsS0FBSyxHQUFHLFlBQVksQ0FBQztTQUN0QjthQUFNO1lBQ0wsS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQUEsSUFBSSxFQUFPLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUMvRTtRQUVELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxRQUFROztvQkFDdkMsS0FBSyxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO2dCQUN6QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSSxDQUFDLE9BQU8sRUFBRTs7d0JBQ2xDLFNBQVMsR0FBRyxLQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7b0JBQzlDLEtBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQzNCLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQzt3QkFDakIsS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLG1CQUFBLEtBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3BGLENBQUMsQ0FBQyxDQUFDO2lCQUNKO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7O1lBRTVELFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFLLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxTQUFTLFNBQUksSUFBSSxDQUFDLGVBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFHLEdBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUcsS0FBSyxLQUFFO1FBQzlLLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDL0IsQ0FBQzs7Ozs7SUFFTyx3Q0FBVTs7OztJQUFsQixVQUFtQixPQUFPO1FBQ3hCLE9BQU8sT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDM0IsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNyQjtJQUNILENBQUM7Ozs7OztJQUVPLGlEQUFtQjs7Ozs7SUFBM0IsVUFBNEIsU0FBUyxFQUFFLElBQUk7UUFBM0MsaUJBY0M7UUFiQyxJQUFJLENBQUMsU0FBUztZQUFFLE9BQU87UUFDdkIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxRQUFROztnQkFDM0MsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDNUIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUksQ0FBQyxPQUFPLEVBQUU7O29CQUNsQyxTQUFPLEdBQUcsS0FBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUI7Z0JBQzdDLEtBQUksQ0FBQyxVQUFVLENBQUMsS0FBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDekMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO29CQUNqQixLQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsbUJBQUEsU0FBTyxFQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5RCxDQUFDLENBQUMsQ0FBQzthQUNKO1lBQ0QsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMvQixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUM7Ozs7SUFFTyxzQ0FBUTs7O0lBQWhCO1FBQUEsaUJBcUNDOzs7WUFwQ0ssSUFBSTtRQUVSLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ25CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO2dCQUM3RixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQzthQUMvRTtpQkFBTTtnQkFDTCxJQUFJLEdBQU0sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFNBQVMsU0FBSSxJQUFJLENBQUMsZUFBaUIsQ0FBQzs7b0JBQ3hELElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxFQUFFLElBQUksQ0FBQztnQkFDMUQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQzthQUMvRTtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsQ0FBQyxtQkFBQSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQW9CLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUM3RSxhQUFhLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLCtCQUErQixFQUFFLENBQUMsQ0FBQztnQkFDbkUsSUFBSSxDQUFDLFdBQVcsV0FBRyxHQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxJQUFHLENBQUMsbUJBQUEsSUFBSSxFQUFPLENBQUMsQ0FBQyxlQUFlLEVBQUUsTUFBRyxDQUFDO2FBQzlFOztnQkFFSyxLQUFLLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ2hFLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzdCO1FBRUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxLQUFLO1lBQ3BHLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQyxDQUFDOztnQkFDdkQsUUFBUTtZQUNaLElBQUksS0FBSSxDQUFDLFVBQVUsRUFBRTtnQkFDbkIsSUFBSSxLQUFJLENBQUMsVUFBVSxFQUFFO29CQUNuQixRQUFRLEdBQUcsVUFBQSxLQUFLLElBQUksT0FBQSxzQkFBTSxLQUFLLEVBQUssS0FBSyxFQUFHLEVBQXhCLENBQXdCLENBQUM7aUJBQzlDO3FCQUFNO29CQUNMLFFBQVEsR0FBRyxVQUFBLEtBQUssSUFBSSxPQUFBLFFBQVEsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUE1QixDQUE0QixDQUFDO2lCQUNsRDthQUNGO2lCQUFNO2dCQUNMLFFBQVEsR0FBRzs7b0JBQU0sT0FBQSxVQUFHLEdBQUMsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUcsS0FBSyxLQUFHO2dCQUFsQyxDQUFrQyxDQUFDO2FBQ3JEO1lBQ0QsS0FBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Ozs7SUFFRCxxQ0FBTzs7O0lBQVA7UUFDRSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkQsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDdEIsQ0FBQztJQUNILDBCQUFDO0FBQUQsQ0FBQyxBQWxIRCxDQUFrRCxXQUFXLEdBa0g1RDs7Ozs7Ozs7SUFqSEMsMENBQTBCOztJQUMxQix5Q0FBNEI7O0lBQzVCLG1DQUE0Qjs7SUFDNUIseUNBQTRCOztJQUM1QiwyQ0FBcUI7O0lBQ3JCLHNDQUFnQjs7SUFFSixvQ0FBMkI7O0lBQUUsOENBQTJDOztJQUFFLHFDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFraXRhUGx1Z2luIH0gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCB7IFF1ZXJ5IH0gZnJvbSAnLi4vLi4vYXBpL3F1ZXJ5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uLy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyBnZXRWYWx1ZSwgaXNTdHJpbmcsIHNldFZhbHVlLCB0b0Jvb2xlYW4gfSBmcm9tICcuLi8uLi9pbnRlcm5hbC91dGlscyc7XG5cbmV4cG9ydCB0eXBlIEZvcm1Hcm91cExpa2UgPSB7XG4gIHBhdGNoVmFsdWU6IEZ1bmN0aW9uO1xuICBzZXRWYWx1ZTogRnVuY3Rpb247XG4gIHZhbHVlOiBhbnk7XG4gIGdldDogRnVuY3Rpb247XG4gIHZhbHVlQ2hhbmdlczogT2JzZXJ2YWJsZTxhbnk+O1xuICBjb250cm9sczogYW55O1xufTtcblxuZXhwb3J0IHR5cGUgQWtpdGFGb3JtUHJvcDxUPiA9IHtcbiAgW2tleTogc3RyaW5nXTogVDtcbn07XG5cbmV4cG9ydCB0eXBlIFBlcnNpc3RGb3JtUGFyYW1zID0ge1xuICBkZWJvdW5jZVRpbWU/OiBudW1iZXI7XG4gIGZvcm1LZXk/OiBzdHJpbmc7XG4gIGVtaXRFdmVudD86IGJvb2xlYW47XG4gIGFyckNvbnRyb2xGYWN0b3J5PzogQXJyYXlDb250cm9sRmFjdG9yeTtcbn07XG5cbmV4cG9ydCB0eXBlIEFycmF5Q29udHJvbEZhY3RvcnkgPSAodmFsdWU6IGFueSkgPT4gYW55OyAvLyBUb2RvOiBSZXR1cm4gIEFic3RyYWN0Q29udHJvbCBpbnRlcmZhY2VcblxuZXhwb3J0IGNsYXNzIFBlcnNpc3ROZ0Zvcm1QbHVnaW48VCA9IGFueT4gZXh0ZW5kcyBBa2l0YVBsdWdpbiB7XG4gIGZvcm1DaGFuZ2VzOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgaXNSb290S2V5czogYm9vbGVhbjtcbiAgcHJpdmF0ZSBmb3JtOiBGb3JtR3JvdXBMaWtlO1xuICBwcml2YXRlIGlzS2V5QmFzZWQ6IGJvb2xlYW47XG4gIHByaXZhdGUgaW5pdGlhbFZhbHVlO1xuICBwcml2YXRlIGJ1aWxkZXI7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyeTxhbnk+LCBwcml2YXRlIGZhY3RvcnlGbk9yUGF0aD86IEZ1bmN0aW9uIHwgc3RyaW5nLCBwcml2YXRlIHBhcmFtczogUGVyc2lzdEZvcm1QYXJhbXMgPSB7fSkge1xuICAgIHN1cGVyKHF1ZXJ5KTtcbiAgICB0aGlzLnBhcmFtcyA9IHsgLi4ueyBkZWJvdW5jZVRpbWU6IDMwMCwgZm9ybUtleTogJ2FraXRhRm9ybScsIGVtaXRFdmVudDogZmFsc2UsIGFyckNvbnRyb2xGYWN0b3J5OiB2ID0+IHRoaXMuYnVpbGRlci5jb250cm9sKHYpIH0sIC4uLnBhcmFtcyB9O1xuICAgIHRoaXMuaXNSb290S2V5cyA9IHRvQm9vbGVhbihmYWN0b3J5Rm5PclBhdGgpID09PSBmYWxzZTtcbiAgICB0aGlzLmlzS2V5QmFzZWQgPSBpc1N0cmluZyhmYWN0b3J5Rm5PclBhdGgpIHx8IHRoaXMuaXNSb290S2V5cztcbiAgfVxuXG4gIHNldEZvcm0oZm9ybTogRm9ybUdyb3VwTGlrZSwgYnVpbGRlcj8pIHtcbiAgICB0aGlzLmZvcm0gPSBmb3JtO1xuICAgIHRoaXMuYnVpbGRlciA9IGJ1aWxkZXI7XG4gICAgdGhpcy5hY3RpdmF0ZSgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcmVzZXQoaW5pdGlhbFN0YXRlPzogVCkge1xuICAgIGxldCB2YWx1ZTtcbiAgICBpZiAoaW5pdGlhbFN0YXRlKSB7XG4gICAgICB2YWx1ZSA9IGluaXRpYWxTdGF0ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFsdWUgPSB0aGlzLmlzS2V5QmFzZWQgPyB0aGlzLmluaXRpYWxWYWx1ZSA6ICh0aGlzIGFzIGFueSkuZmFjdG9yeUZuT3JQYXRoKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNLZXlCYXNlZCkge1xuICAgICAgT2JqZWN0LmtleXModGhpcy5pbml0aWFsVmFsdWUpLmZvckVhY2goc3RhdGVLZXkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuaW5pdGlhbFZhbHVlW3N0YXRlS2V5XTtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHRoaXMuYnVpbGRlcikge1xuICAgICAgICAgIGNvbnN0IGZvcm1BcnJheSA9IHRoaXMuZm9ybS5jb250cm9sc1tzdGF0ZUtleV07XG4gICAgICAgICAgdGhpcy5jbGVhbkFycmF5KGZvcm1BcnJheSk7XG4gICAgICAgICAgdmFsdWUuZm9yRWFjaCgodiwgaSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5mb3JtLmdldChzdGF0ZUtleSkuaW5zZXJ0KGksICh0aGlzLnBhcmFtcy5hcnJDb250cm9sRmFjdG9yeSBhcyBGdW5jdGlvbikodikpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUodmFsdWUsIHsgZW1pdEV2ZW50OiB0aGlzLnBhcmFtcy5lbWl0RXZlbnQgfSk7XG5cbiAgICBjb25zdCBzdG9yZVZhbHVlID0gdGhpcy5pc0tleUJhc2VkID8gc2V0VmFsdWUodGhpcy5nZXRRdWVyeSgpLmdldFNuYXBzaG90KCksIGAke3RoaXMuZ2V0U3RvcmUoKS5zdG9yZU5hbWV9LiR7dGhpcy5mYWN0b3J5Rm5PclBhdGh9YCwgdmFsdWUpIDogeyBbdGhpcy5wYXJhbXMuZm9ybUtleV06IHZhbHVlIH07XG4gICAgdGhpcy51cGRhdGVTdG9yZShzdG9yZVZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5BcnJheShjb250cm9sKSB7XG4gICAgd2hpbGUgKGNvbnRyb2wubGVuZ3RoICE9PSAwKSB7XG4gICAgICBjb250cm9sLnJlbW92ZUF0KDApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZUluaXRpYWxWYWx1ZShmb3JtVmFsdWUsIHJvb3QpIHtcbiAgICBpZiAoIWZvcm1WYWx1ZSkgcmV0dXJuO1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhmb3JtVmFsdWUpLnJlZHVjZSgoYWNjLCBzdGF0ZUtleSkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSByb290W3N0YXRlS2V5XTtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSAmJiB0aGlzLmJ1aWxkZXIpIHtcbiAgICAgICAgY29uc3QgZmFjdG9yeSA9IHRoaXMucGFyYW1zLmFyckNvbnRyb2xGYWN0b3J5O1xuICAgICAgICB0aGlzLmNsZWFuQXJyYXkodGhpcy5mb3JtLmdldChzdGF0ZUtleSkpO1xuICAgICAgICB2YWx1ZS5mb3JFYWNoKCh2LCBpKSA9PiB7XG4gICAgICAgICAgdGhpcy5mb3JtLmdldChzdGF0ZUtleSkuaW5zZXJ0KGksIChmYWN0b3J5IGFzIEZ1bmN0aW9uKSh2KSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgYWNjW3N0YXRlS2V5XSA9IHJvb3Rbc3RhdGVLZXldO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG4gIH1cblxuICBwcml2YXRlIGFjdGl2YXRlKCkge1xuICAgIGxldCBwYXRoO1xuXG4gICAgaWYgKHRoaXMuaXNLZXlCYXNlZCkge1xuICAgICAgaWYgKHRoaXMuaXNSb290S2V5cykge1xuICAgICAgICB0aGlzLmluaXRpYWxWYWx1ZSA9IHRoaXMucmVzb2x2ZUluaXRpYWxWYWx1ZSh0aGlzLmZvcm0udmFsdWUsIHRoaXMuZ2V0UXVlcnkoKS5nZXRTbmFwc2hvdCgpKTtcbiAgICAgICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUodGhpcy5pbml0aWFsVmFsdWUsIHsgZW1pdEV2ZW50OiB0aGlzLnBhcmFtcy5lbWl0RXZlbnQgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXRoID0gYCR7dGhpcy5nZXRTdG9yZSgpLnN0b3JlTmFtZX0uJHt0aGlzLmZhY3RvcnlGbk9yUGF0aH1gO1xuICAgICAgICBjb25zdCByb290ID0gZ2V0VmFsdWUodGhpcy5nZXRRdWVyeSgpLmdldFNuYXBzaG90KCksIHBhdGgpO1xuICAgICAgICB0aGlzLmluaXRpYWxWYWx1ZSA9IHRoaXMucmVzb2x2ZUluaXRpYWxWYWx1ZShyb290LCByb290KTtcbiAgICAgICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUodGhpcy5pbml0aWFsVmFsdWUsIHsgZW1pdEV2ZW50OiB0aGlzLnBhcmFtcy5lbWl0RXZlbnQgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghKHRoaXMuZ2V0UXVlcnkoKS5nZXRTbmFwc2hvdCgpIGFzIEFraXRhRm9ybVByb3A8VD4pW3RoaXMucGFyYW1zLmZvcm1LZXldKSB7XG4gICAgICAgIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ0BQZXJzaXN0TmdGb3JtUGx1Z2luIGFjdGl2YXRlJyB9KTtcbiAgICAgICAgdGhpcy51cGRhdGVTdG9yZSh7IFt0aGlzLnBhcmFtcy5mb3JtS2V5XTogKHRoaXMgYXMgYW55KS5mYWN0b3J5Rm5PclBhdGgoKSB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFF1ZXJ5KCkuZ2V0U25hcHNob3QoKVt0aGlzLnBhcmFtcy5mb3JtS2V5XTtcbiAgICAgIHRoaXMuZm9ybS5wYXRjaFZhbHVlKHZhbHVlKTtcbiAgICB9XG5cbiAgICB0aGlzLmZvcm1DaGFuZ2VzID0gdGhpcy5mb3JtLnZhbHVlQ2hhbmdlcy5waXBlKGRlYm91bmNlVGltZSh0aGlzLnBhcmFtcy5kZWJvdW5jZVRpbWUpKS5zdWJzY3JpYmUodmFsdWUgPT4ge1xuICAgICAgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQFBlcnNpc3RGb3JtIC0gVXBkYXRlJyB9KTtcbiAgICAgIGxldCBuZXdTdGF0ZTtcbiAgICAgIGlmICh0aGlzLmlzS2V5QmFzZWQpIHtcbiAgICAgICAgaWYgKHRoaXMuaXNSb290S2V5cykge1xuICAgICAgICAgIG5ld1N0YXRlID0gc3RhdGUgPT4gKHsgLi4uc3RhdGUsIC4uLnZhbHVlIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG5ld1N0YXRlID0gc3RhdGUgPT4gc2V0VmFsdWUoc3RhdGUsIHBhdGgsIHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbmV3U3RhdGUgPSAoKSA9PiAoeyBbdGhpcy5wYXJhbXMuZm9ybUtleV06IHZhbHVlIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGVTdG9yZShuZXdTdGF0ZSh0aGlzLmdldFF1ZXJ5KCkuZ2V0U25hcHNob3QoKSkpO1xuICAgIH0pO1xuICB9XG5cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLmZvcm1DaGFuZ2VzICYmIHRoaXMuZm9ybUNoYW5nZXMudW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmZvcm0gPSBudWxsO1xuICAgIHRoaXMuYnVpbGRlciA9IG51bGw7XG4gIH1cbn1cbiJdfQ==