/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { AkitaUpdateIdKeyError, assertEntityExists, assertEntityState } from './error';
import { entityExists, isFunction, isPlainObject, resetActive } from './utils';
var CRUD = /** @class */ (function () {
    function CRUD() {
    }
    /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} entityClass
     * @param {?} idKey
     * @return {?}
     */
    CRUD.prototype._set = /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} entityClass
     * @param {?} idKey
     * @return {?}
     */
    function (state, entities, entityClass, idKey) {
        /** @type {?} */
        var ids;
        /** @type {?} */
        var normalized;
        if (((/** @type {?} */ (entities))).ids && ((/** @type {?} */ (entities))).entities) {
            ids = ((/** @type {?} */ (entities))).ids;
            normalized = ((/** @type {?} */ (entities))).entities;
        }
        else {
            /** @type {?} */
            var isArray = Array.isArray(entities);
            normalized = entities;
            if (isArray) {
                normalized = (/** @type {?} */ (this.keyBy((/** @type {?} */ (entities)), entityClass, idKey)));
            }
            else {
                assertEntityState(entities);
            }
            ids = isArray ? ((/** @type {?} */ (entities))).map(function (entity) { return entity[idKey]; }) : Object.keys((/** @type {?} */ (normalized))).map(function (id) { return entities[id][idKey]; });
        }
        /** @type {?} */
        var newState = tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: normalized, ids: ids, loading: false });
        if (resetActive(newState)) {
            newState.active = null;
        }
        return newState;
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    CRUD.prototype._replaceEntity = /**
     * @template T
     * @param {?} state
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    function (state, id, entity) {
        var _a;
        return tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: tslib_1.__assign({}, state.entities, (_a = {}, _a[id] = entity, _a)) });
    };
    /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} idKey
     * @param {?=} options
     * @return {?}
     */
    CRUD.prototype._add = /**
     * @template S, E
     * @param {?} state
     * @param {?} entities
     * @param {?} idKey
     * @param {?=} options
     * @return {?}
     */
    function (state, entities, idKey, options) {
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var addedEntities = {};
        /** @type {?} */
        var addedIds = [];
        for (var i = 0; i < entities.length; i++) {
            /** @type {?} */
            var entity = entities[i];
            /** @type {?} */
            var entityId = entity[idKey];
            if (!entityExists(entityId, state.entities)) {
                addedEntities[entityId] = entity;
                if (options.prepend)
                    addedIds.unshift(entityId);
                else
                    addedIds.push(entityId);
            }
        }
        return tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: tslib_1.__assign({}, state.entities, addedEntities), ids: options.prepend ? tslib_1.__spread(addedIds, state.ids) : tslib_1.__spread(state.ids, addedIds) });
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @param {?} newStateOrFn
     * @param {?} idKey
     * @return {?}
     */
    CRUD.prototype._update = /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @param {?} newStateOrFn
     * @param {?} idKey
     * @return {?}
     */
    function (state, ids, newStateOrFn, idKey) {
        /** @type {?} */
        var updatedEntities = {};
        /** @type {?} */
        var isUpdatingIdKey = false;
        /** @type {?} */
        var idToUpdate;
        for (var i = 0; i < ids.length; i++) {
            /** @type {?} */
            var id = ids[i];
            idToUpdate = id;
            assertEntityExists(id, state.entities);
            /** @type {?} */
            var oldEntity = state.entities[id];
            /** @type {?} */
            var newState = isFunction(newStateOrFn) ? newStateOrFn(oldEntity) : newStateOrFn;
            if (newState.hasOwnProperty(idKey) && newState[idKey] !== oldEntity[idKey]) {
                if (ids.length > 1) {
                    throw new AkitaUpdateIdKeyError();
                }
                isUpdatingIdKey = true;
                idToUpdate = newState[idKey];
            }
            /** @type {?} */
            var newEntity = void 0;
            /** @type {?} */
            var merged = tslib_1.__assign({}, oldEntity, newState);
            if (isPlainObject(oldEntity)) {
                newEntity = merged;
            }
            else {
                /**
                 * In case that new state is class of it's own, there's
                 * a possibility that it will be different than the old
                 * class.
                 * For example, Old state is an instance of animal class
                 * and new state is instance of person class.
                 * To avoid run over new person class with the old animal
                 * class we check if the new state is a class of it's own.
                 * If so, use it. Otherwise, use the old state class
                 */
                if (isPlainObject(newState)) {
                    newEntity = new oldEntity.constructor(merged);
                }
                else {
                    newEntity = new ((/** @type {?} */ (newState))).constructor(merged);
                }
            }
            updatedEntities[idToUpdate] = newEntity;
        }
        /** @type {?} */
        var updatedIds = state.ids;
        /** @type {?} */
        var stateEntities = state.entities;
        if (isUpdatingIdKey) {
            var _a = tslib_1.__read(ids, 1), id_1 = _a[0];
            var _b = state.entities, _c = id_1, deletedEntity = _b[_c], rest = tslib_1.__rest(_b, [typeof _c === "symbol" ? _c : _c + ""]);
            stateEntities = rest;
            updatedIds = state.ids.map(function (current) { return (current === id_1 ? idToUpdate : current); });
        }
        return tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: tslib_1.__assign({}, stateEntities, updatedEntities), ids: updatedIds });
    };
    /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @return {?}
     */
    CRUD.prototype._remove = /**
     * @template T
     * @param {?} state
     * @param {?} ids
     * @return {?}
     */
    function (state, ids) {
        if (!ids)
            return this._removeAll(state);
        /** @type {?} */
        var removed = ids.reduce(function (acc, id) {
            var _a = id, entity = acc[_a], rest = tslib_1.__rest(acc, [typeof _a === "symbol" ? _a : _a + ""]);
            return rest;
        }, state.entities);
        /** @type {?} */
        var newState = tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: removed, ids: state.ids.filter(function (current) { return ids.indexOf(current) === -1; }) });
        if (resetActive(newState)) {
            newState.active = null;
        }
        return newState;
    };
    /**
     * @template T
     * @param {?} state
     * @return {?}
     */
    CRUD.prototype._removeAll = /**
     * @template T
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var newState = tslib_1.__assign({}, ((/** @type {?} */ (state))), { entities: {}, ids: [], active: null });
        return newState;
    };
    /**
     * @param {?} entities
     * @param {?=} entityClass
     * @param {?=} id
     * @return {?}
     */
    CRUD.prototype.keyBy = /**
     * @param {?} entities
     * @param {?=} entityClass
     * @param {?=} id
     * @return {?}
     */
    function (entities, entityClass, id) {
        if (id === void 0) { id = 'id'; }
        /** @type {?} */
        var acc = {};
        for (var i = 0, len = entities.length; i < len; i++) {
            /** @type {?} */
            var entity = entities[i];
            acc[entity[id]] = entityClass ? new entityClass(entity) : entity;
        }
        return acc;
    };
    return CRUD;
}());
export { CRUD };
/** @type {?} */
export var _crud = new CRUD();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J1ZC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9pbnRlcm5hbC9jcnVkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLHFCQUFxQixFQUFFLGtCQUFrQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0U7SUFBQTtJQXFMQSxDQUFDOzs7Ozs7Ozs7SUFwTEMsbUJBQUk7Ozs7Ozs7O0lBQUosVUFBVyxLQUFRLEVBQUUsUUFBd0MsRUFBRSxXQUFtQyxFQUFFLEtBQUs7O1lBQ25HLEdBQUc7O1lBQUUsVUFBVTtRQUVuQixJQUFJLENBQUMsbUJBQUEsUUFBUSxFQUFlLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxtQkFBQSxRQUFRLEVBQWUsQ0FBQyxDQUFDLFFBQVEsRUFBRTtZQUN2RSxHQUFHLEdBQUcsQ0FBQyxtQkFBQSxRQUFRLEVBQWUsQ0FBQyxDQUFDLEdBQUcsQ0FBQztZQUNwQyxVQUFVLEdBQUcsQ0FBQyxtQkFBQSxRQUFRLEVBQWUsQ0FBQyxDQUFDLFFBQVEsQ0FBQztTQUNqRDthQUFNOztnQkFDQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7WUFDdkMsVUFBVSxHQUFHLFFBQVEsQ0FBQztZQUV0QixJQUFJLE9BQU8sRUFBRTtnQkFDWCxVQUFVLEdBQUcsbUJBQUEsSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBQSxRQUFRLEVBQU8sRUFBRSxXQUFXLEVBQUUsS0FBSyxDQUFDLEVBQU8sQ0FBQzthQUNyRTtpQkFBTTtnQkFDTCxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUM3QjtZQUVELEdBQUcsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQUEsUUFBUSxFQUFPLENB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RUFBRSxJQUFJLEdBQ2I7UUFFRCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDOzs7Ozs7O0lBRU8sb0JBQUs7Ozs7OztJQUFiLFVBQWMsUUFBZSxFQUFFLFdBQTBCLEVBQUUsRUFBUztRQUFULG1CQUFBLEVBQUEsU0FBUzs7WUFDNUQsR0FBRyxHQUFHLEVBQUU7UUFFZCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFOztnQkFDN0MsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDMUIsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztTQUNsRTtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUNILFdBQUM7QUFBRCxDQUFDLEFBckxELElBcUxDOzs7QUFFRCxNQUFNLEtBQU8sS0FBSyxHQUFHLElBQUksSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW50aXRpZXMsIEVudGl0eVN0YXRlLCBIYXNoTWFwLCBJRCwgTmV3YWJsZSwgQWRkT3B0aW9ucyB9IGZyb20gJy4uL2FwaS90eXBlcyc7XG5pbXBvcnQgeyBBa2l0YVVwZGF0ZUlkS2V5RXJyb3IsIGFzc2VydEVudGl0eUV4aXN0cywgYXNzZXJ0RW50aXR5U3RhdGUgfSBmcm9tICcuL2Vycm9yJztcbmltcG9ydCB7IGVudGl0eUV4aXN0cywgaXNGdW5jdGlvbiwgaXNQbGFpbk9iamVjdCwgcmVzZXRBY3RpdmUgfSBmcm9tICcuL3V0aWxzJztcblxuZXhwb3J0IGNsYXNzIENSVUQge1xuICBfc2V0PFMsIEU+KHN0YXRlOiBTLCBlbnRpdGllczogRVtdIHwgSGFzaE1hcDxFPiB8IEVudGl0aWVzPEU+LCBlbnRpdHlDbGFzczogTmV3YWJsZTxFPiB8IHVuZGVmaW5lZCwgaWRLZXkpOiBTIHtcbiAgICBsZXQgaWRzLCBub3JtYWxpemVkO1xuXG4gICAgaWYgKChlbnRpdGllcyBhcyBFbnRpdGllczxFPikuaWRzICYmIChlbnRpdGllcyBhcyBFbnRpdGllczxFPikuZW50aXRpZXMpIHtcbiAgICAgIGlkcyA9IChlbnRpdGllcyBhcyBFbnRpdGllczxFPikuaWRzO1xuICAgICAgbm9ybWFsaXplZCA9IChlbnRpdGllcyBhcyBFbnRpdGllczxFPikuZW50aXRpZXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGlzQXJyYXkgPSBBcnJheS5pc0FycmF5KGVudGl0aWVzKTtcbiAgICAgIG5vcm1hbGl6ZWQgPSBlbnRpdGllcztcblxuICAgICAgaWYgKGlzQXJyYXkpIHtcbiAgICAgICAgbm9ybWFsaXplZCA9IHRoaXMua2V5QnkoZW50aXRpZXMgYXMgRVtdLCBlbnRpdHlDbGFzcywgaWRLZXkpIGFzIEVbXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFzc2VydEVudGl0eVN0YXRlKGVudGl0aWVzKTtcbiAgICAgIH1cblxuICAgICAgaWRzID0gaXNBcnJheSA/IChlbnRpdGllcyBhcyBFW10pLm1hcChlbnRpdHkgPT4gZW50aXR5W2lkS2V5XSkgOiBPYmplY3Qua2V5cyhub3JtYWxpemVkIGFzIEhhc2hNYXA8RT4pLm1hcChpZCA9PiBlbnRpdGllc1tpZF1baWRLZXldKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdTdGF0ZSA9IHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IG5vcm1hbGl6ZWQsXG4gICAgICBpZHMsXG4gICAgICBsb2FkaW5nOiBmYWxzZVxuICAgIH07XG5cbiAgICBpZiAocmVzZXRBY3RpdmUobmV3U3RhdGUpKSB7XG4gICAgICBuZXdTdGF0ZS5hY3RpdmUgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBuZXdTdGF0ZTtcbiAgfVxuXG4gIF9yZXBsYWNlRW50aXR5PFQgZXh0ZW5kcyBFbnRpdHlTdGF0ZT4oc3RhdGU6IFQsIGlkOiBJRCwgZW50aXR5KTogVCB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXMsXG4gICAgICAgIFtpZF06IGVudGl0eVxuICAgICAgfVxuICAgIH07XG4gIH1cblxuICBfYWRkPFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZSwgRT4oc3RhdGU6IFMsIGVudGl0aWVzOiBFW10sIGlkS2V5LCBvcHRpb25zOiBBZGRPcHRpb25zID0ge30pOiBTIHtcbiAgICBsZXQgYWRkZWRFbnRpdGllcyA9IHt9O1xuICAgIGxldCBhZGRlZElkcyA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbnRpdGllcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZW50aXR5ID0gZW50aXRpZXNbaV07XG4gICAgICBjb25zdCBlbnRpdHlJZCA9IGVudGl0eVtpZEtleV07XG5cbiAgICAgIGlmICghZW50aXR5RXhpc3RzKGVudGl0eUlkLCBzdGF0ZS5lbnRpdGllcykpIHtcbiAgICAgICAgYWRkZWRFbnRpdGllc1tlbnRpdHlJZF0gPSBlbnRpdHk7XG4gICAgICAgIGlmIChvcHRpb25zLnByZXBlbmQpIGFkZGVkSWRzLnVuc2hpZnQoZW50aXR5SWQpO1xuICAgICAgICBlbHNlIGFkZGVkSWRzLnB1c2goZW50aXR5SWQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICAuLi5hZGRlZEVudGl0aWVzXG4gICAgICB9LFxuICAgICAgaWRzOiBvcHRpb25zLnByZXBlbmQgPyBbLi4uYWRkZWRJZHMsIC4uLnN0YXRlLmlkc10gOiBbLi4uc3RhdGUuaWRzLCAuLi5hZGRlZElkc11cbiAgICB9O1xuICB9XG5cbiAgX3VwZGF0ZTxUIGV4dGVuZHMgRW50aXR5U3RhdGU+KHN0YXRlOiBULCBpZHM6IElEW10sIG5ld1N0YXRlT3JGbjogb2JqZWN0IHwgKChlOiBSZWFkb25seTxhbnk+KSA9PiBvYmplY3QpLCBpZEtleTogc3RyaW5nKTogVCB7XG4gICAgY29uc3QgdXBkYXRlZEVudGl0aWVzID0ge307XG5cbiAgICBsZXQgaXNVcGRhdGluZ0lkS2V5ID0gZmFsc2U7XG4gICAgbGV0IGlkVG9VcGRhdGU6IElEO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGlkID0gaWRzW2ldO1xuICAgICAgaWRUb1VwZGF0ZSA9IGlkO1xuICAgICAgYXNzZXJ0RW50aXR5RXhpc3RzKGlkLCBzdGF0ZS5lbnRpdGllcyk7XG5cbiAgICAgIGNvbnN0IG9sZEVudGl0eSA9IHN0YXRlLmVudGl0aWVzW2lkXTtcbiAgICAgIGNvbnN0IG5ld1N0YXRlID0gaXNGdW5jdGlvbihuZXdTdGF0ZU9yRm4pID8gbmV3U3RhdGVPckZuKG9sZEVudGl0eSkgOiBuZXdTdGF0ZU9yRm47XG5cbiAgICAgIGlmIChuZXdTdGF0ZS5oYXNPd25Qcm9wZXJ0eShpZEtleSkgJiYgbmV3U3RhdGVbaWRLZXldICE9PSBvbGRFbnRpdHlbaWRLZXldKSB7XG4gICAgICAgIGlmIChpZHMubGVuZ3RoID4gMSkge1xuICAgICAgICAgIHRocm93IG5ldyBBa2l0YVVwZGF0ZUlkS2V5RXJyb3IoKTtcbiAgICAgICAgfVxuICAgICAgICBpc1VwZGF0aW5nSWRLZXkgPSB0cnVlO1xuICAgICAgICBpZFRvVXBkYXRlID0gbmV3U3RhdGVbaWRLZXldO1xuICAgICAgfVxuXG4gICAgICBsZXQgbmV3RW50aXR5O1xuXG4gICAgICBjb25zdCBtZXJnZWQgPSB7XG4gICAgICAgIC4uLm9sZEVudGl0eSxcbiAgICAgICAgLi4ubmV3U3RhdGVcbiAgICAgIH07XG5cbiAgICAgIGlmIChpc1BsYWluT2JqZWN0KG9sZEVudGl0eSkpIHtcbiAgICAgICAgbmV3RW50aXR5ID0gbWVyZ2VkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluIGNhc2UgdGhhdCBuZXcgc3RhdGUgaXMgY2xhc3Mgb2YgaXQncyBvd24sIHRoZXJlJ3NcbiAgICAgICAgICogYSBwb3NzaWJpbGl0eSB0aGF0IGl0IHdpbGwgYmUgZGlmZmVyZW50IHRoYW4gdGhlIG9sZFxuICAgICAgICAgKiBjbGFzcy5cbiAgICAgICAgICogRm9yIGV4YW1wbGUsIE9sZCBzdGF0ZSBpcyBhbiBpbnN0YW5jZSBvZiBhbmltYWwgY2xhc3NcbiAgICAgICAgICogYW5kIG5ldyBzdGF0ZSBpcyBpbnN0YW5jZSBvZiBwZXJzb24gY2xhc3MuXG4gICAgICAgICAqIFRvIGF2b2lkIHJ1biBvdmVyIG5ldyBwZXJzb24gY2xhc3Mgd2l0aCB0aGUgb2xkIGFuaW1hbFxuICAgICAgICAgKiBjbGFzcyB3ZSBjaGVjayBpZiB0aGUgbmV3IHN0YXRlIGlzIGEgY2xhc3Mgb2YgaXQncyBvd24uXG4gICAgICAgICAqIElmIHNvLCB1c2UgaXQuIE90aGVyd2lzZSwgdXNlIHRoZSBvbGQgc3RhdGUgY2xhc3NcbiAgICAgICAgICovXG4gICAgICAgIGlmIChpc1BsYWluT2JqZWN0KG5ld1N0YXRlKSkge1xuICAgICAgICAgIG5ld0VudGl0eSA9IG5ldyBvbGRFbnRpdHkuY29uc3RydWN0b3IobWVyZ2VkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXdFbnRpdHkgPSBuZXcgKG5ld1N0YXRlIGFzIGFueSkuY29uc3RydWN0b3IobWVyZ2VkKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB1cGRhdGVkRW50aXRpZXNbaWRUb1VwZGF0ZV0gPSBuZXdFbnRpdHk7XG4gICAgfVxuXG4gICAgbGV0IHVwZGF0ZWRJZHMgPSBzdGF0ZS5pZHM7XG4gICAgbGV0IHN0YXRlRW50aXRpZXMgPSBzdGF0ZS5lbnRpdGllcztcbiAgICBpZiAoaXNVcGRhdGluZ0lkS2V5KSB7XG4gICAgICBjb25zdCBbaWRdID0gaWRzO1xuICAgICAgY29uc3QgeyBbaWRdOiBkZWxldGVkRW50aXR5LCAuLi5yZXN0IH0gPSBzdGF0ZS5lbnRpdGllcztcbiAgICAgIHN0YXRlRW50aXRpZXMgPSByZXN0O1xuICAgICAgdXBkYXRlZElkcyA9IHN0YXRlLmlkcy5tYXAoY3VycmVudCA9PiAoY3VycmVudCA9PT0gaWQgPyBpZFRvVXBkYXRlIDogY3VycmVudCkpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICAuLi4oc3RhdGUgYXMgYW55KSxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlRW50aXRpZXMsXG4gICAgICAgIC4uLnVwZGF0ZWRFbnRpdGllc1xuICAgICAgfSxcbiAgICAgIGlkczogdXBkYXRlZElkc1xuICAgIH07XG4gIH1cblxuICBfcmVtb3ZlPFQgZXh0ZW5kcyBFbnRpdHlTdGF0ZT4oc3RhdGU6IFQsIGlkczogSURbXSB8IG51bGwpOiBUIHtcbiAgICBpZiAoIWlkcykgcmV0dXJuIHRoaXMuX3JlbW92ZUFsbChzdGF0ZSk7XG5cbiAgICBjb25zdCByZW1vdmVkID0gaWRzLnJlZHVjZSgoYWNjLCBpZCkgPT4ge1xuICAgICAgY29uc3QgeyBbaWRdOiBlbnRpdHksIC4uLnJlc3QgfSA9IGFjYztcbiAgICAgIHJldHVybiByZXN0O1xuICAgIH0sIHN0YXRlLmVudGl0aWVzKTtcbiAgICBjb25zdCBuZXdTdGF0ZSA9IHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IHJlbW92ZWQsXG4gICAgICBpZHM6IHN0YXRlLmlkcy5maWx0ZXIoY3VycmVudCA9PiBpZHMuaW5kZXhPZihjdXJyZW50KSA9PT0gLTEpXG4gICAgfTtcblxuICAgIGlmIChyZXNldEFjdGl2ZShuZXdTdGF0ZSkpIHtcbiAgICAgIG5ld1N0YXRlLmFjdGl2ZSA9IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1N0YXRlO1xuICB9XG5cbiAgcHJpdmF0ZSBfcmVtb3ZlQWxsPFQgZXh0ZW5kcyBFbnRpdHlTdGF0ZT4oc3RhdGU6IFQpOiBUIHtcbiAgICBjb25zdCBuZXdTdGF0ZSA9IHtcbiAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgZW50aXRpZXM6IHt9LFxuICAgICAgaWRzOiBbXSxcbiAgICAgIGFjdGl2ZTogbnVsbFxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3U3RhdGU7XG4gIH1cblxuICBwcml2YXRlIGtleUJ5KGVudGl0aWVzOiBhbnlbXSwgZW50aXR5Q2xhc3M/OiBOZXdhYmxlPGFueT4sIGlkID0gJ2lkJykge1xuICAgIGNvbnN0IGFjYyA9IHt9O1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IGVudGl0aWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICBjb25zdCBlbnRpdHkgPSBlbnRpdGllc1tpXTtcbiAgICAgIGFjY1tlbnRpdHlbaWRdXSA9IGVudGl0eUNsYXNzID8gbmV3IGVudGl0eUNsYXNzKGVudGl0eSkgOiBlbnRpdHk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjYztcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgX2NydWQgPSBuZXcgQ1JVRCgpO1xuIl19