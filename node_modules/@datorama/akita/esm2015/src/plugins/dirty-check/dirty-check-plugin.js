/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { AkitaPlugin } from '../plugin';
import { QueryEntity } from '../../api/query-entity';
import { BehaviorSubject, Subject, combineLatest } from 'rxjs';
import { distinctUntilChanged, map, skip } from 'rxjs/operators';
import { coerceArray, isFunction, isUndefined, toBoolean } from '../../internal/utils';
import { __globalState } from '../../internal/global-state';
/** @type {?} */
export const dirtyCheckDefaultParams = {
    comparator: (head, current) => JSON.stringify(head) !== JSON.stringify(current)
};
/**
 * @param {?} nestedObj
 * @param {?} path
 * @return {?}
 */
export function getNestedPath(nestedObj, path) {
    /** @type {?} */
    const pathAsArray = path.split('.');
    return pathAsArray.reduce((obj, key) => (obj && obj[key] !== 'undefined' ? obj[key] : undefined), nestedObj);
}
/**
 * @template Entity, StoreState
 */
export class DirtyCheckPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params, _entityId) {
        super(query);
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        this.dirty = new BehaviorSubject(false);
        this.active = false;
        this._reset = new Subject();
        this.isDirty$ = this.dirty.asObservable().pipe(distinctUntilChanged());
        this.reset$ = this._reset.asObservable();
        this.params = Object.assign({}, dirtyCheckDefaultParams, params);
        if (this.params.watchProperty) {
            /** @type {?} */
            let watchProp = (/** @type {?} */ (coerceArray(this.params.watchProperty)));
            if (query instanceof QueryEntity && watchProp.includes('entities') && !watchProp.includes('ids')) {
                watchProp.push('ids');
            }
            this.params.watchProperty = watchProp;
        }
    }
    /**
     * @param {?=} params
     * @return {?}
     */
    reset(params = {}) {
        /** @type {?} */
        let currentValue = this.head;
        if (isFunction(params.updateFn)) {
            if (this.isEntityBased(this._entityId)) {
                currentValue = params.updateFn(this.head, ((/** @type {?} */ (this.getQuery()))).getEntity(this._entityId));
            }
            else {
                currentValue = params.updateFn(this.head, ((/** @type {?} */ (this.getQuery()))).getSnapshot());
            }
        }
        __globalState.setCustomAction({ type: `@DirtyCheck - Revert` });
        this.updateStore(currentValue, this._entityId);
        this._reset.next();
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    setHead() {
        if (!(/** @type {?} */ (this)).active) {
            (/** @type {?} */ (this)).activate();
            (/** @type {?} */ (this)).active = true;
        }
        else {
            (/** @type {?} */ (this)).head = (/** @type {?} */ (this))._getHead();
        }
        (/** @type {?} */ (this)).updateDirtiness(false);
        return (/** @type {?} */ (this));
    }
    /**
     * @return {?}
     */
    isDirty() {
        return toBoolean(this.dirty.value);
    }
    /**
     * @return {?}
     */
    hasHead() {
        return toBoolean(this.getHead());
    }
    /**
     * @return {?}
     */
    destroy() {
        this.head = null;
        this.subscription && this.subscription.unsubscribe();
        this._reset && this._reset.complete();
    }
    /**
     * @param {?} path
     * @return {?}
     */
    isPathDirty(path) {
        /** @type {?} */
        const head = this.getHead();
        /** @type {?} */
        const current = ((/** @type {?} */ (this.getQuery()))).getSnapshot();
        /** @type {?} */
        const currentPathValue = getNestedPath(current, path);
        /** @type {?} */
        const headPathValue = getNestedPath(head, path);
        return this.params.comparator(currentPathValue, headPathValue);
    }
    /**
     * @return {?}
     */
    getHead() {
        return this.head;
    }
    /**
     * @return {?}
     */
    activate() {
        this.head = this._getHead();
        /**
         * if we are tracking specific properties select only the relevant ones
         * @type {?}
         */
        const source = this.params.watchProperty
            ? ((/** @type {?} */ (this.params.watchProperty))).map(prop => this.query.select(state => state[prop]).pipe(map(val => ({
                val,
                __akitaKey: prop
            }))))
            : [this.selectSource(this._entityId)];
        this.subscription = combineLatest(...source)
            .pipe(skip(1))
            .subscribe((currentState) => {
            if (isUndefined(this.head))
                return;
            /**
             * __akitaKey is used to determine if we are tracking a specific property or a store change
             * @type {?}
             */
            const isChange = currentState.some(state => {
                /** @type {?} */
                const head = state.__akitaKey ? this.head[(/** @type {?} */ (state.__akitaKey))] : this.head;
                /** @type {?} */
                const compareTo = state.__akitaKey ? state.val : state;
                return this.params.comparator(head, compareTo);
            });
            this.updateDirtiness(isChange);
        });
    }
    /**
     * @param {?} isDirty
     * @return {?}
     */
    updateDirtiness(isDirty) {
        this.dirty.next(isDirty);
    }
    /**
     * @return {?}
     */
    _getHead() {
        /** @type {?} */
        let head = this.getSource(this._entityId);
        if (this.params.watchProperty) {
            head = this.getWatchedValues((/** @type {?} */ (head)));
        }
        return head;
    }
    /**
     * @param {?} source
     * @return {?}
     */
    getWatchedValues(source) {
        return ((/** @type {?} */ (this.params.watchProperty))).reduce((watched, prop) => {
            watched[prop] = source[prop];
            return watched;
        }, (/** @type {?} */ ({})));
    }
}
if (false) {
    /** @type {?} */
    DirtyCheckPlugin.prototype.head;
    /** @type {?} */
    DirtyCheckPlugin.prototype.dirty;
    /** @type {?} */
    DirtyCheckPlugin.prototype.subscription;
    /** @type {?} */
    DirtyCheckPlugin.prototype.active;
    /** @type {?} */
    DirtyCheckPlugin.prototype._reset;
    /** @type {?} */
    DirtyCheckPlugin.prototype.isDirty$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.reset$;
    /** @type {?} */
    DirtyCheckPlugin.prototype.query;
    /** @type {?} */
    DirtyCheckPlugin.prototype.params;
    /** @type {?} */
    DirtyCheckPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlydHktY2hlY2stcGx1Z2luLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BsdWdpbnMvZGlydHktY2hlY2svZGlydHktY2hlY2stcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFXLE1BQU0sV0FBVyxDQUFDO0FBQ2pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFjLE9BQU8sRUFBZ0IsYUFBYSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3pGLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakUsT0FBTyxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXZGLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQzs7QUFZNUQsTUFBTSxPQUFPLHVCQUF1QixHQUFHO0lBQ3JDLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7Q0FDaEY7Ozs7OztBQUVELE1BQU0sVUFBVSxhQUFhLENBQUMsU0FBUyxFQUFFLElBQVk7O1VBQzdDLFdBQVcsR0FBYSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUM3QyxPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNB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SSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDM0IsQ0FBQzs7OztJQUVPLFFBQVE7O1lBQ1YsSUFBSSxHQUE2QixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDbkUsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRTtZQUM3QixJQUFJLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFBLElBQUksRUFBYyxDQUFDLENBQUM7U0FDbEQ7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7Ozs7O0lBRU8sZ0JBQWdCLENBQUMsTUFBa0I7UUFDekMsT0FBTyxDQUFDLG1CQUFBLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUF3QixDQUFDLENBQUMsTUFBTSxDQUMvRCxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdCLE9BQU8sT0FBTyxDQUFDO1FBQ2pCLENBQUMsRUFDRCxtQkFBQSxFQUFFLEVBQXVCLENBQzFCLENBQUM7SUFDSixDQUFDO0NBQ0Y7OztJQTNIQyxnQ0FBdUM7O0lBQ3ZDLGlDQUEyQzs7SUFDM0Msd0NBQW1DOztJQUNuQyxrQ0FBdUI7O0lBQ3ZCLGtDQUErQjs7SUFFL0Isb0NBQXVGOztJQUN2RixrQ0FBb0M7O0lBRXhCLGlDQUE0Qzs7SUFBRSxrQ0FBaUM7O0lBQUUscUNBQStCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWtpdGFQbHVnaW4sIFF1ZXJpZXMgfSBmcm9tICcuLi9wbHVnaW4nO1xuaW1wb3J0IHsgUXVlcnlFbnRpdHkgfSBmcm9tICcuLi8uLi9hcGkvcXVlcnktZW50aXR5JztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBjb21iaW5lTGF0ZXN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgbWFwLCBza2lwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXksIGlzRnVuY3Rpb24sIGlzVW5kZWZpbmVkLCB0b0Jvb2xlYW4gfSBmcm9tICcuLi8uLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBFbnRpdHlQYXJhbSB9IGZyb20gJy4uL2VudGl0eS1jb2xsZWN0aW9uLXBsdWdpbic7XG5pbXBvcnQgeyBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcbmltcG9ydCB7IFF1ZXJ5IH0gZnJvbSAnLi4vLi4vYXBpL3F1ZXJ5JztcblxudHlwZSBIZWFkPFN0b3JlU3RhdGUgPSBhbnksIEVudGl0eSA9IGFueT4gPSBTdG9yZVN0YXRlIHwgUGFydGlhbDxTdG9yZVN0YXRlPiB8IEVudGl0eTtcblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja0NvbXBhcmF0b3I8RW50aXR5PiA9IChoZWFkOiBFbnRpdHksIGN1cnJlbnQ6IEVudGl0eSkgPT4gYm9vbGVhbjtcblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja1BhcmFtczxTdG9yZVN0YXRlID0gYW55PiA9IHtcbiAgY29tcGFyYXRvcj86IERpcnR5Q2hlY2tDb21wYXJhdG9yPFN0b3JlU3RhdGU+O1xuICB3YXRjaFByb3BlcnR5Pzoga2V5b2YgU3RvcmVTdGF0ZSB8IChrZXlvZiBTdG9yZVN0YXRlKVtdO1xufTtcblxuZXhwb3J0IGNvbnN0IGRpcnR5Q2hlY2tEZWZhdWx0UGFyYW1zID0ge1xuICBjb21wYXJhdG9yOiAoaGVhZCwgY3VycmVudCkgPT4gSlNPTi5zdHJpbmdpZnkoaGVhZCkgIT09IEpTT04uc3RyaW5naWZ5KGN1cnJlbnQpXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmVzdGVkUGF0aChuZXN0ZWRPYmosIHBhdGg6IHN0cmluZykge1xuICBjb25zdCBwYXRoQXNBcnJheTogc3RyaW5nW10gPSBwYXRoLnNwbGl0KCcuJyk7XG4gIHJldHVybiBwYXRoQXNBcnJheS5yZWR1Y2UoKG9iaiwga2V5KSA9PiAob2JqICYmIG9ialtrZXldICE9PSAndW5kZWZpbmVkJyA/IG9ialtrZXldIDogdW5kZWZpbmVkKSwgbmVzdGVkT2JqKTtcbn1cblxuZXhwb3J0IHR5cGUgRGlydHlDaGVja1Jlc2V0UGFyYW1zPFN0b3JlU3RhdGUgPSBhbnk+ID0ge1xuICB1cGRhdGVGbj86IFN0b3JlU3RhdGUgfCAoKGhlYWQ6IFN0b3JlU3RhdGUsIGN1cnJlbnQ6IFN0b3JlU3RhdGUpID0+IGFueSk7XG59O1xuXG5leHBvcnQgY2xhc3MgRGlydHlDaGVja1BsdWdpbjxFbnRpdHkgPSBhbnksIFN0b3JlU3RhdGUgPSBhbnk+IGV4dGVuZHMgQWtpdGFQbHVnaW48RW50aXR5LCBTdG9yZVN0YXRlPiB7XG4gIHByaXZhdGUgaGVhZDogSGVhZDxTdG9yZVN0YXRlLCBFbnRpdHk+O1xuICBwcml2YXRlIGRpcnR5ID0gbmV3IEJlaGF2aW9yU3ViamVjdChmYWxzZSk7XG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgYWN0aXZlID0gZmFsc2U7XG4gIHByaXZhdGUgX3Jlc2V0ID0gbmV3IFN1YmplY3QoKTtcblxuICBpc0RpcnR5JDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuZGlydHkuYXNPYnNlcnZhYmxlKCkucGlwZShkaXN0aW5jdFVudGlsQ2hhbmdlZCgpKTtcbiAgcmVzZXQkID0gdGhpcy5fcmVzZXQuYXNPYnNlcnZhYmxlKCk7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIHF1ZXJ5OiBRdWVyaWVzPEVudGl0eSwgU3RvcmVTdGF0ZT4sIHByaXZhdGUgcGFyYW1zPzogRGlydHlDaGVja1BhcmFtcywgcHJpdmF0ZSBfZW50aXR5SWQ/OiBFbnRpdHlQYXJhbSkge1xuICAgIHN1cGVyKHF1ZXJ5KTtcbiAgICB0aGlzLnBhcmFtcyA9IHsgLi4uZGlydHlDaGVja0RlZmF1bHRQYXJhbXMsIC4uLnBhcmFtcyB9O1xuICAgIGlmICh0aGlzLnBhcmFtcy53YXRjaFByb3BlcnR5KSB7XG4gICAgICBsZXQgd2F0Y2hQcm9wID0gY29lcmNlQXJyYXkodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSkgYXMgYW55W107XG4gICAgICBpZiAocXVlcnkgaW5zdGFuY2VvZiBRdWVyeUVudGl0eSAmJiB3YXRjaFByb3AuaW5jbHVkZXMoJ2VudGl0aWVzJykgJiYgIXdhdGNoUHJvcC5pbmNsdWRlcygnaWRzJykpIHtcbiAgICAgICAgd2F0Y2hQcm9wLnB1c2goJ2lkcycpO1xuICAgICAgfVxuICAgICAgdGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSA9IHdhdGNoUHJvcDtcbiAgICB9XG4gIH1cblxuICByZXNldChwYXJhbXM6IERpcnR5Q2hlY2tSZXNldFBhcmFtcyA9IHt9KSB7XG4gICAgbGV0IGN1cnJlbnRWYWx1ZSA9IHRoaXMuaGVhZDtcbiAgICBpZiAoaXNGdW5jdGlvbihwYXJhbXMudXBkYXRlRm4pKSB7XG4gICAgICBpZiAodGhpcy5pc0VudGl0eUJhc2VkKHRoaXMuX2VudGl0eUlkKSkge1xuICAgICAgICBjdXJyZW50VmFsdWUgPSBwYXJhbXMudXBkYXRlRm4odGhpcy5oZWFkLCAodGhpcy5nZXRRdWVyeSgpIGFzIFF1ZXJ5RW50aXR5PFN0b3JlU3RhdGUsIEVudGl0eT4pLmdldEVudGl0eSh0aGlzLl9lbnRpdHlJZCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY3VycmVudFZhbHVlID0gcGFyYW1zLnVwZGF0ZUZuKHRoaXMuaGVhZCwgKHRoaXMuZ2V0UXVlcnkoKSBhcyBRdWVyeTxTdG9yZVN0YXRlPikuZ2V0U25hcHNob3QoKSk7XG4gICAgICB9XG4gICAgfVxuICAgIF9fZ2xvYmFsU3RhdGUuc2V0Q3VzdG9tQWN0aW9uKHsgdHlwZTogYEBEaXJ0eUNoZWNrIC0gUmV2ZXJ0YCB9KTtcbiAgICB0aGlzLnVwZGF0ZVN0b3JlKGN1cnJlbnRWYWx1ZSwgdGhpcy5fZW50aXR5SWQpO1xuICAgIHRoaXMuX3Jlc2V0Lm5leHQoKTtcbiAgfVxuXG4gIHNldEhlYWQoKSB7XG4gICAgaWYgKCF0aGlzLmFjdGl2ZSkge1xuICAgICAgdGhpcy5hY3RpdmF0ZSgpO1xuICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhlYWQgPSB0aGlzLl9nZXRIZWFkKCk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlRGlydGluZXNzKGZhbHNlKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGlzRGlydHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRvQm9vbGVhbih0aGlzLmRpcnR5LnZhbHVlKTtcbiAgfVxuXG4gIGhhc0hlYWQoKSB7XG4gICAgcmV0dXJuIHRvQm9vbGVhbih0aGlzLmdldEhlYWQoKSk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMuaGVhZCA9IG51bGw7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gJiYgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLl9yZXNldCAmJiB0aGlzLl9yZXNldC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgaXNQYXRoRGlydHkocGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgaGVhZCA9IHRoaXMuZ2V0SGVhZCgpO1xuICAgIGNvbnN0IGN1cnJlbnQgPSAodGhpcy5nZXRRdWVyeSgpIGFzIFF1ZXJ5PFN0b3JlU3RhdGU+KS5nZXRTbmFwc2hvdCgpO1xuICAgIGNvbnN0IGN1cnJlbnRQYXRoVmFsdWUgPSBnZXROZXN0ZWRQYXRoKGN1cnJlbnQsIHBhdGgpO1xuICAgIGNvbnN0IGhlYWRQYXRoVmFsdWUgPSBnZXROZXN0ZWRQYXRoKGhlYWQsIHBhdGgpO1xuXG4gICAgcmV0dXJuIHRoaXMucGFyYW1zLmNvbXBhcmF0b3IoY3VycmVudFBhdGhWYWx1ZSwgaGVhZFBhdGhWYWx1ZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0SGVhZCgpIHtcbiAgICByZXR1cm4gdGhpcy5oZWFkO1xuICB9XG5cbiAgcHJpdmF0ZSBhY3RpdmF0ZSgpIHtcbiAgICB0aGlzLmhlYWQgPSB0aGlzLl9nZXRIZWFkKCk7XG4gICAgLyoqIGlmIHdlIGFyZSB0cmFja2luZyBzcGVjaWZpYyBwcm9wZXJ0aWVzIHNlbGVjdCBvbmx5IHRoZSByZWxldmFudCBvbmVzICovXG4gICAgY29uc3Qgc291cmNlID0gdGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eVxuICAgICAgPyAodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSBhcyAoa2V5b2YgU3RvcmVTdGF0ZSlbXSkubWFwKHByb3AgPT5cbiAgICAgICAgICB0aGlzLnF1ZXJ5LnNlbGVjdChzdGF0ZSA9PiBzdGF0ZVtwcm9wXSkucGlwZShcbiAgICAgICAgICAgIG1hcCh2YWwgPT4gKHtcbiAgICAgICAgICAgICAgdmFsLFxuICAgICAgICAgICAgICBfX2FraXRhS2V5OiBwcm9wXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIDogW3RoaXMuc2VsZWN0U291cmNlKHRoaXMuX2VudGl0eUlkKV07XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSBjb21iaW5lTGF0ZXN0KC4uLnNvdXJjZSlcbiAgICAgIC5waXBlKHNraXAoMSkpXG4gICAgICAuc3Vic2NyaWJlKChjdXJyZW50U3RhdGU6IGFueVtdKSA9PiB7XG4gICAgICAgIGlmIChpc1VuZGVmaW5lZCh0aGlzLmhlYWQpKSByZXR1cm47XG4gICAgICAgIC8qKiBfX2FraXRhS2V5IGlzIHVzZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIGFyZSB0cmFja2luZyBhIHNwZWNpZmljIHByb3BlcnR5IG9yIGEgc3RvcmUgY2hhbmdlICovXG4gICAgICAgIGNvbnN0IGlzQ2hhbmdlID0gY3VycmVudFN0YXRlLnNvbWUoc3RhdGUgPT4ge1xuICAgICAgICAgIGNvbnN0IGhlYWQgPSBzdGF0ZS5fX2FraXRhS2V5ID8gdGhpcy5oZWFkW3N0YXRlLl9fYWtpdGFLZXkgYXMgYW55XSA6IHRoaXMuaGVhZDtcbiAgICAgICAgICBjb25zdCBjb21wYXJlVG8gPSBzdGF0ZS5fX2FraXRhS2V5ID8gc3RhdGUudmFsIDogc3RhdGU7XG5cbiAgICAgICAgICByZXR1cm4gdGhpcy5wYXJhbXMuY29tcGFyYXRvcihoZWFkLCBjb21wYXJlVG8pO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnVwZGF0ZURpcnRpbmVzcyhpc0NoYW5nZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlRGlydGluZXNzKGlzRGlydHk6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmRpcnR5Lm5leHQoaXNEaXJ0eSk7XG4gIH1cblxuICBwcml2YXRlIF9nZXRIZWFkKCk6IEhlYWQ8U3RvcmVTdGF0ZSwgRW50aXR5PiB7XG4gICAgbGV0IGhlYWQ6IEhlYWQ8U3RvcmVTdGF0ZSwgRW50aXR5PiA9IHRoaXMuZ2V0U291cmNlKHRoaXMuX2VudGl0eUlkKTtcbiAgICBpZiAodGhpcy5wYXJhbXMud2F0Y2hQcm9wZXJ0eSkge1xuICAgICAgaGVhZCA9IHRoaXMuZ2V0V2F0Y2hlZFZhbHVlcyhoZWFkIGFzIFN0b3JlU3RhdGUpO1xuICAgIH1cbiAgICByZXR1cm4gaGVhZDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0V2F0Y2hlZFZhbHVlcyhzb3VyY2U6IFN0b3JlU3RhdGUpOiBQYXJ0aWFsPFN0b3JlU3RhdGU+IHtcbiAgICByZXR1cm4gKHRoaXMucGFyYW1zLndhdGNoUHJvcGVydHkgYXMgKGtleW9mIFN0b3JlU3RhdGUpW10pLnJlZHVjZShcbiAgICAgICh3YXRjaGVkLCBwcm9wKSA9PiB7XG4gICAgICAgIHdhdGNoZWRbcHJvcF0gPSBzb3VyY2VbcHJvcF07XG4gICAgICAgIHJldHVybiB3YXRjaGVkO1xuICAgICAgfSxcbiAgICAgIHt9IGFzIFBhcnRpYWw8U3RvcmVTdGF0ZT5cbiAgICApO1xuICB9XG59XG4iXX0=