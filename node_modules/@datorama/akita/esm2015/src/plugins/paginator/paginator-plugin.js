/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { delay, map, switchMap, take } from 'rxjs/operators';
import { BehaviorSubject, from } from 'rxjs';
import { isObservable, isUndefined } from '../../internal/utils';
import { AkitaPlugin } from '../plugin';
import { applyTransaction } from '../../api/transaction';
import { action, applyAction } from '../../internal/action';
/**
 * @record
 * @template E
 */
export function PaginationResponse() { }
if (false) {
    /** @type {?} */
    PaginationResponse.prototype.currentPage;
    /** @type {?} */
    PaginationResponse.prototype.perPage;
    /** @type {?} */
    PaginationResponse.prototype.lastPage;
    /** @type {?} */
    PaginationResponse.prototype.data;
    /** @type {?|undefined} */
    PaginationResponse.prototype.total;
    /** @type {?|undefined} */
    PaginationResponse.prototype.from;
    /** @type {?|undefined} */
    PaginationResponse.prototype.to;
    /** @type {?|undefined} */
    PaginationResponse.prototype.pageControls;
}
/** @type {?} */
const paginatorDefaults = {
    pagesControls: false,
    range: false,
    startWith: 1,
    cacheTimeout: undefined
};
/**
 * @template E
 */
export class PaginatorPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} config
     */
    constructor(query, config = {}) {
        super(query, {
            resetFn: () => {
                this.initial = false;
                this.destroy({ clearCache: true, currentPage: 1 });
            }
        });
        this.query = query;
        this.config = config;
        /**
         * Save current filters, sorting, etc. in cache
         */
        this.metadata = new Map();
        this.pages = new Map();
        this.pagination = {
            currentPage: 1,
            perPage: 0,
            total: 0,
            lastPage: 0,
            data: []
        };
        /**
         * When the user navigates to a different page and return
         * we don't want to call `clearCache` on first time.
         */
        this.initial = false;
        /**
         * Proxy to the query loading
         */
        this.isLoading$ = this.query.selectLoading().pipe(delay(0));
        this.config = Object.assign(paginatorDefaults, config);
        const { startWith, cacheTimeout } = this.config;
        this.page = new BehaviorSubject(startWith);
        if (isObservable(cacheTimeout)) {
            this.clearCacheSubscription = cacheTimeout.subscribe(_ => this.clearCache());
        }
    }
    /**
     * Listen to page changes
     * @return {?}
     */
    get pageChanges() {
        return this.page.asObservable();
    }
    /**
     * Get the current page number
     * @return {?}
     */
    get currentPage() {
        return this.pagination.currentPage;
    }
    /**
     * Check if current page is the first one
     * @return {?}
     */
    get isFirst() {
        return this.currentPage === 1;
    }
    /**
     * Check if current page is the last one
     * @return {?}
     */
    get isLast() {
        return this.currentPage === this.pagination.lastPage;
    }
    /**
     * Whether to generate an array of pages for *ngFor
     * [1, 2, 3, 4]
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    withControls() {
        (/** @type {?} */ (this)).config.pagesControls = true;
        return (/** @type {?} */ (this));
    }
    /**
     * Whether to generate the `from` and `to` keys
     * [1, 2, 3, 4]
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    withRange() {
        (/** @type {?} */ (this)).config.range = true;
        return (/** @type {?} */ (this));
    }
    /**
     * Set the loading state
     * @param {?=} value
     * @return {?}
     */
    setLoading(value = true) {
        this.getStore().setLoading(value);
    }
    /**
     * Update the pagination object and add the page
     * @param {?} response
     * @return {?}
     */
    update(response) {
        this.pagination = response;
        this.addPage(response.data);
    }
    /**
     *
     * Set the ids and add the page to store
     * @param {?} data
     * @return {?}
     */
    addPage(data) {
        this.pages.set(this.currentPage, { ids: data.map(entity => entity[this.getStore().idKey]) });
        this.getStore().add(data);
    }
    /**
     * Clear the cache.
     * @return {?}
     */
    clearCache() {
        if (!this.initial) {
            applyAction(() => {
                this.getStore().remove();
            }, { type: '@Pagination - Clear Cache' });
            this.pages = new Map();
            this.metadata = new Map();
        }
        this.initial = false;
    }
    /**
     * @param {?} page
     * @return {?}
     */
    clearPage(page) {
        this.pages.delete(page);
    }
    /**
     * Clear the cache timeout and optionally the pages
     * @param {?=} __0
     * @return {?}
     */
    destroy({ clearCache, currentPage } = {}) {
        if (this.clearCacheSubscription) {
            this.clearCacheSubscription.unsubscribe();
        }
        if (clearCache) {
            this.clearCache();
        }
        if (!isUndefined(currentPage)) {
            this.setPage(currentPage);
        }
        this.initial = true;
    }
    /**
     * Whether the provided page is active
     * @param {?} page
     * @return {?}
     */
    isPageActive(page) {
        return this.currentPage === page;
    }
    /**
     * Set the current page
     * @param {?} page
     * @return {?}
     */
    setPage(page) {
        if (page !== this.currentPage || !this.hasPage(page)) {
            this.page.next((this.pagination.currentPage = page));
        }
    }
    /**
     * Increment current page
     * @return {?}
     */
    nextPage() {
        if (this.currentPage !== this.pagination.lastPage) {
            this.setPage(this.pagination.currentPage + 1);
        }
    }
    /**
     * Decrement current page
     * @return {?}
     */
    prevPage() {
        if (this.pagination.currentPage > 1) {
            this.setPage(this.pagination.currentPage - 1);
        }
    }
    /**
     * Set current page to last
     * @return {?}
     */
    setLastPage() {
        this.setPage(this.pagination.lastPage);
    }
    /**
     * Set current page to first
     * @return {?}
     */
    setFirstPage() {
        this.setPage(1);
    }
    /**
     * Check if page exists in cache
     * @param {?} page
     * @return {?}
     */
    hasPage(page) {
        return this.pages.has(page);
    }
    /**
     * Get the current page if it's in cache, otherwise invoke the request
     * @param {?} req
     * @return {?}
     */
    getPage(req) {
        /** @type {?} */
        const page = this.pagination.currentPage;
        if (this.hasPage(page)) {
            return this.selectPage(page);
        }
        else {
            this.setLoading(true);
            return from(req()).pipe(switchMap((config) => {
                applyTransaction(() => {
                    this.setLoading(false);
                    this.update(config);
                });
                return this.selectPage(page);
            }));
        }
    }
    /**
     * @return {?}
     */
    getQuery() {
        return this.query;
    }
    /**
     * @return {?}
     */
    getFrom() {
        if (this.isFirst) {
            return 1;
        }
        return (this.currentPage - 1) * this.pagination.perPage + 1;
    }
    /**
     * @return {?}
     */
    getTo() {
        return this.currentPage * this.pagination.perPage;
    }
    /**
     * Select the page
     * @param {?} page
     * @return {?}
     */
    selectPage(page) {
        return this.query.selectAll({ asObject: true }).pipe(take(1), map(entities => {
            /** @type {?} */
            let response = Object.assign({}, this.pagination, { data: this.pages.get(page).ids.map(id => entities[id]) });
            const { range, pagesControls } = this.config;
            /** If no total - calc it */
            if (isNaN(this.pagination.total)) {
                if (response.lastPage === 1) {
                    response.total = response.data ? response.data.length : 0;
                }
                else {
                    response.total = response.perPage * response.lastPage;
                }
                this.pagination.total = response.total;
            }
            if (range) {
                response.from = this.getFrom();
                response.to = this.getTo();
            }
            if (pagesControls) {
                response.pageControls = generatePages(this.pagination.total, this.pagination.perPage);
            }
            return response;
        }));
    }
}
tslib_1.__decorate([
    action({ type: '@Pagination - New Page' }, true),
    tslib_1.__metadata("design:type", Function),
    tslib_1.__metadata("design:paramtypes", [Object]),
    tslib_1.__metadata("design:returntype", void 0)
], PaginatorPlugin.prototype, "update", null);
if (false) {
    /**
     * Save current filters, sorting, etc. in cache
     * @type {?}
     */
    PaginatorPlugin.prototype.metadata;
    /** @type {?} */
    PaginatorPlugin.prototype.page;
    /** @type {?} */
    PaginatorPlugin.prototype.pages;
    /** @type {?} */
    PaginatorPlugin.prototype.clearCacheSubscription;
    /** @type {?} */
    PaginatorPlugin.prototype.pagination;
    /**
     * When the user navigates to a different page and return
     * we don't want to call `clearCache` on first time.
     * @type {?}
     */
    PaginatorPlugin.prototype.initial;
    /**
     * Proxy to the query loading
     * @type {?}
     */
    PaginatorPlugin.prototype.isLoading$;
    /** @type {?} */
    PaginatorPlugin.prototype.query;
    /** @type {?} */
    PaginatorPlugin.prototype.config;
}
/**
 * Generate an array so we can ngFor them to navigate between pages
 * @param {?} total
 * @param {?} perPage
 * @return {?}
 */
function generatePages(total, perPage) {
    /** @type {?} */
    const len = Math.ceil(total / perPage);
    /** @type {?} */
    let arr = [];
    for (let i = 0; i < len; i++) {
        arr.push(i + 1);
    }
    return arr;
}
/**
 * backward compatibility
 * @type {?}
 */
export const Paginator = PaginatorPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdG9yLXBsdWdpbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9wbHVnaW5zL3BhZ2luYXRvci9wYWdpbmF0b3ItcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdELE9BQU8sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUE0QixNQUFNLE1BQU0sQ0FBQztBQUN2RSxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRWpFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDeEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7Ozs7QUFFNUQsd0NBU0M7OztJQVJDLHlDQUFvQjs7SUFDcEIscUNBQWdCOztJQUNoQixzQ0FBaUI7O0lBQ2pCLGtDQUFVOztJQUNWLG1DQUFlOztJQUNmLGtDQUFjOztJQUNkLGdDQUFZOztJQUNaLDBDQUF3Qjs7O01BVXBCLGlCQUFpQixHQUFvQjtJQUN6QyxhQUFhLEVBQUUsS0FBSztJQUNwQixLQUFLLEVBQUUsS0FBSztJQUNaLFNBQVMsRUFBRSxDQUFDO0lBQ1osWUFBWSxFQUFFLFNBQVM7Q0FDeEI7Ozs7QUFFRCxNQUFNLE9BQU8sZUFBbUIsU0FBUSxXQUFjOzs7OztJQXNCcEQsWUFBc0IsS0FBMEIsRUFBUyxTQUEwQixFQUFFO1FBQ25GLEtBQUssQ0FBQyxLQUFLLEVBQUU7WUFDWCxPQUFPLEVBQUUsR0FBRyxFQUFFO2dCQUNaLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO2dCQUNyQixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUs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QUFzRDs7SUFFdEQscUNBTUU7Ozs7OztJQU1GLGtDQUF3Qjs7Ozs7SUFvQnhCLHFDQUF1RDs7SUFsQjNDLGdDQUFvQzs7SUFBRSxpQ0FBbUM7Ozs7Ozs7O0FBcVF2RixTQUFTLGFBQWEsQ0FBQyxLQUFhLEVBQUUsT0FBZTs7VUFDN0MsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQzs7UUFDbEMsR0FBRyxHQUFHLEVBQUU7SUFDWixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQzVCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0tBQ2pCO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDOzs7OztBQUdELE1BQU0sT0FBTyxTQUFTLEdBQUcsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5RW50aXR5IH0gZnJvbSAnLi4vLi4vYXBpL3F1ZXJ5LWVudGl0eSc7XG5pbXBvcnQgeyBkZWxheSwgbWFwLCBzd2l0Y2hNYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGZyb20sIE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgaXNPYnNlcnZhYmxlLCBpc1VuZGVmaW5lZCB9IGZyb20gJy4uLy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IElEIH0gZnJvbSAnLi4vLi4vYXBpL3R5cGVzJztcbmltcG9ydCB7IEFraXRhUGx1Z2luIH0gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCB7IGFwcGx5VHJhbnNhY3Rpb24gfSBmcm9tICcuLi8uLi9hcGkvdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHsgYWN0aW9uLCBhcHBseUFjdGlvbiB9IGZyb20gJy4uLy4uL2ludGVybmFsL2FjdGlvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGFnaW5hdGlvblJlc3BvbnNlPEU+IHtcbiAgY3VycmVudFBhZ2U6IG51bWJlcjtcbiAgcGVyUGFnZTogbnVtYmVyO1xuICBsYXN0UGFnZTogbnVtYmVyO1xuICBkYXRhOiBFW107XG4gIHRvdGFsPzogbnVtYmVyO1xuICBmcm9tPzogbnVtYmVyO1xuICB0bz86IG51bWJlcjtcbiAgcGFnZUNvbnRyb2xzPzogbnVtYmVyW107XG59XG5cbmV4cG9ydCB0eXBlIFBhZ2luYXRvckNvbmZpZyA9IHtcbiAgcGFnZXNDb250cm9scz86IGJvb2xlYW47XG4gIHJhbmdlPzogYm9vbGVhbjtcbiAgc3RhcnRXaXRoPzogbnVtYmVyO1xuICBjYWNoZVRpbWVvdXQ/OiBPYnNlcnZhYmxlPG51bWJlcj47XG59O1xuXG5jb25zdCBwYWdpbmF0b3JEZWZhdWx0czogUGFnaW5hdG9yQ29uZmlnID0ge1xuICBwYWdlc0NvbnRyb2xzOiBmYWxzZSxcbiAgcmFuZ2U6IGZhbHNlLFxuICBzdGFydFdpdGg6IDEsXG4gIGNhY2hlVGltZW91dDogdW5kZWZpbmVkXG59O1xuXG5leHBvcnQgY2xhc3MgUGFnaW5hdG9yUGx1Z2luPEU+IGV4dGVuZHMgQWtpdGFQbHVnaW48RT4ge1xuICAvKiogU2F2ZSBjdXJyZW50IGZpbHRlcnMsIHNvcnRpbmcsIGV0Yy4gaW4gY2FjaGUgKi9cbiAgbWV0YWRhdGEgPSBuZXcgTWFwKCk7XG5cbiAgcHJpdmF0ZSBwYWdlOiBCZWhhdmlvclN1YmplY3Q8bnVtYmVyPjtcbiAgcHJpdmF0ZSBwYWdlcyA9IG5ldyBNYXA8bnVtYmVyLCB7IGlkczogSURbXSB9PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGNsZWFyQ2FjaGVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBwcml2YXRlIHBhZ2luYXRpb246IFBhZ2luYXRpb25SZXNwb25zZTxFPiA9IHtcbiAgICBjdXJyZW50UGFnZTogMSxcbiAgICBwZXJQYWdlOiAwLFxuICAgIHRvdGFsOiAwLFxuICAgIGxhc3RQYWdlOiAwLFxuICAgIGRhdGE6IFtdXG4gIH07XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhlIHVzZXIgbmF2aWdhdGVzIHRvIGEgZGlmZmVyZW50IHBhZ2UgYW5kIHJldHVyblxuICAgKiB3ZSBkb24ndCB3YW50IHRvIGNhbGwgYGNsZWFyQ2FjaGVgIG9uIGZpcnN0IHRpbWUuXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWwgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJ5RW50aXR5PGFueSwgRT4sIHB1YmxpYyBjb25maWc6IFBhZ2luYXRvckNvbmZpZyA9IHt9KSB7XG4gICAgc3VwZXIocXVlcnksIHtcbiAgICAgIHJlc2V0Rm46ICgpID0+IHtcbiAgICAgICAgdGhpcy5pbml0aWFsID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZGVzdHJveSh7IGNsZWFyQ2FjaGU6IHRydWUsIGN1cnJlbnRQYWdlOiAxIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbihwYWdpbmF0b3JEZWZhdWx0cywgY29uZmlnKTtcbiAgICBjb25zdCB7IHN0YXJ0V2l0aCwgY2FjaGVUaW1lb3V0IH0gPSB0aGlzLmNvbmZpZztcbiAgICB0aGlzLnBhZ2UgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KHN0YXJ0V2l0aCk7XG4gICAgaWYgKGlzT2JzZXJ2YWJsZShjYWNoZVRpbWVvdXQpKSB7XG4gICAgICB0aGlzLmNsZWFyQ2FjaGVTdWJzY3JpcHRpb24gPSBjYWNoZVRpbWVvdXQuc3Vic2NyaWJlKF8gPT4gdGhpcy5jbGVhckNhY2hlKCkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQcm94eSB0byB0aGUgcXVlcnkgbG9hZGluZ1xuICAgKi9cbiAgaXNMb2FkaW5nJCA9IHRoaXMucXVlcnkuc2VsZWN0TG9hZGluZygpLnBpcGUoZGVsYXkoMCkpO1xuXG4gIC8qKlxuICAgKiBMaXN0ZW4gdG8gcGFnZSBjaGFuZ2VzXG4gICAqL1xuICBnZXQgcGFnZUNoYW5nZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMucGFnZS5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGN1cnJlbnQgcGFnZSBudW1iZXJcbiAgICovXG4gIGdldCBjdXJyZW50UGFnZSgpIHtcbiAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uLmN1cnJlbnRQYWdlO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGN1cnJlbnQgcGFnZSBpcyB0aGUgZmlyc3Qgb25lXG4gICAqL1xuICBnZXQgaXNGaXJzdCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50UGFnZSA9PT0gMTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjdXJyZW50IHBhZ2UgaXMgdGhlIGxhc3Qgb25lXG4gICAqL1xuICBnZXQgaXNMYXN0KCkge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRQYWdlID09PSB0aGlzLnBhZ2luYXRpb24ubGFzdFBhZ2U7XG4gIH1cblxuICAvKipcbiAgICogV2hldGhlciB0byBnZW5lcmF0ZSBhbiBhcnJheSBvZiBwYWdlcyBmb3IgKm5nRm9yXG4gICAqIFsxLCAyLCAzLCA0XVxuICAgKi9cbiAgd2l0aENvbnRyb2xzKCkge1xuICAgIHRoaXMuY29uZmlnLnBhZ2VzQ29udHJvbHMgPSB0cnVlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8gZ2VuZXJhdGUgdGhlIGBmcm9tYCBhbmQgYHRvYCBrZXlzXG4gICAqIFsxLCAyLCAzLCA0XVxuICAgKi9cbiAgd2l0aFJhbmdlKCkge1xuICAgIHRoaXMuY29uZmlnLnJhbmdlID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGxvYWRpbmcgc3RhdGVcbiAgICovXG4gIHNldExvYWRpbmcodmFsdWUgPSB0cnVlKSB7XG4gICAgdGhpcy5nZXRTdG9yZSgpLnNldExvYWRpbmcodmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgcGFnaW5hdGlvbiBvYmplY3QgYW5kIGFkZCB0aGUgcGFnZVxuICAgKi9cbiAgQGFjdGlvbih7IHR5cGU6ICdAUGFnaW5hdGlvbiAtIE5ldyBQYWdlJyB9LCB0cnVlKVxuICB1cGRhdGUocmVzcG9uc2U6IFBhZ2luYXRpb25SZXNwb25zZTxFPikge1xuICAgIHRoaXMucGFnaW5hdGlvbiA9IHJlc3BvbnNlO1xuICAgIHRoaXMuYWRkUGFnZShyZXNwb25zZS5kYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBTZXQgdGhlIGlkcyBhbmQgYWRkIHRoZSBwYWdlIHRvIHN0b3JlXG4gICAqL1xuICBhZGRQYWdlKGRhdGE6IEVbXSkge1xuICAgIHRoaXMucGFnZXMuc2V0KHRoaXMuY3VycmVudFBhZ2UsIHsgaWRzOiBkYXRhLm1hcChlbnRpdHkgPT4gZW50aXR5W3RoaXMuZ2V0U3RvcmUoKS5pZEtleV0pIH0pO1xuICAgIHRoaXMuZ2V0U3RvcmUoKS5hZGQoZGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIGNhY2hlLlxuICAgKi9cbiAgY2xlYXJDYWNoZSgpIHtcbiAgICBpZiAoIXRoaXMuaW5pdGlhbCkge1xuICAgICAgYXBwbHlBY3Rpb24oXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICB0aGlzLmdldFN0b3JlKCkucmVtb3ZlKCk7XG4gICAgICAgIH0sXG4gICAgICAgIHsgdHlwZTogJ0BQYWdpbmF0aW9uIC0gQ2xlYXIgQ2FjaGUnIH1cbiAgICAgICk7XG4gICAgICB0aGlzLnBhZ2VzID0gbmV3IE1hcCgpO1xuICAgICAgdGhpcy5tZXRhZGF0YSA9IG5ldyBNYXAoKTtcbiAgICB9XG4gICAgdGhpcy5pbml0aWFsID0gZmFsc2U7XG4gIH1cblxuICBjbGVhclBhZ2UocGFnZTogbnVtYmVyKSB7XG4gICAgdGhpcy5wYWdlcy5kZWxldGUocGFnZSk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgdGhlIGNhY2hlIHRpbWVvdXQgYW5kIG9wdGlvbmFsbHkgdGhlIHBhZ2VzXG4gICAqL1xuICBkZXN0cm95KHsgY2xlYXJDYWNoZSwgY3VycmVudFBhZ2UgfTogeyBjbGVhckNhY2hlPzogYm9vbGVhbjsgY3VycmVudFBhZ2U/OiBudW1iZXIgfSA9IHt9KSB7XG4gICAgaWYgKHRoaXMuY2xlYXJDYWNoZVN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5jbGVhckNhY2hlU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICAgIGlmIChjbGVhckNhY2hlKSB7XG4gICAgICB0aGlzLmNsZWFyQ2FjaGUoKTtcbiAgICB9XG4gICAgaWYgKCFpc1VuZGVmaW5lZChjdXJyZW50UGFnZSkpIHtcbiAgICAgIHRoaXMuc2V0UGFnZShjdXJyZW50UGFnZSk7XG4gICAgfVxuICAgIHRoaXMuaW5pdGlhbCA9IHRydWU7XG4gIH1cblxuICAvKipcbiAgICogV2hldGhlciB0aGUgcHJvdmlkZWQgcGFnZSBpcyBhY3RpdmVcbiAgICovXG4gIGlzUGFnZUFjdGl2ZShwYWdlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50UGFnZSA9PT0gcGFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGN1cnJlbnQgcGFnZVxuICAgKi9cbiAgc2V0UGFnZShwYWdlOiBudW1iZXIpIHtcbiAgICBpZiAocGFnZSAhPT0gdGhpcy5jdXJyZW50UGFnZSB8fCAhdGhpcy5oYXNQYWdlKHBhZ2UpKSB7XG4gICAgICB0aGlzLnBhZ2UubmV4dCgodGhpcy5wYWdpbmF0aW9uLmN1cnJlbnRQYWdlID0gcGFnZSkpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbmNyZW1lbnQgY3VycmVudCBwYWdlXG4gICAqL1xuICBuZXh0UGFnZSgpIHtcbiAgICBpZiAodGhpcy5jdXJyZW50UGFnZSAhPT0gdGhpcy5wYWdpbmF0aW9uLmxhc3RQYWdlKSB7XG4gICAgICB0aGlzLnNldFBhZ2UodGhpcy5wYWdpbmF0aW9uLmN1cnJlbnRQYWdlICsgMSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlY3JlbWVudCBjdXJyZW50IHBhZ2VcbiAgICovXG4gIHByZXZQYWdlKCkge1xuICAgIGlmICh0aGlzLnBhZ2luYXRpb24uY3VycmVudFBhZ2UgPiAxKSB7XG4gICAgICB0aGlzLnNldFBhZ2UodGhpcy5wYWdpbmF0aW9uLmN1cnJlbnRQYWdlIC0gMSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBjdXJyZW50IHBhZ2UgdG8gbGFzdFxuICAgKi9cbiAgc2V0TGFzdFBhZ2UoKSB7XG4gICAgdGhpcy5zZXRQYWdlKHRoaXMucGFnaW5hdGlvbi5sYXN0UGFnZSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGN1cnJlbnQgcGFnZSB0byBmaXJzdFxuICAgKi9cbiAgc2V0Rmlyc3RQYWdlKCkge1xuICAgIHRoaXMuc2V0UGFnZSgxKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBwYWdlIGV4aXN0cyBpbiBjYWNoZVxuICAgKi9cbiAgaGFzUGFnZShwYWdlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5wYWdlcy5oYXMocGFnZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBjdXJyZW50IHBhZ2UgaWYgaXQncyBpbiBjYWNoZSwgb3RoZXJ3aXNlIGludm9rZSB0aGUgcmVxdWVzdFxuICAgKi9cbiAgZ2V0UGFnZShyZXE6ICgpID0+IE9ic2VydmFibGU8UGFnaW5hdGlvblJlc3BvbnNlPEU+Pikge1xuICAgIGNvbnN0IHBhZ2UgPSB0aGlzLnBhZ2luYXRpb24uY3VycmVudFBhZ2U7XG4gICAgaWYgKHRoaXMuaGFzUGFnZShwYWdlKSkge1xuICAgICAgcmV0dXJuIHRoaXMuc2VsZWN0UGFnZShwYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXRMb2FkaW5nKHRydWUpO1xuICAgICAgcmV0dXJuIGZyb20ocmVxKCkpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoY29uZmlnOiBQYWdpbmF0aW9uUmVzcG9uc2U8RT4pID0+IHtcbiAgICAgICAgICBhcHBseVRyYW5zYWN0aW9uKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuc2V0TG9hZGluZyhmYWxzZSk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZShjb25maWcpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiB0aGlzLnNlbGVjdFBhZ2UocGFnZSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGdldFF1ZXJ5KCk6IFF1ZXJ5RW50aXR5PGFueSwgRT4ge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGcm9tKCkge1xuICAgIGlmICh0aGlzLmlzRmlyc3QpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgICByZXR1cm4gKHRoaXMuY3VycmVudFBhZ2UgLSAxKSAqIHRoaXMucGFnaW5hdGlvbi5wZXJQYWdlICsgMTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VG8oKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFBhZ2UgKiB0aGlzLnBhZ2luYXRpb24ucGVyUGFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIHBhZ2VcbiAgICovXG4gIHByaXZhdGUgc2VsZWN0UGFnZShwYWdlOiBudW1iZXIpOiBPYnNlcnZhYmxlPFBhZ2luYXRpb25SZXNwb25zZTxFPj4ge1xuICAgIHJldHVybiB0aGlzLnF1ZXJ5LnNlbGVjdEFsbCh7IGFzT2JqZWN0OiB0cnVlIH0pLnBpcGUoXG4gICAgICB0YWtlKDEpLFxuICAgICAgbWFwKGVudGl0aWVzID0+IHtcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBQYWdpbmF0aW9uUmVzcG9uc2U8RT4gPSB7XG4gICAgICAgICAgLi4udGhpcy5wYWdpbmF0aW9uLFxuICAgICAgICAgIGRhdGE6IHRoaXMucGFnZXMuZ2V0KHBhZ2UpLmlkcy5tYXAoaWQgPT4gZW50aXRpZXNbaWRdKVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHsgcmFuZ2UsIHBhZ2VzQ29udHJvbHMgfSA9IHRoaXMuY29uZmlnO1xuXG4gICAgICAgIC8qKiBJZiBubyB0b3RhbCAtIGNhbGMgaXQgKi9cbiAgICAgICAgaWYgKGlzTmFOKHRoaXMucGFnaW5hdGlvbi50b3RhbCkpIHtcbiAgICAgICAgICBpZiAocmVzcG9uc2UubGFzdFBhZ2UgPT09IDEpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLnRvdGFsID0gcmVzcG9uc2UuZGF0YSA/IHJlc3BvbnNlLmRhdGEubGVuZ3RoIDogMDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzcG9uc2UudG90YWwgPSByZXNwb25zZS5wZXJQYWdlICogcmVzcG9uc2UubGFzdFBhZ2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMucGFnaW5hdGlvbi50b3RhbCA9IHJlc3BvbnNlLnRvdGFsO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJhbmdlKSB7XG4gICAgICAgICAgcmVzcG9uc2UuZnJvbSA9IHRoaXMuZ2V0RnJvbSgpO1xuICAgICAgICAgIHJlc3BvbnNlLnRvID0gdGhpcy5nZXRUbygpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBhZ2VzQ29udHJvbHMpIHtcbiAgICAgICAgICByZXNwb25zZS5wYWdlQ29udHJvbHMgPSBnZW5lcmF0ZVBhZ2VzKHRoaXMucGFnaW5hdGlvbi50b3RhbCwgdGhpcy5wYWdpbmF0aW9uLnBlclBhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgICAgfSlcbiAgICApO1xuICB9XG59XG5cbi8qKlxuICogR2VuZXJhdGUgYW4gYXJyYXkgc28gd2UgY2FuIG5nRm9yIHRoZW0gdG8gbmF2aWdhdGUgYmV0d2VlbiBwYWdlc1xuICovXG5mdW5jdGlvbiBnZW5lcmF0ZVBhZ2VzKHRvdGFsOiBudW1iZXIsIHBlclBhZ2U6IG51bWJlcikge1xuICBjb25zdCBsZW4gPSBNYXRoLmNlaWwodG90YWwgLyBwZXJQYWdlKTtcbiAgbGV0IGFyciA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgYXJyLnB1c2goaSArIDEpO1xuICB9XG4gIHJldHVybiBhcnI7XG59XG5cbi8qKiBiYWNrd2FyZCBjb21wYXRpYmlsaXR5ICovXG5leHBvcnQgY29uc3QgUGFnaW5hdG9yID0gUGFnaW5hdG9yUGx1Z2luO1xuIl19