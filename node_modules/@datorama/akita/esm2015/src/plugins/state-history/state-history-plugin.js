/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { pairwise } from 'rxjs/operators';
import { __globalState } from '../../internal/global-state';
import { toBoolean } from '../../internal/utils';
import { AkitaPlugin } from '../plugin';
/**
 * @record
 */
export function StateHistoryParams() { }
if (false) {
    /** @type {?|undefined} */
    StateHistoryParams.prototype.maxAge;
}
/**
 * @template E, S
 */
export class StateHistoryPlugin extends AkitaPlugin {
    /**
     * @param {?} query
     * @param {?=} params
     * @param {?=} _entityId
     */
    constructor(query, params = {}, _entityId) {
        super(query, {
            resetFn: () => this.clear()
        });
        this.query = query;
        this.params = params;
        this._entityId = _entityId;
        /**
         * Allow skipping an update from outside
         */
        this.skip = false;
        this.history = {
            past: [],
            present: null,
            future: []
        };
        /**
         * Skip the update when redo/undo
         */
        this.skipUpdate = false;
        params.maxAge = toBoolean(params.maxAge) ? params.maxAge : 10;
        this.activate();
    }
    /**
     * @return {?}
     */
    get hasPast() {
        return this.history.past.length > 0;
    }
    /**
     * @return {?}
     */
    get hasFuture() {
        return this.history.future.length > 0;
    }
    /**
     * @return {?}
     */
    activate() {
        this.history.present = this.getSource(this._entityId);
        this.subscription = this.selectSource(this._entityId)
            .pipe(pairwise())
            .subscribe(([past, present]) => {
            if (this.skip) {
                this.skip = false;
                return;
            }
            if (!this.skipUpdate) {
                if (this.history.past.length === this.params.maxAge) {
                    this.history.past = this.history.past.slice(1);
                }
                this.history.past = [...this.history.past, past];
                this.history.present = present;
            }
        });
    }
    /**
     * @return {?}
     */
    undo() {
        if (this.history.past.length > 0) {
            const { past, present, future } = this.history;
            /** @type {?} */
            const previous = past[past.length - 1];
            /** @type {?} */
            const newPast = past.slice(0, past.length - 1);
            this.history.past = newPast;
            this.history.present = previous;
            this.history.future = [present, ...this.history.future];
            this.update();
        }
    }
    /**
     * @return {?}
     */
    redo() {
        if (this.history.future.length > 0) {
            const { past, present, future } = this.history;
            /** @type {?} */
            const next = this.history.future[0];
            /** @type {?} */
            const newFuture = this.history.future.slice(1);
            this.history.past = [...past, present];
            this.history.present = next;
            this.history.future = newFuture;
            this.update('Redo');
        }
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToPast(index) {
        if (index < 0 || index >= this.history.past.length)
            return;
        const { past, future } = this.history;
        /**
         *
         * const past = [1, 2, 3, 4, 5];
         *
         * newPast = past.slice(0, 2) = [1, 2];
         * present = past[index] = 3;
         * [...past.slice(2 + 1), ...future] = [4, 5];
         *
         * @type {?}
         */
        const newPast = past.slice(0, index);
        /** @type {?} */
        const newFuture = [...past.slice(index + 1), ...future];
        /** @type {?} */
        const newPresent = past[index];
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update();
    }
    /**
     * @param {?} index
     * @return {?}
     */
    jumpToFuture(index) {
        if (index < 0 || index >= this.history.future.length)
            return;
        const { past, future } = this.history;
        /** @type {?} */
        const newPast = [...past, ...future.slice(0, index)];
        /** @type {?} */
        const newPresent = future[index];
        /** @type {?} */
        const newFuture = future.slice(index + 1);
        this.history.past = newPast;
        this.history.present = newPresent;
        this.history.future = newFuture;
        this.update('Redo');
    }
    /**
     * @return {?}
     */
    clear() {
        this.history = {
            past: [],
            present: null,
            future: []
        };
    }
    /**
     * @param {?=} clearHistory
     * @return {?}
     */
    destroy(clearHistory = false) {
        if (clearHistory) {
            this.clear();
        }
        this.subscription.unsubscribe();
    }
    /**
     * @return {?}
     */
    ignoreNext() {
        this.skip = true;
    }
    /**
     * @param {?=} action
     * @return {?}
     */
    update(action = 'Undo') {
        this.skipUpdate = true;
        __globalState.setCustomAction({ type: `@StateHistory - ${action}` });
        this.updateStore(this.history.present, this._entityId);
        this.skipUpdate = false;
    }
}
if (false) {
    /**
     * Allow skipping an update from outside
     * @type {?}
     */
    StateHistoryPlugin.prototype.skip;
    /** @type {?} */
    StateHistoryPlugin.prototype.history;
    /**
     * Skip the update when redo/undo
     * @type {?}
     */
    StateHistoryPlugin.prototype.skipUpdate;
    /** @type {?} */
    StateHistoryPlugin.prototype.subscription;
    /** @type {?} */
    StateHistoryPlugin.prototype.query;
    /** @type {?} */
    StateHistoryPlugin.prototype.params;
    /** @type {?} */
    StateHistoryPlugin.prototype._entityId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtaGlzdG9yeS1wbHVnaW4uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvcGx1Z2lucy9zdGF0ZS1oaXN0b3J5L3N0YXRlLWhpc3RvcnktcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQVUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFXLE1BQU0sV0FBVyxDQUFDOzs7O0FBR2pELHdDQUVDOzs7SUFEQyxvQ0FBZ0I7Ozs7O0FBR2xCLE1BQU0sT0FBTyxrQkFBcUMsU0FBUSxXQUFpQjs7Ozs7O0lBY3pFLFlBQXNCLEtBQW9CLEVBQVUsU0FBNkIsRUFBRSxFQUFVLFNBQXVCO1FBQ2xILEtBQUssQ0FBQyxLQUFLLEVBQUU7WUFDWCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtTQUM1QixDQUFDLENBQUM7UUFIaUIsVUFBSyxHQUFMLEtBQUssQ0FBZTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQXlCO1FBQVUsY0FBUyxHQUFULFNBQVMsQ0FBYzs7OztRQVo1RyxTQUFJLEdBQUcsS0FBSyxDQUFDO1FBRWIsWUFBTyxHQUFHO1lBQ2hCLElBQUksRUFBRSxFQUFFO1lBQ1IsT0FBTyxFQUFFLElBQUk7WUFDYixNQUFNLEVBQUUsRUFBRTtTQUNYLENBQUM7Ozs7UUFHTSxlQUFVLEdBQUcsS0FBSyxDQUFDO1FBT3pCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxR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Rix3Q0FBMkI7O0lBQzNCLDBDQUFxQjs7SUFFVCxtQ0FBOEI7O0lBQUUsb0NBQXVDOztJQUFFLHVDQUErQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZpbHRlciwgcGFpcndpc2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcbmltcG9ydCB7IHRvQm9vbGVhbiB9IGZyb20gJy4uLy4uL2ludGVybmFsL3V0aWxzJztcbmltcG9ydCB7IEFraXRhUGx1Z2luLCBRdWVyaWVzIH0gZnJvbSAnLi4vcGx1Z2luJztcbmltcG9ydCB7IEVudGl0eVBhcmFtIH0gZnJvbSAnLi4vZW50aXR5LWNvbGxlY3Rpb24tcGx1Z2luJztcblxuZXhwb3J0IGludGVyZmFjZSBTdGF0ZUhpc3RvcnlQYXJhbXMge1xuICBtYXhBZ2U/OiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBTdGF0ZUhpc3RvcnlQbHVnaW48RSA9IGFueSwgUyA9IGFueT4gZXh0ZW5kcyBBa2l0YVBsdWdpbjxFLCBTPiB7XG4gIC8qKiBBbGxvdyBza2lwcGluZyBhbiB1cGRhdGUgZnJvbSBvdXRzaWRlICovXG4gIHByaXZhdGUgc2tpcCA9IGZhbHNlO1xuXG4gIHByaXZhdGUgaGlzdG9yeSA9IHtcbiAgICBwYXN0OiBbXSxcbiAgICBwcmVzZW50OiBudWxsLFxuICAgIGZ1dHVyZTogW11cbiAgfTtcblxuICAvKiogU2tpcCB0aGUgdXBkYXRlIHdoZW4gcmVkby91bmRvICovXG4gIHByaXZhdGUgc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcXVlcnk6IFF1ZXJpZXM8RSwgUz4sIHByaXZhdGUgcGFyYW1zOiBTdGF0ZUhpc3RvcnlQYXJhbXMgPSB7fSwgcHJpdmF0ZSBfZW50aXR5SWQ/OiBFbnRpdHlQYXJhbSkge1xuICAgIHN1cGVyKHF1ZXJ5LCB7XG4gICAgICByZXNldEZuOiAoKSA9PiB0aGlzLmNsZWFyKClcbiAgICB9KTtcbiAgICBwYXJhbXMubWF4QWdlID0gdG9Cb29sZWFuKHBhcmFtcy5tYXhBZ2UpID8gcGFyYW1zLm1heEFnZSA6IDEwO1xuICAgIHRoaXMuYWN0aXZhdGUoKTtcbiAgfVxuXG4gIGdldCBoYXNQYXN0KCkge1xuICAgIHJldHVybiB0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPiAwO1xuICB9XG5cbiAgZ2V0IGhhc0Z1dHVyZSgpIHtcbiAgICByZXR1cm4gdGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGggPiAwO1xuICB9XG5cbiAgYWN0aXZhdGUoKSB7XG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSB0aGlzLmdldFNvdXJjZSh0aGlzLl9lbnRpdHlJZCk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLnNlbGVjdFNvdXJjZSh0aGlzLl9lbnRpdHlJZClcbiAgICAgIC5waXBlKHBhaXJ3aXNlKCkpXG4gICAgICAuc3Vic2NyaWJlKChbcGFzdCwgcHJlc2VudF0pID0+IHtcbiAgICAgICAgaWYgKHRoaXMuc2tpcCkge1xuICAgICAgICAgIHRoaXMuc2tpcCA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuc2tpcFVwZGF0ZSkge1xuICAgICAgICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPT09IHRoaXMucGFyYW1zLm1heEFnZSkge1xuICAgICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSB0aGlzLmhpc3RvcnkucGFzdC5zbGljZSgxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBbLi4udGhpcy5oaXN0b3J5LnBhc3QsIHBhc3RdO1xuICAgICAgICAgIHRoaXMuaGlzdG9yeS5wcmVzZW50ID0gcHJlc2VudDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gIH1cblxuICB1bmRvKCkge1xuICAgIGlmICh0aGlzLmhpc3RvcnkucGFzdC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQsIGZ1dHVyZSB9ID0gdGhpcy5oaXN0b3J5O1xuICAgICAgY29uc3QgcHJldmlvdXMgPSBwYXN0W3Bhc3QubGVuZ3RoIC0gMV07XG4gICAgICBjb25zdCBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCBwYXN0Lmxlbmd0aCAtIDEpO1xuXG4gICAgICB0aGlzLmhpc3RvcnkucGFzdCA9IG5ld1Bhc3Q7XG4gICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IHByZXZpb3VzO1xuICAgICAgdGhpcy5oaXN0b3J5LmZ1dHVyZSA9IFtwcmVzZW50LCAuLi50aGlzLmhpc3RvcnkuZnV0dXJlXTtcbiAgICAgIHRoaXMudXBkYXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcmVkbygpIHtcbiAgICBpZiAodGhpcy5oaXN0b3J5LmZ1dHVyZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB7IHBhc3QsIHByZXNlbnQsIGZ1dHVyZSB9ID0gdGhpcy5oaXN0b3J5O1xuICAgICAgY29uc3QgbmV4dCA9IHRoaXMuaGlzdG9yeS5mdXR1cmVbMF07XG4gICAgICBjb25zdCBuZXdGdXR1cmUgPSB0aGlzLmhpc3RvcnkuZnV0dXJlLnNsaWNlKDEpO1xuICAgICAgdGhpcy5oaXN0b3J5LnBhc3QgPSBbLi4ucGFzdCwgcHJlc2VudF07XG4gICAgICB0aGlzLmhpc3RvcnkucHJlc2VudCA9IG5leHQ7XG4gICAgICB0aGlzLmhpc3RvcnkuZnV0dXJlID0gbmV3RnV0dXJlO1xuICAgICAgdGhpcy51cGRhdGUoJ1JlZG8nKTtcbiAgICB9XG4gIH1cblxuICBqdW1wVG9QYXN0KGluZGV4OiBudW1iZXIpIHtcbiAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMuaGlzdG9yeS5wYXN0Lmxlbmd0aCkgcmV0dXJuO1xuXG4gICAgY29uc3QgeyBwYXN0LCBmdXR1cmUgfSA9IHRoaXMuaGlzdG9yeTtcbiAgICAvKipcbiAgICAgKlxuICAgICAqIGNvbnN0IHBhc3QgPSBbMSwgMiwgMywgNCwgNV07XG4gICAgICpcbiAgICAgKiBuZXdQYXN0ID0gcGFzdC5zbGljZSgwLCAyKSA9IFsxLCAyXTtcbiAgICAgKiBwcmVzZW50ID0gcGFzdFtpbmRleF0gPSAzO1xuICAgICAqIFsuLi5wYXN0LnNsaWNlKDIgKyAxKSwgLi4uZnV0dXJlXSA9IFs0LCA1XTtcbiAgICAgKlxuICAgICAqL1xuICAgIGNvbnN0IG5ld1Bhc3QgPSBwYXN0LnNsaWNlKDAsIGluZGV4KTtcbiAgICBjb25zdCBuZXdGdXR1cmUgPSBbLi4ucGFzdC5zbGljZShpbmRleCArIDEpLCAuLi5mdXR1cmVdO1xuICAgIGNvbnN0IG5ld1ByZXNlbnQgPSBwYXN0W2luZGV4XTtcbiAgICB0aGlzLmhpc3RvcnkucGFzdCA9IG5ld1Bhc3Q7XG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXdQcmVzZW50O1xuICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBuZXdGdXR1cmU7XG4gICAgdGhpcy51cGRhdGUoKTtcbiAgfVxuXG4gIGp1bXBUb0Z1dHVyZShpbmRleDogbnVtYmVyKSB7XG4gICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLmhpc3RvcnkuZnV0dXJlLmxlbmd0aCkgcmV0dXJuO1xuXG4gICAgY29uc3QgeyBwYXN0LCBmdXR1cmUgfSA9IHRoaXMuaGlzdG9yeTtcblxuICAgIGNvbnN0IG5ld1Bhc3QgPSBbLi4ucGFzdCwgLi4uZnV0dXJlLnNsaWNlKDAsIGluZGV4KV07XG4gICAgY29uc3QgbmV3UHJlc2VudCA9IGZ1dHVyZVtpbmRleF07XG4gICAgY29uc3QgbmV3RnV0dXJlID0gZnV0dXJlLnNsaWNlKGluZGV4ICsgMSk7XG5cbiAgICB0aGlzLmhpc3RvcnkucGFzdCA9IG5ld1Bhc3Q7XG4gICAgdGhpcy5oaXN0b3J5LnByZXNlbnQgPSBuZXdQcmVzZW50O1xuICAgIHRoaXMuaGlzdG9yeS5mdXR1cmUgPSBuZXdGdXR1cmU7XG4gICAgdGhpcy51cGRhdGUoJ1JlZG8nKTtcbiAgfVxuXG4gIGNsZWFyKCkge1xuICAgIHRoaXMuaGlzdG9yeSA9IHtcbiAgICAgIHBhc3Q6IFtdLFxuICAgICAgcHJlc2VudDogbnVsbCxcbiAgICAgIGZ1dHVyZTogW11cbiAgICB9O1xuICB9XG5cbiAgZGVzdHJveShjbGVhckhpc3RvcnkgPSBmYWxzZSkge1xuICAgIGlmIChjbGVhckhpc3RvcnkpIHtcbiAgICAgIHRoaXMuY2xlYXIoKTtcbiAgICB9XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIGlnbm9yZU5leHQoKSB7XG4gICAgdGhpcy5za2lwID0gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlKGFjdGlvbiA9ICdVbmRvJykge1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IHRydWU7XG4gICAgX19nbG9iYWxTdGF0ZS5zZXRDdXN0b21BY3Rpb24oeyB0eXBlOiBgQFN0YXRlSGlzdG9yeSAtICR7YWN0aW9ufWAgfSk7XG4gICAgdGhpcy51cGRhdGVTdG9yZSh0aGlzLmhpc3RvcnkucHJlc2VudCwgdGhpcy5fZW50aXR5SWQpO1xuICAgIHRoaXMuc2tpcFVwZGF0ZSA9IGZhbHNlO1xuICB9XG59XG4iXX0=