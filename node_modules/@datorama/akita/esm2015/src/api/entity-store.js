/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { _crud } from '../internal/crud';
import { AkitaImmutabilityError, assertActive } from '../internal/error';
import { __globalState } from '../internal/global-state';
import { coerceArray, entityExists, isFunction, isNil, isObject, toBoolean } from '../internal/utils';
import { isDev, Store } from './store';
/**
 * The Root Store that every sub store needs to inherit and
 * invoke `super` with the initial state.
 * @template S, E, ActiveEntity
 */
export class EntityStore extends Store {
    /**
     *
     * Initiate the store with the state
     * @param {?=} initialState
     * @param {?=} options
     */
    constructor(initialState = {}, options = {}) {
        super(Object.assign({}, getInitialEntitiesState(), initialState), options);
    }
    /**
     * @return {?}
     */
    get entities() {
        return this._value().entities;
    }
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     * this.store.set([Entity, Entity]);
     * this.store.set({1: Entity, 2: Entity});
     * this.store.set([{id: 1}, {id: 2}], { entityClass: Product });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    set(entities, options = {}) {
        isDev() && __globalState.setAction({ type: 'Set Entities' });
        this.setState(state => _crud._set(state, isNil(entities) ? [] : entities, options.entityClass, this.idKey));
        this.setDirty();
    }
    /**
     * Create or replace an entity in the store.
     *
     * \@example
     * this.store.createOrReplace(3, Entity);
     *
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    createOrReplace(id, entity) {
        if (!entityExists(id, this._value().entities)) {
            this.addWhenNotExists(id, entity);
        }
        else {
            isDev() && __globalState.setAction({ type: 'Create or Replace Entity', entityId: [id] });
            this.setState(state => _crud._replaceEntity(state, id, entity));
        }
    }
    /**
     *
     * Insert or Update
     * @param {?} id
     * @param {?} entityOrFn
     * @return {?}
     */
    upsert(id, entityOrFn) {
        if (!entityExists(id, this._value().entities)) {
            /** @type {?} */
            const resolve = isFunction(entityOrFn) ? ((/** @type {?} */ (entityOrFn)))({}) : entityOrFn;
            this.addWhenNotExists(id, resolve);
        }
        else {
            this.update(id, (/** @type {?} */ (entityOrFn)));
        }
    }
    /**
     * Add an entity or entities to the store.
     *
     * \@example
     * this.store.add([Entity, Entity]);
     * this.store.add(Entity);
     * this.store.add(Entity, { prepend: true });
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    add(entities, options) {
        /** @type {?} */
        const toArray = coerceArray(entities);
        if (toArray.length === 0)
            return;
        /**
         * If we pass entities that already exist, we should ignore them
         * @type {?}
         */
        const allExists = toArray.every(entity => this._value().ids.indexOf(entity[this.idKey]) > -1);
        if (allExists)
            return;
        isDev() && __globalState.setAction({ type: 'Add Entity' });
        this.setState(state => _crud._add(state, toArray, this.idKey, options));
    }
    /**
     * @param {?} idsOrFn
     * @param {?=} newStateOrFn
     * @return {?}
     */
    update(idsOrFn, newStateOrFn) {
        /** @type {?} */
        let ids = [];
        /** @type {?} */
        const storeIds = this._value().ids;
        if (isFunction(idsOrFn)) {
            for (let i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                const id = storeIds[i];
                /** @type {?} */
                const entity = this._value().entities[id];
                if (entity && ((/** @type {?} */ (idsOrFn)))(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = toBoolean(idsOrFn) ? coerceArray(idsOrFn) : storeIds;
        }
        if (ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Update Entity', entityId: ids });
        this.setState(state => {
            return _crud._update(state, ids, newStateOrFn, this.idKey);
        });
    }
    /**
     * An alias to update all.
     * @param {?} state
     * @return {?}
     */
    updateAll(state) {
        if (this._value().ids.length === 0)
            return;
        this.update(null, state);
    }
    /**
     * Update the root state (data which is external to the entities).
     *
     * \@example
     * this.store.updateRoot({
     *   metadata: 'new metadata
     * });
     *
     *  this.store.updateRoot(state => {
     *    return {
     *      metadata: {
     *        ...state.metadata,
     *        key: 'new value'
     *      }
     *    }
     *  });
     * @param {?} newStateFn
     * @param {?=} action
     * @return {?}
     */
    updateRoot(newStateFn, action) {
        /** @type {?} */
        const newState = isFunction(newStateFn) ? newStateFn(this._value()) : newStateFn;
        if (newState === this._value()) {
            throw new AkitaImmutabilityError(this.storeName);
        }
        isDev() && __globalState.setAction(action || { type: 'Update Root' });
        this.setState(state => {
            return Object.assign({}, ((/** @type {?} */ (state))), ((/** @type {?} */ (newState))));
        });
    }
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    remove(idsOrFn) {
        /** @type {?} */
        const storeIds = this._value().ids;
        if (storeIds.length === 0)
            return;
        /** @type {?} */
        const idPassed = toBoolean(idsOrFn);
        if (!idPassed)
            this.setPristine();
        /** @type {?} */
        let ids = [];
        if (isFunction(idsOrFn)) {
            for (let i = 0, len = storeIds.length; i < len; i++) {
                /** @type {?} */
                const id = storeIds[i];
                /** @type {?} */
                const entity = this._value().entities[id];
                if (entity && idsOrFn(entity)) {
                    ids.push(id);
                }
            }
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (ids && ids.length === 0)
            return;
        isDev() && __globalState.setAction({ type: 'Remove Entity', entityId: ids });
        this.setState(state => {
            return _crud._remove(state, ids);
        });
    }
    /**
     *
     * Update the active entity.
     *
     * \@example
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateFn
     * @return {?}
     */
    updateActive(newStateFn) {
        assertActive(this._value());
        isDev() && __globalState.setAction({ type: 'Update Active Entity', entityId: this._value().active });
        this.setState(state => {
            /** @type {?} */
            const activeId = (/** @type {?} */ (state.active));
            /** @type {?} */
            const newState = isFunction(newStateFn) ? newStateFn(state.entities[activeId]) : newStateFn;
            if (newState === state) {
                throw new AkitaImmutabilityError(this.storeName);
            }
            return _crud._update(state, [activeId], newState, this.idKey);
        });
    }
    /**
     * Set the given entity as active.
     * @param {?} idOrOptions
     * @return {?}
     */
    setActive(idOrOptions) {
        /** @type {?} */
        let activeId;
        if (isObject(idOrOptions)) {
            if (isNil(this._value().active))
                return;
            ((/** @type {?} */ (idOrOptions))) = Object.assign({ wrap: true }, idOrOptions);
            /** @type {?} */
            const ids = this._value().ids;
            /** @type {?} */
            const currentIdIndex = ids.indexOf(this._value().active);
            if (((/** @type {?} */ (idOrOptions))).prev) {
                /** @type {?} */
                const isFirst = currentIdIndex === 0;
                if (isFirst && !((/** @type {?} */ (idOrOptions))).wrap)
                    return;
                activeId = isFirst ? ids[ids.length - 1] : ((/** @type {?} */ (ids[currentIdIndex - 1])));
            }
            else if (((/** @type {?} */ (idOrOptions))).next) {
                /** @type {?} */
                const isLast = ids.length === currentIdIndex + 1;
                if (isLast && !((/** @type {?} */ (idOrOptions))).wrap)
                    return;
                activeId = isLast ? ids[0] : ((/** @type {?} */ (ids[currentIdIndex + 1])));
            }
        }
        else {
            if (idOrOptions === this._value().active)
                return;
            activeId = (/** @type {?} */ (idOrOptions));
        }
        isDev() && __globalState.setAction({ type: 'Set Active Entity', entityId: activeId });
        this.setState(state => {
            return Object.assign({}, ((/** @type {?} */ (state))), { active: activeId });
        });
    }
    /**
     * @param {?} id
     * @param {?} entity
     * @return {?}
     */
    addWhenNotExists(id, entity) {
        if (!entity[this.idKey]) {
            entity[this.idKey] = id;
        }
        this.add(entity);
    }
}
/** @type {?} */
export const getInitialEntitiesState = () => ((/** @type {?} */ ({
    entities: {},
    ids: [],
    loading: true,
    error: null
})));
/** @type {?} */
export const getInitialActiveState = () => ((/** @type {?} */ ({
    active: null
})));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXN0b3JlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9lbnRpdHktc3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN6QyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekUsT0FBTyxFQUFVLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFlLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ILE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7Ozs7QUFPdkMsTUFBTSxPQUFPLFdBQTRELFNBQVEsS0FBUTs7Ozs7OztJQUt2RixZQUFZLFlBQVksR0FBRyxFQUFFLEVBQUUsVUFBa0QsRUFBRTtRQUNqRixLQUFLLG1CQUFNLHVCQUF1QixFQUFFLEVBQUssWUFBWSxHQUFJLE9BQU8sQ0FBQyxDQUFDO0lBQ3BFLENBQUM7Ozs7SUFFRCxJQUFJLFFBQVE7UUFDVixPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUM7SUFDaEMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7SUFZRCxHQUFHLENBQUMsUUFBd0MsRUFBRSxVQUFvRCxFQUFFO1FBQ2xHLEtBQUssRUFBRSxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUM3RCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMs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c291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgX2NydWQgfSBmcm9tICcuLi9pbnRlcm5hbC9jcnVkJztcbmltcG9ydCB7IEFraXRhSW1tdXRhYmlsaXR5RXJyb3IsIGFzc2VydEFjdGl2ZSB9IGZyb20gJy4uL2ludGVybmFsL2Vycm9yJztcbmltcG9ydCB7IEFjdGlvbiwgX19nbG9iYWxTdGF0ZSB9IGZyb20gJy4uL2ludGVybmFsL2dsb2JhbC1zdGF0ZSc7XG5pbXBvcnQgeyBjb2VyY2VBcnJheSwgZW50aXR5RXhpc3RzLCBpc0Z1bmN0aW9uLCBpc05pbCwgaXNPYmplY3QsIGlzVW5kZWZpbmVkLCB0b0Jvb2xlYW4gfSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBpc0RldiwgU3RvcmUgfSBmcm9tICcuL3N0b3JlJztcbmltcG9ydCB7IEFjdGl2ZVN0YXRlLCBFbnRpdGllcywgRW50aXR5U3RhdGUsIEhhc2hNYXAsIElELCBOZXdhYmxlLCBBZGRPcHRpb25zLCBTZXRBY3RpdmVPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XG5cbi8qKlxuICogVGhlIFJvb3QgU3RvcmUgdGhhdCBldmVyeSBzdWIgc3RvcmUgbmVlZHMgdG8gaW5oZXJpdCBhbmRcbiAqIGludm9rZSBgc3VwZXJgIHdpdGggdGhlIGluaXRpYWwgc3RhdGUuXG4gKi9cbmV4cG9ydCBjbGFzcyBFbnRpdHlTdG9yZTxTIGV4dGVuZHMgRW50aXR5U3RhdGU8RT4sIEUsIEFjdGl2ZUVudGl0eSA9IElEPiBleHRlbmRzIFN0b3JlPFM+IHtcbiAgLyoqXG4gICAqXG4gICAqIEluaXRpYXRlIHRoZSBzdG9yZSB3aXRoIHRoZSBzdGF0ZVxuICAgKi9cbiAgY29uc3RydWN0b3IoaW5pdGlhbFN0YXRlID0ge30sIG9wdGlvbnM6IHsgaWRLZXk/OiBzdHJpbmc7IHN0b3JlTmFtZT86IHN0cmluZyB9ID0ge30pIHtcbiAgICBzdXBlcih7IC4uLmdldEluaXRpYWxFbnRpdGllc1N0YXRlKCksIC4uLmluaXRpYWxTdGF0ZSB9LCBvcHRpb25zKTtcbiAgfVxuXG4gIGdldCBlbnRpdGllcygpIHtcbiAgICByZXR1cm4gdGhpcy5fdmFsdWUoKS5lbnRpdGllcztcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZXBsYWNlIGN1cnJlbnQgY29sbGVjdGlvbiB3aXRoIHByb3ZpZGVkIGNvbGxlY3Rpb25cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZXQoW0VudGl0eSwgRW50aXR5XSk7XG4gICAqIHRoaXMuc3RvcmUuc2V0KHsxOiBFbnRpdHksIDI6IEVudGl0eX0pO1xuICAgKiB0aGlzLnN0b3JlLnNldChbe2lkOiAxfSwge2lkOiAyfV0sIHsgZW50aXR5Q2xhc3M6IFByb2R1Y3QgfSk7XG4gICAqXG4gICAqL1xuICBzZXQoZW50aXRpZXM6IEVbXSB8IEhhc2hNYXA8RT4gfCBFbnRpdGllczxFPiwgb3B0aW9uczogeyBlbnRpdHlDbGFzcz86IE5ld2FibGU8RT4gfCB1bmRlZmluZWQgfSA9IHt9KSB7XG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdTZXQgRW50aXRpZXMnIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4gX2NydWQuX3NldChzdGF0ZSwgaXNOaWwoZW50aXRpZXMpID8gW10gOiBlbnRpdGllcywgb3B0aW9ucy5lbnRpdHlDbGFzcywgdGhpcy5pZEtleSkpO1xuICAgIHRoaXMuc2V0RGlydHkoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgb3IgcmVwbGFjZSBhbiBlbnRpdHkgaW4gdGhlIHN0b3JlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLmNyZWF0ZU9yUmVwbGFjZSgzLCBFbnRpdHkpO1xuICAgKlxuICAgKi9cbiAgY3JlYXRlT3JSZXBsYWNlKGlkOiBJRCwgZW50aXR5OiBFKSB7XG4gICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXMpKSB7XG4gICAgICB0aGlzLmFkZFdoZW5Ob3RFeGlzdHMoaWQsIGVudGl0eSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQ3JlYXRlIG9yIFJlcGxhY2UgRW50aXR5JywgZW50aXR5SWQ6IFtpZF0gfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IF9jcnVkLl9yZXBsYWNlRW50aXR5KHN0YXRlLCBpZCwgZW50aXR5KSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIEluc2VydCBvciBVcGRhdGVcbiAgICovXG4gIHVwc2VydChpZDogSUQsIGVudGl0eU9yRm46IFBhcnRpYWw8RT4gfCAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pKSB7XG4gICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXMpKSB7XG4gICAgICBjb25zdCByZXNvbHZlID0gaXNGdW5jdGlvbihlbnRpdHlPckZuKSA/IChlbnRpdHlPckZuIGFzIEZ1bmN0aW9uKSh7fSkgOiBlbnRpdHlPckZuO1xuICAgICAgdGhpcy5hZGRXaGVuTm90RXhpc3RzKGlkLCByZXNvbHZlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGUoaWQsIGVudGl0eU9yRm4gYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFuIGVudGl0eSBvciBlbnRpdGllcyB0byB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuYWRkKFtFbnRpdHksIEVudGl0eV0pO1xuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHkpO1xuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgcHJlcGVuZDogdHJ1ZSB9KTtcbiAgICovXG4gIGFkZChlbnRpdGllczogRVtdIHwgRSwgb3B0aW9ucz86IEFkZE9wdGlvbnMpIHtcbiAgICBjb25zdCB0b0FycmF5ID0gY29lcmNlQXJyYXkoZW50aXRpZXMpO1xuXG4gICAgaWYgKHRvQXJyYXkubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgLyoqICBJZiB3ZSBwYXNzIGVudGl0aWVzIHRoYXQgYWxyZWFkeSBleGlzdCwgd2Ugc2hvdWxkIGlnbm9yZSB0aGVtICovXG4gICAgY29uc3QgYWxsRXhpc3RzID0gdG9BcnJheS5ldmVyeShlbnRpdHkgPT4gdGhpcy5fdmFsdWUoKS5pZHMuaW5kZXhPZihlbnRpdHlbdGhpcy5pZEtleV0pID4gLTEpO1xuICAgIGlmIChhbGxFeGlzdHMpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnQWRkIEVudGl0eScgfSk7XG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiBfY3J1ZC5fYWRkPFMsIEU+KHN0YXRlLCB0b0FycmF5LCB0aGlzLmlkS2V5LCBvcHRpb25zKSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIGFuIGVudGl0eSBvciBlbnRpdGllcyBpbiB0aGUgc3RvcmUuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKDMsIHtcbiAgICogICBuYW1lOiAnTmV3IE5hbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKiAgdGhpcy5zdG9yZS51cGRhdGUoMywgZW50aXR5ID0+IHtcbiAgICogICAgcmV0dXJuIHtcbiAgICogICAgICBjb25maWc6IHtcbiAgICogICAgICAgIC4uLmVudGl0eS5maWx0ZXIsXG4gICAqICAgICAgICBkYXRlXG4gICAqICAgICAgfVxuICAgKiAgICB9XG4gICAqICB9KTtcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUoWzEsMiwzXSwge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlKGUgPT4gZS5uYW1lID09PSAndmFsdWUnLCB7XG4gICAqICAgbmFtZTogJ05ldyBOYW1lJ1xuICAgKiB9KTtcbiAgICpcbiAgICogdGhpcy5zdG9yZS51cGRhdGUobnVsbCwge1xuICAgKiAgIG5hbWU6ICdOZXcgTmFtZSdcbiAgICogfSk7XG4gICAqXG4gICAqL1xuICB1cGRhdGUoaWQ6IElEIHwgSURbXSB8IG51bGwsIG5ld1N0YXRlRm46ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikpO1xuICB1cGRhdGUoaWQ6IElEIHwgSURbXSB8IG51bGwsIG5ld1N0YXRlOiBQYXJ0aWFsPEU+KTtcbiAgdXBkYXRlKGlkOiBJRCB8IElEW10gfCBudWxsLCBuZXdTdGF0ZTogUGFydGlhbDxTPik7XG4gIHVwZGF0ZShuZXdTdGF0ZTogKHN0YXRlOiBSZWFkb25seTxTPikgPT4gUGFydGlhbDxTPik7XG4gIHVwZGF0ZShwcmVkaWNhdGU6ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksIG5ld1N0YXRlRm46ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gUGFydGlhbDxFPikpO1xuICB1cGRhdGUocHJlZGljYXRlOiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IGJvb2xlYW4pLCBuZXdTdGF0ZTogUGFydGlhbDxFPik7XG4gIHVwZGF0ZShwcmVkaWNhdGU6ICgoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbiksIG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKFxuICAgIGlkc09yRm46IElEIHwgSURbXSB8IG51bGwgfCBQYXJ0aWFsPFM+IHwgKChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pIHwgKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSxcbiAgICBuZXdTdGF0ZU9yRm4/OiAoKGVudGl0eTogUmVhZG9ubHk8RT4pID0+IFBhcnRpYWw8RT4pIHwgUGFydGlhbDxFPiB8IFBhcnRpYWw8Uz5cbiAgKSB7XG4gICAgbGV0IGlkczogSURbXSA9IFtdO1xuICAgIGNvbnN0IHN0b3JlSWRzID0gdGhpcy5fdmFsdWUoKS5pZHM7XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuKSkge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHN0b3JlSWRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGlkID0gc3RvcmVJZHNbaV07XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdO1xuICAgICAgICBpZiAoZW50aXR5ICYmIChpZHNPckZuIGFzIEZ1bmN0aW9uKShlbnRpdHkpKSB7XG4gICAgICAgICAgaWRzLnB1c2goaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IHRvQm9vbGVhbihpZHNPckZuKSA/IGNvZXJjZUFycmF5KGlkc09yRm4pIDogc3RvcmVJZHM7XG4gICAgfVxuXG4gICAgaWYgKGlkcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1VwZGF0ZSBFbnRpdHknLCBlbnRpdHlJZDogaWRzIH0pO1xuXG4gICAgdGhpcy5zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4gX2NydWQuX3VwZGF0ZShzdGF0ZSwgaWRzLCBuZXdTdGF0ZU9yRm4sIHRoaXMuaWRLZXkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEFuIGFsaWFzIHRvIHVwZGF0ZSBhbGwuXG4gICAqL1xuICB1cGRhdGVBbGwoc3RhdGU6IFBhcnRpYWw8RT4pIHtcbiAgICBpZiAodGhpcy5fdmFsdWUoKS5pZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgdGhpcy51cGRhdGUobnVsbCwgc3RhdGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSB0aGUgcm9vdCBzdGF0ZSAoZGF0YSB3aGljaCBpcyBleHRlcm5hbCB0byB0aGUgZW50aXRpZXMpLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnVwZGF0ZVJvb3Qoe1xuICAgKiAgIG1ldGFkYXRhOiAnbmV3IG1ldGFkYXRhXG4gICAqIH0pO1xuICAgKlxuICAgKiAgdGhpcy5zdG9yZS51cGRhdGVSb290KHN0YXRlID0+IHtcbiAgICogICAgcmV0dXJuIHtcbiAgICogICAgICBtZXRhZGF0YToge1xuICAgKiAgICAgICAgLi4uc3RhdGUubWV0YWRhdGEsXG4gICAqICAgICAgICBrZXk6ICduZXcgdmFsdWUnXG4gICAqICAgICAgfVxuICAgKiAgICB9XG4gICAqICB9KTtcbiAgICovXG4gIHVwZGF0ZVJvb3QobmV3U3RhdGVGbjogKChzdGF0ZTogUmVhZG9ubHk8Uz4pID0+IFBhcnRpYWw8Uz4pIHwgUGFydGlhbDxTPiwgYWN0aW9uPzogQWN0aW9uKSB7XG4gICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlRm4pID8gbmV3U3RhdGVGbih0aGlzLl92YWx1ZSgpKSA6IG5ld1N0YXRlRm47XG5cbiAgICBpZiAobmV3U3RhdGUgPT09IHRoaXMuX3ZhbHVlKCkpIHtcbiAgICAgIHRocm93IG5ldyBBa2l0YUltbXV0YWJpbGl0eUVycm9yKHRoaXMuc3RvcmVOYW1lKTtcbiAgICB9XG5cbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKGFjdGlvbiB8fCB7IHR5cGU6ICdVcGRhdGUgUm9vdCcgfSk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLihzdGF0ZSBhcyBhbnkpLFxuICAgICAgICAuLi4obmV3U3RhdGUgYXMgYW55KVxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBSZW1vdmUgb25lIG9yIG1vcmUgZW50aXRpZXMgZnJvbSB0aGUgc3RvcmU6XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKDUpO1xuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShbMSwyLDNdKTtcbiAgICogdGhpcy5zdG9yZS5yZW1vdmUoZW50aXR5ID0+IGVudGl0eS5pZCA9PT0gMSk7XG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKCk7XG4gICAqL1xuICByZW1vdmUoaWQ/OiBJRCB8IElEW10pO1xuICByZW1vdmUocHJlZGljYXRlOiAoZW50aXR5OiBSZWFkb25seTxFPikgPT4gYm9vbGVhbik7XG4gIHJlbW92ZShpZHNPckZuPzogSUQgfCBJRFtdIHwgKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBib29sZWFuKSkge1xuICAgIGNvbnN0IHN0b3JlSWRzID0gdGhpcy5fdmFsdWUoKS5pZHM7XG5cbiAgICBpZiAoc3RvcmVJZHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgY29uc3QgaWRQYXNzZWQgPSB0b0Jvb2xlYW4oaWRzT3JGbik7XG4gICAgaWYgKCFpZFBhc3NlZCkgdGhpcy5zZXRQcmlzdGluZSgpO1xuXG4gICAgbGV0IGlkczogSURbXSA9IFtdO1xuICAgIGlmIChpc0Z1bmN0aW9uKGlkc09yRm4pKSB7XG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuID0gc3RvcmVJZHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgY29uc3QgaWQgPSBzdG9yZUlkc1tpXTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5fdmFsdWUoKS5lbnRpdGllc1tpZF07XG4gICAgICAgIGlmIChlbnRpdHkgJiYgaWRzT3JGbihlbnRpdHkpKSB7XG4gICAgICAgICAgaWRzLnB1c2goaWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcyA9IGlkUGFzc2VkID8gY29lcmNlQXJyYXkoaWRzT3JGbikgOiBudWxsO1xuICAgIH1cblxuICAgIGlmIChpZHMgJiYgaWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgIGlzRGV2KCkgJiYgX19nbG9iYWxTdGF0ZS5zZXRBY3Rpb24oeyB0eXBlOiAnUmVtb3ZlIEVudGl0eScsIGVudGl0eUlkOiBpZHMgfSk7XG5cbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIHJldHVybiBfY3J1ZC5fcmVtb3ZlKHN0YXRlLCBpZHMpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwZGF0ZSB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS51cGRhdGVBY3RpdmUoYWN0aXZlID0+IHtcbiAgICogICByZXR1cm4ge1xuICAgKiAgICAgY29uZmlnOiB7XG4gICAqICAgICAgLi5hY3RpdmUuY29uZmlnLFxuICAgKiAgICAgIGRhdGVcbiAgICogICAgIH1cbiAgICogICB9XG4gICAqIH0pXG4gICAqL1xuICB1cGRhdGVBY3RpdmUobmV3U3RhdGVGbjogKChlbnRpdHk6IFJlYWRvbmx5PEU+KSA9PiBQYXJ0aWFsPEU+KSB8IFBhcnRpYWw8RT4pIHtcbiAgICBhc3NlcnRBY3RpdmUodGhpcy5fdmFsdWUoKSk7XG4gICAgaXNEZXYoKSAmJiBfX2dsb2JhbFN0YXRlLnNldEFjdGlvbih7IHR5cGU6ICdVcGRhdGUgQWN0aXZlIEVudGl0eScsIGVudGl0eUlkOiB0aGlzLl92YWx1ZSgpLmFjdGl2ZSB9KTtcbiAgICB0aGlzLnNldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgIGNvbnN0IGFjdGl2ZUlkID0gc3RhdGUuYWN0aXZlIGFzIElEO1xuICAgICAgY29uc3QgbmV3U3RhdGUgPSBpc0Z1bmN0aW9uKG5ld1N0YXRlRm4pID8gbmV3U3RhdGVGbihzdGF0ZS5lbnRpdGllc1thY3RpdmVJZF0pIDogbmV3U3RhdGVGbjtcbiAgICAgIGlmIChuZXdTdGF0ZSA9PT0gc3RhdGUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFraXRhSW1tdXRhYmlsaXR5RXJyb3IodGhpcy5zdG9yZU5hbWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIF9jcnVkLl91cGRhdGUoc3RhdGUsIFthY3RpdmVJZF0sIG5ld1N0YXRlLCB0aGlzLmlkS2V5KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGdpdmVuIGVudGl0eSBhcyBhY3RpdmUuXG4gICAqL1xuICBzZXRBY3RpdmUoaWRPck9wdGlvbnM6IEFjdGl2ZUVudGl0eSB8IFNldEFjdGl2ZU9wdGlvbnMgfCBudWxsKSB7XG4gICAgbGV0IGFjdGl2ZUlkOiBBY3RpdmVFbnRpdHk7XG5cbiAgICBpZiAoaXNPYmplY3QoaWRPck9wdGlvbnMpKSB7XG4gICAgICBpZiAoaXNOaWwodGhpcy5fdmFsdWUoKS5hY3RpdmUpKSByZXR1cm47XG4gICAgICAoaWRPck9wdGlvbnMgYXMgU2V0QWN0aXZlT3B0aW9ucykgPSBPYmplY3QuYXNzaWduKHsgd3JhcDogdHJ1ZSB9LCBpZE9yT3B0aW9ucyk7XG4gICAgICBjb25zdCBpZHMgPSB0aGlzLl92YWx1ZSgpLmlkcztcbiAgICAgIGNvbnN0IGN1cnJlbnRJZEluZGV4ID0gaWRzLmluZGV4T2YodGhpcy5fdmFsdWUoKS5hY3RpdmUpO1xuICAgICAgaWYgKChpZE9yT3B0aW9ucyBhcyBTZXRBY3RpdmVPcHRpb25zKS5wcmV2KSB7XG4gICAgICAgIGNvbnN0IGlzRmlyc3QgPSBjdXJyZW50SWRJbmRleCA9PT0gMDtcbiAgICAgICAgaWYgKGlzRmlyc3QgJiYgIShpZE9yT3B0aW9ucyBhcyBTZXRBY3RpdmVPcHRpb25zKS53cmFwKSByZXR1cm47XG4gICAgICAgIGFjdGl2ZUlkID0gaXNGaXJzdCA/IGlkc1tpZHMubGVuZ3RoIC0gMV0gOiAoaWRzW2N1cnJlbnRJZEluZGV4IC0gMV0gYXMgYW55KTtcbiAgICAgIH0gZWxzZSBpZiAoKGlkT3JPcHRpb25zIGFzIFNldEFjdGl2ZU9wdGlvbnMpLm5leHQpIHtcbiAgICAgICAgY29uc3QgaXNMYXN0ID0gaWRzLmxlbmd0aCA9PT0gY3VycmVudElkSW5kZXggKyAxO1xuICAgICAgICBpZiAoaXNMYXN0ICYmICEoaWRPck9wdGlvbnMgYXMgU2V0QWN0aXZlT3B0aW9ucykud3JhcCkgcmV0dXJuO1xuICAgICAgICBhY3RpdmVJZCA9IGlzTGFzdCA/IGlkc1swXSA6IChpZHNbY3VycmVudElkSW5kZXggKyAxXSBhcyBhbnkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaWRPck9wdGlvbnMgPT09IHRoaXMuX3ZhbHVlKCkuYWN0aXZlKSByZXR1cm47XG4gICAgICBhY3RpdmVJZCA9IGlkT3JPcHRpb25zIGFzIEFjdGl2ZUVudGl0eTtcbiAgICB9XG5cbiAgICBpc0RldigpICYmIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ1NldCBBY3RpdmUgRW50aXR5JywgZW50aXR5SWQ6IGFjdGl2ZUlkIH0pO1xuICAgIHRoaXMuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uKHN0YXRlIGFzIGFueSksXG4gICAgICAgIGFjdGl2ZTogYWN0aXZlSWRcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFkZFdoZW5Ob3RFeGlzdHMoaWQ6IElELCBlbnRpdHk6IEUpIHtcbiAgICBpZiAoIWVudGl0eVt0aGlzLmlkS2V5XSkge1xuICAgICAgZW50aXR5W3RoaXMuaWRLZXldID0gaWQ7XG4gICAgfVxuICAgIHRoaXMuYWRkKGVudGl0eSk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGdldEluaXRpYWxFbnRpdGllc1N0YXRlID0gKCkgPT5cbiAgKHtcbiAgICBlbnRpdGllczoge30sXG4gICAgaWRzOiBbXSxcbiAgICBsb2FkaW5nOiB0cnVlLFxuICAgIGVycm9yOiBudWxsXG4gIH0gYXMgRW50aXR5U3RhdGUpO1xuXG5leHBvcnQgY29uc3QgZ2V0SW5pdGlhbEFjdGl2ZVN0YXRlID0gKCkgPT5cbiAgKHtcbiAgICBhY3RpdmU6IG51bGxcbiAgfSBhcyBBY3RpdmVTdGF0ZSk7XG4iXX0=