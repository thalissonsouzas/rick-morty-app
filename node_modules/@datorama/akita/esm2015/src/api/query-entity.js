/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { combineLatest } from 'rxjs';
import { auditTime, map, switchMap, withLatestFrom } from 'rxjs/operators';
import { compareValues } from '../internal/sort';
import { entityExists, isFunction, isUndefined, toBoolean } from '../internal/utils';
import { memoizeOne } from './memoize';
import { Query } from './query';
/**
 * @record
 * @template E
 */
export function SelectOptions() { }
if (false) {
    /** @type {?|undefined} */
    SelectOptions.prototype.asObject;
    /** @type {?|undefined} */
    SelectOptions.prototype.filterBy;
    /** @type {?|undefined} */
    SelectOptions.prototype.limitTo;
}
/**
 *  An abstraction for querying the entities from the store
 * @template S, E, ActiveEntity
 */
export class QueryEntity extends Query {
    /**
     * @param {?} store
     */
    constructor(store) {
        super(store);
        this.__store__ = store;
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    selectAll(options = {
        asObject: false
    }) {
        /** @type {?} */
        const selectState$ = this.select(state => state);
        /** @type {?} */
        const selectEntities$ = this.select(state => state.entities);
        this.sortByOptions(options);
        return selectEntities$.pipe(withLatestFrom(selectState$, (entities, state) => {
            const { ids } = state;
            if (options.asObject) {
                return toMap(ids, entities, options);
            }
            else {
                if (!options.filterBy && !options.sortBy) {
                    if (!this.memoized) {
                        this.memoized = memoizeOne(toArray);
                    }
                    return this.memoized(state, options);
                }
                return toArray(state, options);
            }
        }));
    }
    /**
     * @param {?=} options
     * @return {?}
     */
    getAll(options = { asObject: false, filterBy: undefined, limitTo: undefined }) {
        /** @type {?} */
        const state = this.getSnapshot();
        if (options.asObject) {
            return toMap(state.ids, state.entities, options, true);
        }
        this.sortByOptions(options);
        return toArray(state, options);
    }
    /**
     * Select multiple entities from the store.
     *
     * \@example
     * this.store.selectMany([1,2]);
     * @param {?} ids
     * @param {?=} options
     * @return {?}
     */
    selectMany(ids, options = {}) {
        /** @type {?} */
        const filterUndefined = isUndefined(options.filterUndefined) ? true : options.filterUndefined;
        /** @type {?} */
        const entities = ids.map(id => this.selectEntity(id));
        return combineLatest(entities).pipe(map(entities => {
            return filterUndefined ? entities.filter(val => !isUndefined(val)) : entities;
        }), auditTime(0));
    }
    /**
     * @template R
     * @param {?} id
     * @param {?=} project
     * @return {?}
     */
    selectEntity(id, project) {
        if (!project) {
            return this._byId(id);
        }
        return this.select(state => {
            if (this.hasEntity(id)) {
                return project(this.getEntity(id));
            }
            return undefined;
        });
    }
    /**
     * Get an entity by id
     *
     * \@example
     * this.store.getEntity(1);
     * @param {?} id
     * @return {?}
     */
    getEntity(id) {
        return this.getSnapshot().entities[(/** @type {?} */ (id))];
    }
    /**
     * Select the active entity's id.
     * @return {?}
     */
    selectActiveId() {
        return this.select(state => ((/** @type {?} */ (state))).active);
    }
    /**
     * Get the active id
     * @return {?}
     */
    getActiveId() {
        return ((/** @type {?} */ (this.getSnapshot()))).active;
    }
    /**
     * @template R
     * @param {?=} project
     * @return {?}
     */
    selectActive(project) {
        return this.selectActiveId().pipe(switchMap(activeId => this.selectEntity(activeId, project)));
    }
    /**
     * Get the active entity.
     * @return {?}
     */
    getActive() {
        /** @type {?} */
        const activeId = this.getActiveId();
        return toBoolean(activeId) ? this.getEntity(activeId) : undefined;
    }
    /**
     * Select the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    selectCount(predicate) {
        if (isFunction(predicate)) {
            return this.selectAll({
                filterBy: predicate
            }).pipe(map(entities => entities.length));
        }
        return this.select(store => store.ids.length);
    }
    /**
     * Get the store's entity collection length.
     * @param {?=} predicate
     * @return {?}
     */
    getCount(predicate) {
        if (isFunction(predicate)) {
            return this.getAll().filter(predicate).length;
        }
        return this.getSnapshot().ids.length;
    }
    /**
     * @param {?} projectOrIds
     * @return {?}
     */
    hasEntity(projectOrIds) {
        if (isFunction(projectOrIds)) {
            return this.getAll().some(projectOrIds);
        }
        if (Array.isArray(projectOrIds)) {
            return projectOrIds.every(id => ((/** @type {?} */ (id))) in this.store.entities);
        }
        return ((/** @type {?} */ (projectOrIds))) in this.store.entities;
    }
    /**
     * Returns whether entity store has an active entity.
     * @return {?}
     */
    hasActive() {
        return this.getSnapshot().active != null;
    }
    /**
     * @return {?}
     */
    isEmpty() {
        return this.getSnapshot().ids.length === 0;
    }
    /**
     * @param {?} id
     * @return {?}
     */
    _byId(id) {
        return this.select(state => this.getEntity(id));
    }
    /**
     * @param {?} options
     * @return {?}
     */
    sortByOptions(options) {
        options.sortBy = options.sortBy || (this.config && ((/** @type {?} */ (this.config.sortBy))));
        options.sortByOrder = options.sortByOrder || (this.config && this.config.sortByOrder);
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.memoized = null;
    }
}
if (false) {
    /** @type {?} */
    QueryEntity.prototype.store;
    /** @type {?} */
    QueryEntity.prototype.memoized;
    /**
     * Use only for internal plugins like Pagination - don't use this property *
     * @type {?}
     */
    QueryEntity.prototype.__store__;
}
/**
 * @template E, S
 * @param {?} state
 * @param {?} options
 * @return {?}
 */
function toArray(state, options) {
    /** @type {?} */
    let arr = [];
    const { ids, entities } = state;
    const { filterBy, limitTo, sortBy, sortByOrder } = options;
    for (let i = 0; i < ids.length; i++) {
        /** @type {?} */
        const id = ids[i];
        if (!entityExists(id, entities)) {
            continue;
        }
        if (!filterBy) {
            arr.push(entities[id]);
            continue;
        }
        if (Array.isArray(filterBy)) {
            /** @type {?} */
            const allPass = filterBy.every(fn => fn(entities[id], i));
            if (allPass) {
                arr.push(entities[id]);
            }
        }
        else {
            if (filterBy(entities[id], i)) {
                arr.push(entities[id]);
            }
        }
    }
    if (sortBy) {
        /** @type {?} */
        let _sortBy = isFunction(sortBy) ? sortBy : compareValues(sortBy, sortByOrder);
        arr = arr.sort((a, b) => _sortBy(a, b, state));
    }
    /** @type {?} */
    const length = Math.min(limitTo || arr.length, arr.length);
    return length === arr.length ? arr : arr.slice(0, length);
}
/**
 * @template E
 * @param {?} ids
 * @param {?} entities
 * @param {?} options
 * @param {?=} get
 * @return {?}
 */
function toMap(ids, entities, options, get = false) {
    /** @type {?} */
    const map = {};
    const { filterBy, limitTo } = options;
    if (get && !filterBy && !limitTo) {
        return entities;
    }
    /** @type {?} */
    const length = Math.min(limitTo || ids.length, ids.length);
    if (filterBy && isUndefined(limitTo) === false) {
        /** @type {?} */
        let count = 0;
        for (let i = 0, length = ids.length; i < length; i++) {
            if (count === limitTo)
                break;
            /** @type {?} */
            const id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (Array.isArray(filterBy)) {
                /** @type {?} */
                const allPass = filterBy.every(fn => fn(entities[id], i));
                if (allPass) {
                    map[id] = entities[id];
                    count++;
                }
            }
            else {
                if (filterBy(entities[id], i)) {
                    map[id] = entities[id];
                    count++;
                }
            }
        }
    }
    else {
        for (let i = 0; i < length; i++) {
            /** @type {?} */
            const id = ids[i];
            if (!entityExists(id, entities)) {
                continue;
            }
            if (!filterBy) {
                map[id] = entities[id];
                continue;
            }
            if (Array.isArray(filterBy)) {
                /** @type {?} */
                const allPass = filterBy.every(fn => fn(entities[id], i));
                if (allPass) {
                    map[id] = entities[id];
                }
            }
            else {
                if (filterBy(entities[id], i)) {
                    map[id] = entities[id];
                }
            }
        }
    }
    return map;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktZW50aXR5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL2FwaS9xdWVyeS1lbnRpdHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxhQUFhLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNFLE9BQU8sRUFBRSxhQUFhLEVBQVMsTUFBTSxrQkFBa0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFckYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN2QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDOzs7OztBQUloQyxtQ0FJQzs7O0lBSEMsaUNBQW1COztJQUNuQixpQ0FBNkc7O0lBQzdHLGdDQUFpQjs7Ozs7O0FBTW5CLE1BQU0sT0FBTyxXQUF5RCxTQUFRLEtBQVE7Ozs7SUFPcEYsWUFBWSxLQUFzQztRQUNoRCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDYixJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztJQUN6QixDQUFDOzs7OztJQWNELFNBQVMsQ0FDUCxVQUE0QjtRQUMxQixRQUFRLEVBQUUsS0FBSztLQUNoQjs7Y0FFSyxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQzs7Y0FDMUMsZUFBZSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1FBRTVELElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFNUIsT0FBTyxlQUFlLENBQUMsSUFBSSxDQUN6QixjQUFjLENBQUMsWUFBWSxFQUFFLENBQUMsUUFBb0IsRUFBRSxLQUFRLEVBQUUsRUFBRTtrQkFDeEQsRUFBRSxHQUFHLEVBQUUsR0FBRyxLQUFLO1lBQ3JCLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtnQkFDcEIsT0FBTyxLQUFLLENBQUMsR0FBRyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN0QztpQkFBTTtnQkFDTCxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7b0JBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO3dCQUNsQixJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztxQkFDckM7b0JBQ0QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztpQkFDdEM7Z0JBRUQsT0FBTyxPQUFPLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQ2hDO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7Ozs7O0lBY0QsTUFBTSxDQUFDLFVBQTRCLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUU7O2NBQ3ZGLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFO1FBRWhDLElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtZQUNwQixPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3hEO1FBRUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU1QixPQUFPLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDakMsQ0FBQzs7Ozs7Ozs7OztJQVFELFVBQVUsQ0FBQyxHQUFtQixFQUFFLFVBQXlDLEVBQUU7O2NBQ25FLGVBQWUsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlOztjQUN2RixRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFckQsT0FBTyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUNqQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDYixPQUFPLGVBQWUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztRQUNoRixDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsQ0FBQyxDQUFDLENBQ2IsQ0FBQztJQUNKLENBQUM7Ozs7Ozs7SUFZRCxZQUFZLENBQUksRUFBZ0IsRUFBRSxPQUEwQjtRQUMxRCxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3ZCO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3pCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDdEIsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2FBQ3BDO1lBRUQsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzs7Ozs7Ozs7SUFRRCxTQUFTLENBQUMsRUFBZ0I7UUFDeEIsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxDQUFDLG1CQUFBLEVBQUUsRUFBTyxDQUFDLENBQUM7SUFDaEQsQ0FBQzs7Ozs7SUFLRCxjQUFjO1FBQ1osT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxtQkFBQSxLQUFLLEVBQWlDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUMvRSxDQUFDOzs7OztJQUtELFdBQVc7UUFDVCxPQUFPLENBQUMsbUJBQUEsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFpQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ3RFLENBQUM7Ozs7OztJQU9ELFlBQVksQ0FBSSxPQUEwQjtRQUN4QyxPQUFPLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pHLENBQUM7Ozs7O0lBS0QsU0FBUzs7Y0FDRCxRQUFRLEdBQWlCLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDakQsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNwRSxDQUFDOzs7Ozs7SUFLRCxXQUFXLENBQUMsU0FBaUQ7UUFDM0QsSUFBSSxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO2dCQUNwQixRQUFRLEVBQUUsU0FBUzthQUNwQixDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQzNDO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNoRCxDQUFDOzs7Ozs7SUFLRCxRQUFRLENBQUMsU0FBaUQ7UUFDeEQsSUFBSSxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDekIsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztTQUMvQztRQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7SUFDdkMsQ0FBQzs7Ozs7SUFRRCxTQUFTLENBQUMsWUFBc0U7UUFDOUUsSUFBSSxVQUFVLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDNUIsT0FBTyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ3pDO1FBRUQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO1lBQy9CLE9BQU8sWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsbUJBQUEsRUFBRSxFQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JFO1FBRUQsT0FBTyxDQUFDLG1CQUFBLFlBQVksRUFBTyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7SUFDdEQsQ0FBQzs7Ozs7SUFLRCxTQUFTO1FBQ1AsT0FBTyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQztJQUMzQyxDQUFDOzs7O0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO0lBQzdDLENBQUM7Ozs7O0lBRU8sS0FBSyxDQUFDLEVBQWdCO1FBQzVCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDOzs7OztJQUVPLGFBQWEsQ0FBQyxPQUFPO1FBQzNCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUks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a0JBQ3pCLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBRWpCLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLFFBQVEsQ0FBQyxFQUFFO2dCQUMvQixTQUFTO2FBQ1Y7WUFFRCxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNiLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3ZCLFNBQVM7YUFDVjtZQUVELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRTs7c0JBQ3JCLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDekQsSUFBSSxPQUFPLEVBQUU7b0JBQ1gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDeEI7YUFDRjtpQkFBTTtnQkFDTCxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUU7b0JBQzdCLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQ3hCO2FBQ0Y7U0FDRjtLQUNGO0lBRUQsT0FBTyxHQUFHLENBQUM7QUFDYixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgYXVkaXRUaW1lLCBtYXAsIHN3aXRjaE1hcCwgd2l0aExhdGVzdEZyb20gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGNvbXBhcmVWYWx1ZXMsIE9yZGVyIH0gZnJvbSAnLi4vaW50ZXJuYWwvc29ydCc7XG5pbXBvcnQgeyBlbnRpdHlFeGlzdHMsIGlzRnVuY3Rpb24sIGlzVW5kZWZpbmVkLCB0b0Jvb2xlYW4gfSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBFbnRpdHlTdG9yZSB9IGZyb20gJy4vZW50aXR5LXN0b3JlJztcbmltcG9ydCB7IG1lbW9pemVPbmUgfSBmcm9tICcuL21lbW9pemUnO1xuaW1wb3J0IHsgUXVlcnkgfSBmcm9tICcuL3F1ZXJ5JztcbmltcG9ydCB7IFNvcnRCeSwgU29ydEJ5T3B0aW9ucyB9IGZyb20gJy4vcXVlcnktY29uZmlnJztcbmltcG9ydCB7IEFjdGl2ZVN0YXRlLCBFbnRpdHlTdGF0ZSwgSGFzaE1hcCwgSUQgfSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RPcHRpb25zPEU+IGV4dGVuZHMgU29ydEJ5T3B0aW9uczxFPiB7XG4gIGFzT2JqZWN0PzogYm9vbGVhbjtcbiAgZmlsdGVyQnk/OiAoKGVudGl0eTogRSwgaW5kZXg/OiBudW1iZXIpID0+IGJvb2xlYW4pIHwgKChlbnRpdHk6IEUsIGluZGV4PzogbnVtYmVyKSA9PiBib29sZWFuKVtdIHwgdW5kZWZpbmVkO1xuICBsaW1pdFRvPzogbnVtYmVyO1xufVxuXG4vKipcbiAqICBBbiBhYnN0cmFjdGlvbiBmb3IgcXVlcnlpbmcgdGhlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlXG4gKi9cbmV4cG9ydCBjbGFzcyBRdWVyeUVudGl0eTxTIGV4dGVuZHMgRW50aXR5U3RhdGUsIEUsIEFjdGl2ZUVudGl0eSA9IElEPiBleHRlbmRzIFF1ZXJ5PFM+IHtcbiAgcHJvdGVjdGVkIHN0b3JlOiBFbnRpdHlTdG9yZTxTLCBFLCBBY3RpdmVFbnRpdHk+O1xuICBwcml2YXRlIG1lbW9pemVkO1xuXG4gIC8qKiBVc2Ugb25seSBmb3IgaW50ZXJuYWwgcGx1Z2lucyBsaWtlIFBhZ2luYXRpb24gLSBkb24ndCB1c2UgdGhpcyBwcm9wZXJ0eSAqKi9cbiAgX19zdG9yZV9fO1xuXG4gIGNvbnN0cnVjdG9yKHN0b3JlOiBFbnRpdHlTdG9yZTxTLCBFLCBBY3RpdmVFbnRpdHk+KSB7XG4gICAgc3VwZXIoc3RvcmUpO1xuICAgIHRoaXMuX19zdG9yZV9fID0gc3RvcmU7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IHRoZSBlbnRpcmUgc3RvcmUncyBlbnRpdHkgY29sbGVjdGlvbi5cbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5zZWxlY3RBbGwoKTtcbiAgICovXG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiB0cnVlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IHVuZGVmaW5lZDsgc29ydEJ5T3JkZXI/OiB1bmRlZmluZWQgfSk6IE9ic2VydmFibGU8SGFzaE1hcDxFPj47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGZpbHRlckJ5OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IE9ic2VydmFibGU8RVtdPjtcbiAgc2VsZWN0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IHRydWU7IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IHVuZGVmaW5lZDsgc29ydEJ5T3JkZXI/OiB1bmRlZmluZWQgfSk6IE9ic2VydmFibGU8SGFzaE1hcDxFPj47XG4gIHNlbGVjdEFsbChvcHRpb25zOiB7IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogT2JzZXJ2YWJsZTxFW10+O1xuICBzZWxlY3RBbGwob3B0aW9uczogeyBhc09iamVjdDogZmFsc2U7IGZpbHRlckJ5PzogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbCgpOiBPYnNlcnZhYmxlPEVbXT47XG4gIHNlbGVjdEFsbChcbiAgICBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+ID0ge1xuICAgICAgYXNPYmplY3Q6IGZhbHNlXG4gICAgfVxuICApOiBPYnNlcnZhYmxlPEVbXSB8IEhhc2hNYXA8RT4+IHtcbiAgICBjb25zdCBzZWxlY3RTdGF0ZSQgPSB0aGlzLnNlbGVjdChzdGF0ZSA9PiBzdGF0ZSk7XG4gICAgY29uc3Qgc2VsZWN0RW50aXRpZXMkID0gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUuZW50aXRpZXMpO1xuXG4gICAgdGhpcy5zb3J0QnlPcHRpb25zKG9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHNlbGVjdEVudGl0aWVzJC5waXBlKFxuICAgICAgd2l0aExhdGVzdEZyb20oc2VsZWN0U3RhdGUkLCAoZW50aXRpZXM6IEhhc2hNYXA8RT4sIHN0YXRlOiBTKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgaWRzIH0gPSBzdGF0ZTtcbiAgICAgICAgaWYgKG9wdGlvbnMuYXNPYmplY3QpIHtcbiAgICAgICAgICByZXR1cm4gdG9NYXAoaWRzLCBlbnRpdGllcywgb3B0aW9ucyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKCFvcHRpb25zLmZpbHRlckJ5ICYmICFvcHRpb25zLnNvcnRCeSkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLm1lbW9pemVkKSB7XG4gICAgICAgICAgICAgIHRoaXMubWVtb2l6ZWQgPSBtZW1vaXplT25lKHRvQXJyYXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVtb2l6ZWQoc3RhdGUsIG9wdGlvbnMpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB0b0FycmF5KHN0YXRlLCBvcHRpb25zKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZW50aXJlIHN0b3JlJ3MgZW50aXR5IGNvbGxlY3Rpb24uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMuc3RvcmUuZ2V0QWxsKCk7XG4gICAqL1xuICBnZXRBbGwob3B0aW9uczogeyBhc09iamVjdDogdHJ1ZTsgZmlsdGVyQnk/OiBTZWxlY3RPcHRpb25zPEU+WydmaWx0ZXJCeSddOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBIYXNoTWFwPEU+O1xuICBnZXRBbGwob3B0aW9uczogeyBmaWx0ZXJCeTogU2VsZWN0T3B0aW9uczxFPlsnZmlsdGVyQnknXTsgbGltaXRUbz86IG51bWJlcjsgc29ydEJ5PzogU29ydEJ5PEU+OyBzb3J0QnlPcmRlcj86IE9yZGVyIH0pOiBFW107XG4gIGdldEFsbChvcHRpb25zOiB7IGFzT2JqZWN0OiB0cnVlOyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiB1bmRlZmluZWQ7IHNvcnRCeU9yZGVyPzogdW5kZWZpbmVkIH0pOiBIYXNoTWFwPEU+O1xuICBnZXRBbGwob3B0aW9uczogeyBsaW1pdFRvPzogbnVtYmVyOyBzb3J0Qnk/OiBTb3J0Qnk8RT47IHNvcnRCeU9yZGVyPzogT3JkZXIgfSk6IEVbXTtcbiAgZ2V0QWxsKG9wdGlvbnM6IHsgYXNPYmplY3Q6IGZhbHNlOyBmaWx0ZXJCeT86IFNlbGVjdE9wdGlvbnM8RT5bJ2ZpbHRlckJ5J107IGxpbWl0VG8/OiBudW1iZXI7IHNvcnRCeT86IFNvcnRCeTxFPjsgc29ydEJ5T3JkZXI/OiBPcmRlciB9KTogRVtdO1xuICBnZXRBbGwoKTogRVtdO1xuICBnZXRBbGwob3B0aW9uczogU2VsZWN0T3B0aW9uczxFPiA9IHsgYXNPYmplY3Q6IGZhbHNlLCBmaWx0ZXJCeTogdW5kZWZpbmVkLCBsaW1pdFRvOiB1bmRlZmluZWQgfSk6IEVbXSB8IEhhc2hNYXA8RT4ge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcy5nZXRTbmFwc2hvdCgpO1xuXG4gICAgaWYgKG9wdGlvbnMuYXNPYmplY3QpIHtcbiAgICAgIHJldHVybiB0b01hcChzdGF0ZS5pZHMsIHN0YXRlLmVudGl0aWVzLCBvcHRpb25zLCB0cnVlKTtcbiAgICB9XG5cbiAgICB0aGlzLnNvcnRCeU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgICByZXR1cm4gdG9BcnJheShzdGF0ZSwgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogU2VsZWN0IG11bHRpcGxlIGVudGl0aWVzIGZyb20gdGhlIHN0b3JlLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiB0aGlzLnN0b3JlLnNlbGVjdE1hbnkoWzEsMl0pO1xuICAgKi9cbiAgc2VsZWN0TWFueShpZHM6IEFjdGl2ZUVudGl0eVtdLCBvcHRpb25zOiB7IGZpbHRlclVuZGVmaW5lZD86IGJvb2xlYW4gfSA9IHt9KTogT2JzZXJ2YWJsZTxFW10+IHtcbiAgICBjb25zdCBmaWx0ZXJVbmRlZmluZWQgPSBpc1VuZGVmaW5lZChvcHRpb25zLmZpbHRlclVuZGVmaW5lZCkgPyB0cnVlIDogb3B0aW9ucy5maWx0ZXJVbmRlZmluZWQ7XG4gICAgY29uc3QgZW50aXRpZXMgPSBpZHMubWFwKGlkID0+IHRoaXMuc2VsZWN0RW50aXR5KGlkKSk7XG5cbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChlbnRpdGllcykucGlwZShcbiAgICAgIG1hcChlbnRpdGllcyA9PiB7XG4gICAgICAgIHJldHVybiBmaWx0ZXJVbmRlZmluZWQgPyBlbnRpdGllcy5maWx0ZXIodmFsID0+ICFpc1VuZGVmaW5lZCh2YWwpKSA6IGVudGl0aWVzO1xuICAgICAgfSksXG4gICAgICBhdWRpdFRpbWUoMClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCBhbiBlbnRpdHkgb3IgYSBzbGljZSBvZiBhbiBlbnRpdHkuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIHRoaXMucGFnZXNTdG9yZS5zZWxlY3RFbnRpdHkoMSlcbiAgICogdGhpcy5wYWdlc1N0b3JlLnNlbGVjdEVudGl0eSgxLCBlbnRpdHkgPT4gZW50aXR5LmNvbmZpZy5kYXRlKVxuICAgKlxuICAgKi9cbiAgc2VsZWN0RW50aXR5PFI+KGlkOiBBY3RpdmVFbnRpdHkpOiBPYnNlcnZhYmxlPEU+O1xuICBzZWxlY3RFbnRpdHk8Uj4oaWQ6IEFjdGl2ZUVudGl0eSwgcHJvamVjdDogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8Uj47XG4gIHNlbGVjdEVudGl0eTxSPihpZDogQWN0aXZlRW50aXR5LCBwcm9qZWN0PzogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8UiB8IEU+IHtcbiAgICBpZiAoIXByb2plY3QpIHtcbiAgICAgIHJldHVybiB0aGlzLl9ieUlkKGlkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RhdGUgPT4ge1xuICAgICAgaWYgKHRoaXMuaGFzRW50aXR5KGlkKSkge1xuICAgICAgICByZXR1cm4gcHJvamVjdCh0aGlzLmdldEVudGl0eShpZCkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBlbnRpdHkgYnkgaWRcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogdGhpcy5zdG9yZS5nZXRFbnRpdHkoMSk7XG4gICAqL1xuICBnZXRFbnRpdHkoaWQ6IEFjdGl2ZUVudGl0eSk6IEUge1xuICAgIHJldHVybiB0aGlzLmdldFNuYXBzaG90KCkuZW50aXRpZXNbaWQgYXMgYW55XTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWxlY3QgdGhlIGFjdGl2ZSBlbnRpdHkncyBpZC5cbiAgICovXG4gIHNlbGVjdEFjdGl2ZUlkKCk6IE9ic2VydmFibGU8QWN0aXZlRW50aXR5PiB7XG4gICAgcmV0dXJuIHRoaXMuc2VsZWN0KHN0YXRlID0+IChzdGF0ZSBhcyBTICYgQWN0aXZlU3RhdGU8QWN0aXZlRW50aXR5PikuYWN0aXZlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFjdGl2ZSBpZFxuICAgKi9cbiAgZ2V0QWN0aXZlSWQoKTogQWN0aXZlRW50aXR5IHtcbiAgICByZXR1cm4gKHRoaXMuZ2V0U25hcHNob3QoKSBhcyBTICYgQWN0aXZlU3RhdGU8QWN0aXZlRW50aXR5PikuYWN0aXZlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICovXG4gIHNlbGVjdEFjdGl2ZTxSPigpOiBPYnNlcnZhYmxlPEU+O1xuICBzZWxlY3RBY3RpdmU8Uj4ocHJvamVjdDogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8Uj47XG4gIHNlbGVjdEFjdGl2ZTxSPihwcm9qZWN0PzogKGVudGl0eTogRSkgPT4gUik6IE9ic2VydmFibGU8UiB8IEU+IHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RBY3RpdmVJZCgpLnBpcGUoc3dpdGNoTWFwKGFjdGl2ZUlkID0+IHRoaXMuc2VsZWN0RW50aXR5KGFjdGl2ZUlkLCBwcm9qZWN0KSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYWN0aXZlIGVudGl0eS5cbiAgICovXG4gIGdldEFjdGl2ZSgpOiBFIHtcbiAgICBjb25zdCBhY3RpdmVJZDogQWN0aXZlRW50aXR5ID0gdGhpcy5nZXRBY3RpdmVJZCgpO1xuICAgIHJldHVybiB0b0Jvb2xlYW4oYWN0aXZlSWQpID8gdGhpcy5nZXRFbnRpdHkoYWN0aXZlSWQpIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFNlbGVjdCB0aGUgc3RvcmUncyBlbnRpdHkgY29sbGVjdGlvbiBsZW5ndGguXG4gICAqL1xuICBzZWxlY3RDb3VudChwcmVkaWNhdGU/OiAoZW50aXR5OiBFLCBpbmRleDogbnVtYmVyKSA9PiBib29sZWFuKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBpZiAoaXNGdW5jdGlvbihwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gdGhpcy5zZWxlY3RBbGwoe1xuICAgICAgICBmaWx0ZXJCeTogcHJlZGljYXRlXG4gICAgICB9KS5waXBlKG1hcChlbnRpdGllcyA9PiBlbnRpdGllcy5sZW5ndGgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZWxlY3Qoc3RvcmUgPT4gc3RvcmUuaWRzLmxlbmd0aCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBzdG9yZSdzIGVudGl0eSBjb2xsZWN0aW9uIGxlbmd0aC5cbiAgICovXG4gIGdldENvdW50KHByZWRpY2F0ZT86IChlbnRpdHk6IEUsIGluZGV4OiBudW1iZXIpID0+IGJvb2xlYW4pOiBudW1iZXIge1xuICAgIGlmIChpc0Z1bmN0aW9uKHByZWRpY2F0ZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEFsbCgpLmZpbHRlcihwcmVkaWNhdGUpLmxlbmd0aDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0U25hcHNob3QoKS5pZHMubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgd2hldGhlciBlbnRpdHkgZXhpc3RzLlxuICAgKi9cbiAgaGFzRW50aXR5KGlkOiBBY3RpdmVFbnRpdHkpOiBib29sZWFuO1xuICBoYXNFbnRpdHkoaWQ6IEFjdGl2ZUVudGl0eVtdKTogYm9vbGVhbjtcbiAgaGFzRW50aXR5KHByb2plY3Q6IChlbnRpdHk6IEUpID0+IGJvb2xlYW4pOiBib29sZWFuO1xuICBoYXNFbnRpdHkocHJvamVjdE9ySWRzOiBBY3RpdmVFbnRpdHkgfCBBY3RpdmVFbnRpdHlbXSB8ICgoZW50aXR5OiBFKSA9PiBib29sZWFuKSk6IGJvb2xlYW4ge1xuICAgIGlmIChpc0Z1bmN0aW9uKHByb2plY3RPcklkcykpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEFsbCgpLnNvbWUocHJvamVjdE9ySWRzKTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShwcm9qZWN0T3JJZHMpKSB7XG4gICAgICByZXR1cm4gcHJvamVjdE9ySWRzLmV2ZXJ5KGlkID0+IChpZCBhcyBhbnkpIGluIHRoaXMuc3RvcmUuZW50aXRpZXMpO1xuICAgIH1cblxuICAgIHJldHVybiAocHJvamVjdE9ySWRzIGFzIGFueSkgaW4gdGhpcy5zdG9yZS5lbnRpdGllcztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgZW50aXR5IHN0b3JlIGhhcyBhbiBhY3RpdmUgZW50aXR5LlxuICAgKi9cbiAgaGFzQWN0aXZlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmdldFNuYXBzaG90KCkuYWN0aXZlICE9IG51bGw7XG4gIH1cblxuICBpc0VtcHR5KCkge1xuICAgIHJldHVybiB0aGlzLmdldFNuYXBzaG90KCkuaWRzLmxlbmd0aCA9PT0gMDtcbiAgfVxuXG4gIHByaXZhdGUgX2J5SWQoaWQ6IEFjdGl2ZUVudGl0eSk6IE9ic2VydmFibGU8RT4ge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdChzdGF0ZSA9PiB0aGlzLmdldEVudGl0eShpZCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzb3J0QnlPcHRpb25zKG9wdGlvbnMpIHtcbiAgICBvcHRpb25zLnNvcnRCeSA9IG9wdGlvbnMuc29ydEJ5IHx8ICh0aGlzLmNvbmZpZyAmJiAodGhpcy5jb25maWcuc29ydEJ5IGFzIFNvcnRCeTxFPikpO1xuICAgIG9wdGlvbnMuc29ydEJ5T3JkZXIgPSBvcHRpb25zLnNvcnRCeU9yZGVyIHx8ICh0aGlzLmNvbmZpZyAmJiB0aGlzLmNvbmZpZy5zb3J0QnlPcmRlcik7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLm1lbW9pemVkID0gbnVsbDtcbiAgfVxufVxuXG5mdW5jdGlvbiB0b0FycmF5PEUsIFMgZXh0ZW5kcyBFbnRpdHlTdGF0ZT4oc3RhdGU6IFMsIG9wdGlvbnM6IFNlbGVjdE9wdGlvbnM8RT4pOiBFW10ge1xuICBsZXQgYXJyID0gW107XG4gIGNvbnN0IHsgaWRzLCBlbnRpdGllcyB9ID0gc3RhdGU7XG4gIGNvbnN0IHsgZmlsdGVyQnksIGxpbWl0VG8sIHNvcnRCeSwgc29ydEJ5T3JkZXIgfSA9IG9wdGlvbnM7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBpZCA9IGlkc1tpXTtcblxuICAgIGlmICghZW50aXR5RXhpc3RzKGlkLCBlbnRpdGllcykpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmICghZmlsdGVyQnkpIHtcbiAgICAgIGFyci5wdXNoKGVudGl0aWVzW2lkXSk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeSkpIHtcbiAgICAgIGNvbnN0IGFsbFBhc3MgPSBmaWx0ZXJCeS5ldmVyeShmbiA9PiBmbihlbnRpdGllc1tpZF0sIGkpKTtcbiAgICAgIGlmIChhbGxQYXNzKSB7XG4gICAgICAgIGFyci5wdXNoKGVudGl0aWVzW2lkXSk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChmaWx0ZXJCeShlbnRpdGllc1tpZF0sIGkpKSB7XG4gICAgICAgIGFyci5wdXNoKGVudGl0aWVzW2lkXSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHNvcnRCeSkge1xuICAgIGxldCBfc29ydEJ5OiBhbnkgPSBpc0Z1bmN0aW9uKHNvcnRCeSkgPyBzb3J0QnkgOiBjb21wYXJlVmFsdWVzKHNvcnRCeSwgc29ydEJ5T3JkZXIpO1xuICAgIGFyciA9IGFyci5zb3J0KChhLCBiKSA9PiBfc29ydEJ5KGEsIGIsIHN0YXRlKSk7XG4gIH1cbiAgY29uc3QgbGVuZ3RoID0gTWF0aC5taW4obGltaXRUbyB8fCBhcnIubGVuZ3RoLCBhcnIubGVuZ3RoKTtcblxuICByZXR1cm4gbGVuZ3RoID09PSBhcnIubGVuZ3RoID8gYXJyIDogYXJyLnNsaWNlKDAsIGxlbmd0aCk7XG59XG5cbmZ1bmN0aW9uIHRvTWFwPEU+KGlkczogYW55W10sIGVudGl0aWVzOiBIYXNoTWFwPEU+LCBvcHRpb25zOiBTZWxlY3RPcHRpb25zPEU+LCBnZXQgPSBmYWxzZSk6IEhhc2hNYXA8RT4ge1xuICBjb25zdCBtYXAgPSB7fTtcbiAgY29uc3QgeyBmaWx0ZXJCeSwgbGltaXRUbyB9ID0gb3B0aW9ucztcblxuICBpZiAoZ2V0ICYmICFmaWx0ZXJCeSAmJiAhbGltaXRUbykge1xuICAgIHJldHVybiBlbnRpdGllcztcbiAgfVxuXG4gIGNvbnN0IGxlbmd0aCA9IE1hdGgubWluKGxpbWl0VG8gfHwgaWRzLmxlbmd0aCwgaWRzLmxlbmd0aCk7XG5cbiAgaWYgKGZpbHRlckJ5ICYmIGlzVW5kZWZpbmVkKGxpbWl0VG8pID09PSBmYWxzZSkge1xuICAgIGxldCBjb3VudCA9IDA7XG4gICAgZm9yIChsZXQgaSA9IDAsIGxlbmd0aCA9IGlkcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgaWYgKGNvdW50ID09PSBsaW1pdFRvKSBicmVhaztcbiAgICAgIGNvbnN0IGlkID0gaWRzW2ldO1xuICAgICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIGVudGl0aWVzKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGZpbHRlckJ5KSkge1xuICAgICAgICBjb25zdCBhbGxQYXNzID0gZmlsdGVyQnkuZXZlcnkoZm4gPT4gZm4oZW50aXRpZXNbaWRdLCBpKSk7XG4gICAgICAgIGlmIChhbGxQYXNzKSB7XG4gICAgICAgICAgbWFwW2lkXSA9IGVudGl0aWVzW2lkXTtcbiAgICAgICAgICBjb3VudCsrO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZmlsdGVyQnkoZW50aXRpZXNbaWRdLCBpKSkge1xuICAgICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICAgICAgY291bnQrKztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpZCA9IGlkc1tpXTtcblxuICAgICAgaWYgKCFlbnRpdHlFeGlzdHMoaWQsIGVudGl0aWVzKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFmaWx0ZXJCeSkge1xuICAgICAgICBtYXBbaWRdID0gZW50aXRpZXNbaWRdO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVyQnkpKSB7XG4gICAgICAgIGNvbnN0IGFsbFBhc3MgPSBmaWx0ZXJCeS5ldmVyeShmbiA9PiBmbihlbnRpdGllc1tpZF0sIGkpKTtcbiAgICAgICAgaWYgKGFsbFBhc3MpIHtcbiAgICAgICAgICBtYXBbaWRdID0gZW50aXRpZXNbaWRdO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoZmlsdGVyQnkoZW50aXRpZXNbaWRdLCBpKSkge1xuICAgICAgICAgIG1hcFtpZF0gPSBlbnRpdGllc1tpZF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gbWFwO1xufVxuIl19