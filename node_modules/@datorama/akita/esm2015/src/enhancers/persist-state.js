/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { AkitaError } from '../internal/error';
import { __stores__, rootDispatcher } from '../api/store';
import { skip, filter } from 'rxjs/operators';
import { getValue, setValue } from '../internal/utils';
import { __globalState } from '../internal/global-state';
/** @type {?} */
const notBs = typeof localStorage === 'undefined';
/**
 * @record
 */
export function PersistStateParams() { }
if (false) {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    if (notBs)
        return;
    /** @type {?} */
    const defaults = {
        key: 'AkitaStores',
        storage: localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        exclude: []
    };
    const { storage, deserialize, serialize, include, exclude, key } = Object.assign({}, defaults, params);
    /** @type {?} */
    const hasInclude = include.length > 0;
    /** @type {?} */
    const hasExclude = exclude.length > 0;
    /** @type {?} */
    let includeStores;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    if (hasInclude) {
        includeStores = include.reduce((acc, path) => {
            /** @type {?} */
            const storeName = path.split('.')[0];
            acc[storeName] = path;
            return acc;
        }, {});
    }
    /** @type {?} */
    const storageState = deserialize(storage.getItem(key) || '{}');
    /** @type {?} */
    let stores = {};
    /** @type {?} */
    let acc = {};
    /**
     * @return {?}
     */
    function save() {
        storage.setItem(key, serialize(Object.assign({}, storageState, acc)));
    }
    /**
     * @param {?} storeName
     * @param {?} path
     * @return {?}
     */
    function subscribe(storeName, path) {
        stores[storeName] = __stores__[storeName]
            ._select(state => getValue(state, path))
            .pipe(skip(1))
            .subscribe(data => {
            acc[storeName] = data;
            save();
        });
    }
    /**
     * @param {?} storeName
     * @param {?} store
     * @param {?} path
     * @return {?}
     */
    function setInitial(storeName, store, path) {
        if (storageState[storeName]) {
            __globalState.setAction({ type: '@PersistState' });
            store.setState(state => {
                return setValue(state, path, storageState[storeName]);
            });
            if (store.setDirty) {
                store.setDirty();
            }
        }
    }
    /** @type {?} */
    const subscription = rootDispatcher.pipe(filter(action => action.type === 0 /* NEW_STORE */)).subscribe(action => {
        /** @type {?} */
        let currentStoreName = action.payload.store.storeName;
        if (hasExclude && exclude.includes(currentStoreName)) {
            return;
        }
        if (hasInclude) {
            /** @type {?} */
            const path = includeStores[currentStoreName];
            if (!path) {
                return;
            }
            setInitial(currentStoreName, action.payload.store, path);
            subscribe(currentStoreName, path);
        }
        else {
            setInitial(currentStoreName, action.payload.store, currentStoreName);
            subscribe(currentStoreName, currentStoreName);
        }
    });
    return {
        /**
         * @return {?}
         */
        destroy() {
            subscription.unsubscribe();
            for (let i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                const storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        /**
         * @return {?}
         */
        clear() {
            storage.clear();
        },
        /**
         * @param {?} storeName
         * @return {?}
         */
        clearStore(storeName) {
            /** @type {?} */
            const storageState = deserialize(storage.getItem(key) || '{}');
            if (storageState[storeName]) {
                delete storageState[storeName];
                storage.setItem(key, serialize(storageState));
            }
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdC1zdGF0ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BkYXRvcmFtYS9ha2l0YS8iLCJzb3VyY2VzIjpbInNyYy9lbmhhbmNlcnMvcGVyc2lzdC1zdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxVQUFVLEVBQVcsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7O01BRW5ELEtBQUssR0FBRyxPQUFPLFlBQVksS0FBSyxXQUFXOzs7O0FBRWpELHdDQW1CQzs7Ozs7O0lBakJDLGlDQUFZOzs7OztJQUVaLHFDQUFpQjs7Ozs7SUFFakIseUNBQXNCOzs7OztJQUV0Qix1Q0FBb0I7Ozs7OztJQUtwQixxQ0FBa0I7Ozs7OztJQUtsQixxQ0FBa0I7Ozs7OztBQUdwQixNQUFNLFVBQVUsWUFBWSxDQUFDLE1BQW9DO0lBQy9ELElBQUksS0FBSztRQUFFLE9BQU87O1VBRVosUUFBUSxHQUF1QjtRQUNuQyxHQUFHLEVBQUUsYUFBYTtRQUNsQixPQUFPLEVBQUUsWUFBWTtRQUNyQixXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUs7UUFDdkIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1FBQ3pCLE9BQU8sRUFBRSxFQUFFO1FBQ1gsT0FBTyxFQUFFLEVBQUU7S0FDWjtVQUNLLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFD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U0FBUyxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ25DO2FBQU07WUFDTCxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUNyRSxTQUFTLENBQUMsZ0JBQWdCLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUMsQ0FBQztJQUVGLE9BQU87Ozs7UUFDTCxPQUFPO1lBQ0wsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQzNCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFOztzQkFDMUQsU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ3pCLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUNqQztZQUNELE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDZCxDQUFDOzs7O1FBQ0QsS0FBSztZQUNILE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNsQixDQUFDOzs7OztRQUNELFVBQVUsQ0FBQyxTQUFpQjs7a0JBQ3BCLFlBQVksR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUM7WUFFOUQsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQzNCLE9BQU8sWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMvQixPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQzthQUMvQztRQUNILENBQUM7S0FDRixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFraXRhRXJyb3IgfSBmcm9tICcuLi9pbnRlcm5hbC9lcnJvcic7XG5pbXBvcnQgeyBfX3N0b3Jlc19fLCBBY3Rpb25zLCByb290RGlzcGF0Y2hlciB9IGZyb20gJy4uL2FwaS9zdG9yZSc7XG5pbXBvcnQgeyBza2lwLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBnZXRWYWx1ZSwgc2V0VmFsdWUgfSBmcm9tICcuLi9pbnRlcm5hbC91dGlscyc7XG5pbXBvcnQgeyBfX2dsb2JhbFN0YXRlIH0gZnJvbSAnLi4vaW50ZXJuYWwvZ2xvYmFsLXN0YXRlJztcblxuY29uc3Qgbm90QnMgPSB0eXBlb2YgbG9jYWxTdG9yYWdlID09PSAndW5kZWZpbmVkJztcblxuZXhwb3J0IGludGVyZmFjZSBQZXJzaXN0U3RhdGVQYXJhbXMge1xuICAvKiogVGhlIHN0b3JhZ2Uga2V5ICovXG4gIGtleTogc3RyaW5nO1xuICAvKiogU3RvcmFnZSBzdHJhdGVneSB0byB1c2UuIFRoaXMgZGVmYXVsdHMgdG8gTG9jYWxTdG9yYWdlIGJ1dCB5b3UgY2FuIHBhc3MgU2Vzc2lvblN0b3JhZ2Ugb3IgYW55dGhpbmcgdGhhdCBpbXBsZW1lbnRzIHRoZSBTdG9yYWdlRW5naW5lIEFQSS4gKi9cbiAgc3RvcmFnZTogU3RvcmFnZTtcbiAgLyoqIEN1c3RvbSBkZXNlcmlhbGl6ZXIuIERlZmF1bHRzIHRvIEpTT04ucGFyc2UgKi9cbiAgZGVzZXJpYWxpemU6IEZ1bmN0aW9uO1xuICAvKiogQ3VzdG9tIHNlcmlhbGl6ZXIsIGRlZmF1bHRzIHRvIEpTT04uc3RyaW5naWZ5ICovXG4gIHNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKlxuICAgKiBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBpbmNsdWRlIG9ubHkgdGhlIHN0b3JlcyB5b3UgbmVlZC5cbiAgICogUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBpbmNsdWRlOiBzdHJpbmdbXTtcbiAgLyoqXG4gICAqICBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBleGNsdWRlIHN0b3JlcyB0aGF0IHlvdSBkb24ndCBuZWVkLlxuICAgKiAgUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBleGNsdWRlOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcnNpc3RTdGF0ZShwYXJhbXM/OiBQYXJ0aWFsPFBlcnNpc3RTdGF0ZVBhcmFtcz4pIHtcbiAgaWYgKG5vdEJzKSByZXR1cm47XG5cbiAgY29uc3QgZGVmYXVsdHM6IFBlcnNpc3RTdGF0ZVBhcmFtcyA9IHtcbiAgICBrZXk6ICdBa2l0YVN0b3JlcycsXG4gICAgc3RvcmFnZTogbG9jYWxTdG9yYWdlLFxuICAgIGRlc2VyaWFsaXplOiBKU09OLnBhcnNlLFxuICAgIHNlcmlhbGl6ZTogSlNPTi5zdHJpbmdpZnksXG4gICAgaW5jbHVkZTogW10sXG4gICAgZXhjbHVkZTogW11cbiAgfTtcbiAgY29uc3QgeyBzdG9yYWdlLCBkZXNlcmlhbGl6ZSwgc2VyaWFsaXplLCBpbmNsdWRlLCBleGNsdWRlLCBrZXkgfSA9IE9iamVjdC5hc3NpZ24oe30sIGRlZmF1bHRzLCBwYXJhbXMpO1xuXG4gIGNvbnN0IGhhc0luY2x1ZGUgPSBpbmNsdWRlLmxlbmd0aCA+IDA7XG4gIGNvbnN0IGhhc0V4Y2x1ZGUgPSBleGNsdWRlLmxlbmd0aCA+IDA7XG4gIGxldCBpbmNsdWRlU3RvcmVzO1xuXG4gIGlmIChoYXNJbmNsdWRlICYmIGhhc0V4Y2x1ZGUpIHtcbiAgICB0aHJvdyBuZXcgQWtpdGFFcnJvcihcIllvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXCIpO1xuICB9XG5cbiAgaWYgKGhhc0luY2x1ZGUpIHtcbiAgICBpbmNsdWRlU3RvcmVzID0gaW5jbHVkZS5yZWR1Y2UoKGFjYywgcGF0aCkgPT4ge1xuICAgICAgY29uc3Qgc3RvcmVOYW1lID0gcGF0aC5zcGxpdCgnLicpWzBdO1xuICAgICAgYWNjW3N0b3JlTmFtZV0gPSBwYXRoO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG4gIH1cblxuICBjb25zdCBzdG9yYWdlU3RhdGUgPSBkZXNlcmlhbGl6ZShzdG9yYWdlLmdldEl0ZW0oa2V5KSB8fCAne30nKTtcblxuICBsZXQgc3RvcmVzID0ge307XG4gIGxldCBhY2MgPSB7fTtcblxuICBmdW5jdGlvbiBzYXZlKCkge1xuICAgIHN0b3JhZ2Uuc2V0SXRlbShrZXksIHNlcmlhbGl6ZShPYmplY3QuYXNzaWduKHt9LCBzdG9yYWdlU3RhdGUsIGFjYykpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHN1YnNjcmliZShzdG9yZU5hbWUsIHBhdGgpIHtcbiAgICBzdG9yZXNbc3RvcmVOYW1lXSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXVxuICAgICAgLl9zZWxlY3Qoc3RhdGUgPT4gZ2V0VmFsdWUoc3RhdGUsIHBhdGgpKVxuICAgICAgLnBpcGUoc2tpcCgxKSlcbiAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgIGFjY1tzdG9yZU5hbWVdID0gZGF0YTtcbiAgICAgICAgc2F2ZSgpO1xuICAgICAgfSk7XG4gIH1cblxuICBmdW5jdGlvbiBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHBhdGgpIHtcbiAgICBpZiAoc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pIHtcbiAgICAgIF9fZ2xvYmFsU3RhdGUuc2V0QWN0aW9uKHsgdHlwZTogJ0BQZXJzaXN0U3RhdGUnIH0pO1xuICAgICAgc3RvcmUuc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgICByZXR1cm4gc2V0VmFsdWUoc3RhdGUsIHBhdGgsIHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdKTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHN0b3JlLnNldERpcnR5KSB7XG4gICAgICAgIHN0b3JlLnNldERpcnR5KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgc3Vic2NyaXB0aW9uID0gcm9vdERpc3BhdGNoZXIucGlwZShmaWx0ZXIoYWN0aW9uID0+IGFjdGlvbi50eXBlID09PSBBY3Rpb25zLk5FV19TVE9SRSkpLnN1YnNjcmliZShhY3Rpb24gPT4ge1xuICAgIGxldCBjdXJyZW50U3RvcmVOYW1lID0gYWN0aW9uLnBheWxvYWQuc3RvcmUuc3RvcmVOYW1lO1xuXG4gICAgaWYgKGhhc0V4Y2x1ZGUgJiYgZXhjbHVkZS5pbmNsdWRlcyhjdXJyZW50U3RvcmVOYW1lKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChoYXNJbmNsdWRlKSB7XG4gICAgICBjb25zdCBwYXRoID0gaW5jbHVkZVN0b3Jlc1tjdXJyZW50U3RvcmVOYW1lXTtcbiAgICAgIGlmICghcGF0aCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBzZXRJbml0aWFsKGN1cnJlbnRTdG9yZU5hbWUsIGFjdGlvbi5wYXlsb2FkLnN0b3JlLCBwYXRoKTtcbiAgICAgIHN1YnNjcmliZShjdXJyZW50U3RvcmVOYW1lLCBwYXRoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc2V0SW5pdGlhbChjdXJyZW50U3RvcmVOYW1lLCBhY3Rpb24ucGF5bG9hZC5zdG9yZSwgY3VycmVudFN0b3JlTmFtZSk7XG4gICAgICBzdWJzY3JpYmUoY3VycmVudFN0b3JlTmFtZSwgY3VycmVudFN0b3JlTmFtZSk7XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgIGZvciAobGV0IGkgPSAwLCBrZXlzID0gT2JqZWN0LmtleXMoc3RvcmVzKTsgaSA8IGtleXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3Qgc3RvcmVOYW1lID0ga2V5c1tpXTtcbiAgICAgICAgc3RvcmVzW3N0b3JlTmFtZV0udW5zdWJzY3JpYmUoKTtcbiAgICAgIH1cbiAgICAgIHN0b3JlcyA9IHt9O1xuICAgIH0sXG4gICAgY2xlYXIoKSB7XG4gICAgICBzdG9yYWdlLmNsZWFyKCk7XG4gICAgfSxcbiAgICBjbGVhclN0b3JlKHN0b3JlTmFtZTogc3RyaW5nKSB7XG4gICAgICBjb25zdCBzdG9yYWdlU3RhdGUgPSBkZXNlcmlhbGl6ZShzdG9yYWdlLmdldEl0ZW0oa2V5KSB8fCAne30nKTtcblxuICAgICAgaWYgKHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdKSB7XG4gICAgICAgIGRlbGV0ZSBzdG9yYWdlU3RhdGVbc3RvcmVOYW1lXTtcbiAgICAgICAgc3RvcmFnZS5zZXRJdGVtKGtleSwgc2VyaWFsaXplKHN0b3JhZ2VTdGF0ZSkpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cbiJdfQ==